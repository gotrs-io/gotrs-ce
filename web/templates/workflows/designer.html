{{template "layout" .}}

{{define "title"}}Workflow Designer{{end}}

{{define "content"}}
<div class="workflow-designer" x-data="workflowDesigner()">
    <!-- Header -->
    <div class="designer-header">
        <div class="flex items-center justify-between p-4 border-b">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-semibold">Workflow Designer</h1>
                <input type="text" 
                       x-model="workflow.name"
                       class="px-3 py-1 border rounded-md"
                       placeholder="Workflow Name">
                <select x-model="workflow.status" 
                        class="px-3 py-1 border rounded-md">
                    <option value="draft">Draft</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <button @click="testWorkflow()" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    <i class="fas fa-play mr-2"></i>Test
                </button>
                <button @click="saveWorkflow()" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
                <button @click="deployWorkflow()" 
                        :disabled="workflow.status !== 'active'"
                        class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:opacity-50">
                    <i class="fas fa-rocket mr-2"></i>Deploy
                </button>
            </div>
        </div>
    </div>

    <div class="designer-body flex h-screen">
        <!-- Left Panel: Component Palette -->
        <div class="w-64 bg-gray-50 border-r p-4 overflow-y-auto">
            <h3 class="font-semibold mb-4">Components</h3>
            
            <!-- Triggers -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Triggers</h4>
                <div class="space-y-2">
                    <template x-for="trigger in triggers" :key="trigger.type">
                        <div draggable="true"
                             @dragstart="dragStart($event, 'trigger', trigger)"
                             class="p-2 bg-white border rounded cursor-move hover:shadow-md transition-shadow">
                            <i :class="trigger.icon" class="mr-2"></i>
                            <span x-text="trigger.name"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Conditions -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Conditions</h4>
                <div class="space-y-2">
                    <template x-for="condition in conditions" :key="condition.type">
                        <div draggable="true"
                             @dragstart="dragStart($event, 'condition', condition)"
                             class="p-2 bg-white border rounded cursor-move hover:shadow-md transition-shadow">
                            <i :class="condition.icon" class="mr-2"></i>
                            <span x-text="condition.name"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Actions -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Actions</h4>
                <div class="space-y-2">
                    <template x-for="action in actions" :key="action.type">
                        <div draggable="true"
                             @dragstart="dragStart($event, 'action', action)"
                             class="p-2 bg-white border rounded cursor-move hover:shadow-md transition-shadow">
                            <i :class="action.icon" class="mr-2"></i>
                            <span x-text="action.name"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Center: Canvas -->
        <div class="flex-1 relative bg-gray-100">
            <div class="absolute inset-0 bg-grid-pattern opacity-5"></div>
            
            <div class="workflow-canvas p-8"
                 @drop="drop($event)"
                 @dragover.prevent>
                
                <!-- Start Node -->
                <div class="workflow-node start-node absolute"
                     style="top: 50px; left: 100px;">
                    <div class="node-content bg-green-500 text-white px-4 py-2 rounded-full">
                        <i class="fas fa-play"></i> Start
                    </div>
                    <div class="node-connector bottom"></div>
                </div>

                <!-- Workflow Components -->
                <template x-for="(component, index) in workflow.components" :key="component.id">
                    <div class="workflow-node absolute"
                         :style="`top: ${component.y}px; left: ${component.x}px;`"
                         @mousedown="startDrag($event, component)">
                        
                        <!-- Component Content -->
                        <div class="node-content bg-white border-2 rounded-lg shadow-lg p-4"
                             :class="{
                                 'border-blue-500': component.type === 'trigger',
                                 'border-yellow-500': component.type === 'condition',
                                 'border-green-500': component.type === 'action'
                             }"
                             @dblclick="editComponent(component)">
                            
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <i :class="component.icon" class="mr-2"></i>
                                    <span class="font-semibold" x-text="component.name"></span>
                                </div>
                                <button @click="removeComponent(component.id)"
                                        class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Component Details -->
                            <div class="text-sm text-gray-600">
                                <template x-if="component.type === 'trigger'">
                                    <div>
                                        <span class="font-medium">Event:</span>
                                        <span x-text="component.config.event"></span>
                                    </div>
                                </template>
                                
                                <template x-if="component.type === 'condition'">
                                    <div>
                                        <span class="font-medium">If:</span>
                                        <span x-text="component.config.expression"></span>
                                    </div>
                                </template>
                                
                                <template x-if="component.type === 'action'">
                                    <div>
                                        <span class="font-medium">Do:</span>
                                        <span x-text="component.config.description"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Connectors -->
                        <div class="node-connector top"></div>
                        <div class="node-connector bottom"></div>
                        
                        <!-- Condition Branches -->
                        <template x-if="component.type === 'condition'">
                            <div>
                                <div class="node-connector left">
                                    <span class="text-xs">Yes</span>
                                </div>
                                <div class="node-connector right">
                                    <span class="text-xs">No</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- End Node -->
                <div class="workflow-node end-node absolute"
                     style="bottom: 50px; left: 100px;">
                    <div class="node-connector top"></div>
                    <div class="node-content bg-red-500 text-white px-4 py-2 rounded-full">
                        <i class="fas fa-stop"></i> End
                    </div>
                </div>

                <!-- Connection Lines (SVG) -->
                <svg class="absolute inset-0 pointer-events-none">
                    <template x-for="connection in connections" :key="connection.id">
                        <path :d="connection.path"
                              stroke="#999"
                              stroke-width="2"
                              fill="none"
                              marker-end="url(#arrowhead)"/>
                    </template>
                    
                    <!-- Arrow marker -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#999"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </div>

        <!-- Right Panel: Properties -->
        <div class="w-96 bg-white border-l p-4 overflow-y-auto"
             x-show="selectedComponent">
            <h3 class="font-semibold mb-4">Properties</h3>
            
            <template x-if="selectedComponent">
                <div class="space-y-4">
                    <!-- Component Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Name
                        </label>
                        <input type="text"
                               x-model="selectedComponent.name"
                               class="w-full px-3 py-2 border rounded-md">
                    </div>

                    <!-- Component Description -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Description
                        </label>
                        <textarea x-model="selectedComponent.description"
                                  rows="3"
                                  class="w-full px-3 py-2 border rounded-md"></textarea>
                    </div>

                    <!-- Type-specific Properties -->
                    <div x-show="selectedComponent.type === 'trigger'">
                        <h4 class="font-medium mb-2">Trigger Settings</h4>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Event Type
                                </label>
                                <select x-model="selectedComponent.config.eventType"
                                        class="w-full px-3 py-2 border rounded-md">
                                    <option value="ticket_created">Ticket Created</option>
                                    <option value="ticket_updated">Ticket Updated</option>
                                    <option value="status_changed">Status Changed</option>
                                    <option value="priority_changed">Priority Changed</option>
                                    <option value="customer_reply">Customer Reply</option>
                                    <option value="scheduled">Scheduled</option>
                                </select>
                            </div>
                            
                            <div x-show="selectedComponent.config.eventType === 'scheduled'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Schedule (Cron Expression)
                                </label>
                                <input type="text"
                                       x-model="selectedComponent.config.schedule"
                                       placeholder="0 9 * * MON-FRI"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                        </div>
                    </div>

                    <div x-show="selectedComponent.type === 'condition'">
                        <h4 class="font-medium mb-2">Condition Settings</h4>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Field
                                </label>
                                <select x-model="selectedComponent.config.field"
                                        class="w-full px-3 py-2 border rounded-md">
                                    <option value="ticket.priority">Ticket Priority</option>
                                    <option value="ticket.status">Ticket Status</option>
                                    <option value="ticket.queue">Ticket Queue</option>
                                    <option value="customer.vip">Customer VIP</option>
                                    <option value="ticket.age_hours">Ticket Age (Hours)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Operator
                                </label>
                                <select x-model="selectedComponent.config.operator"
                                        class="w-full px-3 py-2 border rounded-md">
                                    <option value="equals">Equals</option>
                                    <option value="not_equals">Not Equals</option>
                                    <option value="contains">Contains</option>
                                    <option value="greater_than">Greater Than</option>
                                    <option value="less_than">Less Than</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Value
                                </label>
                                <input type="text"
                                       x-model="selectedComponent.config.value"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                        </div>
                    </div>

                    <div x-show="selectedComponent.type === 'action'">
                        <h4 class="font-medium mb-2">Action Settings</h4>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Action Type
                                </label>
                                <select x-model="selectedComponent.config.actionType"
                                        @change="updateActionFields()"
                                        class="w-full px-3 py-2 border rounded-md">
                                    <option value="assign_ticket">Assign Ticket</option>
                                    <option value="change_status">Change Status</option>
                                    <option value="change_priority">Change Priority</option>
                                    <option value="send_email">Send Email</option>
                                    <option value="add_note">Add Note</option>
                                    <option value="escalate">Escalate</option>
                                </select>
                            </div>
                            
                            <!-- Dynamic action fields based on type -->
                            <div x-show="selectedComponent.config.actionType === 'assign_ticket'">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Assign To
                                </label>
                                <select x-model="selectedComponent.config.assignTo"
                                        class="w-full px-3 py-2 border rounded-md">
                                    <option value="user:1">John Doe</option>
                                    <option value="group:1">Support Team</option>
                                    <option value="round_robin">Round Robin</option>
                                    <option value="least_loaded">Least Loaded</option>
                                </select>
                            </div>
                            
                            <div x-show="selectedComponent.config.actionType === 'send_email'">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Template
                                    </label>
                                    <select x-model="selectedComponent.config.template"
                                            class="w-full px-3 py-2 border rounded-md">
                                        <option value="acknowledgment">Acknowledgment</option>
                                        <option value="resolution">Resolution</option>
                                        <option value="escalation">Escalation Notice</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <div x-show="selectedComponent.config.template === 'custom'">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Email Content
                                    </label>
                                    <textarea x-model="selectedComponent.config.emailContent"
                                              rows="4"
                                              placeholder="Use {{variables}} for dynamic content"
                                              class="w-full px-3 py-2 border rounded-md"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="border-t pt-4">
                        <h4 class="font-medium mb-2">Advanced Settings</h4>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox"
                                           x-model="selectedComponent.config.continueOnError"
                                           class="mr-2">
                                    <span class="text-sm">Continue on Error</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Delay (seconds)
                                </label>
                                <input type="number"
                                       x-model="selectedComponent.config.delay"
                                       min="0"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Retry Count
                                </label>
                                <input type="number"
                                       x-model="selectedComponent.config.retryCount"
                                       min="0"
                                       max="5"
                                       class="w-full px-3 py-2 border rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Test Modal -->
    <div x-show="showTestModal"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-2/3 max-h-screen overflow-y-auto">
            <h2 class="text-xl font-semibold mb-4">Test Workflow</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Test Data
                </label>
                <textarea x-model="testData"
                          rows="10"
                          class="w-full px-3 py-2 border rounded-md font-mono text-sm"
                          placeholder='{"ticket_id": 123, "priority": "high", ...}'></textarea>
            </div>
            
            <div class="mb-4">
                <h3 class="font-medium mb-2">Execution Log</h3>
                <div class="bg-gray-100 p-4 rounded max-h-64 overflow-y-auto">
                    <template x-for="log in executionLog" :key="log.timestamp">
                        <div class="mb-2 text-sm"
                             :class="{
                                 'text-green-600': log.status === 'success',
                                 'text-red-600': log.status === 'error',
                                 'text-blue-600': log.status === 'info'
                             }">
                            <span class="font-mono" x-text="log.timestamp"></span>
                            <span class="ml-2" x-text="log.message"></span>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2">
                <button @click="runTest()"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Run Test
                </button>
                <button @click="showTestModal = false"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.workflow-canvas {
    min-height: 100%;
    position: relative;
}

.workflow-node {
    cursor: move;
    user-select: none;
}

.node-connector {
    position: absolute;
    width: 12px;
    height: 12px;
    background: white;
    border: 2px solid #999;
    border-radius: 50%;
    cursor: crosshair;
}

.node-connector.top {
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
}

.node-connector.bottom {
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
}

.node-connector.left {
    left: -6px;
    top: 50%;
    transform: translateY(-50%);
}

.node-connector.right {
    right: -6px;
    top: 50%;
    transform: translateY(-50%);
}

.bg-grid-pattern {
    background-image: 
        linear-gradient(0deg, transparent 24%, rgba(0, 0, 0, .05) 25%, rgba(0, 0, 0, .05) 26%, transparent 27%, transparent 74%, rgba(0, 0, 0, .05) 75%, rgba(0, 0, 0, .05) 76%, transparent 77%, transparent),
        linear-gradient(90deg, transparent 24%, rgba(0, 0, 0, .05) 25%, rgba(0, 0, 0, .05) 26%, transparent 27%, transparent 74%, rgba(0, 0, 0, .05) 75%, rgba(0, 0, 0, .05) 76%, transparent 77%, transparent);
    background-size: 50px 50px;
}
</style>

<script>
function workflowDesigner() {
    return {
        workflow: {
            id: null,
            name: 'New Workflow',
            description: '',
            status: 'draft',
            components: [],
            connections: []
        },
        
        selectedComponent: null,
        draggedComponent: null,
        showTestModal: false,
        testData: '{}',
        executionLog: [],
        
        // Component Templates
        triggers: [
            { type: 'ticket_created', name: 'Ticket Created', icon: 'fas fa-plus-circle' },
            { type: 'ticket_updated', name: 'Ticket Updated', icon: 'fas fa-edit' },
            { type: 'status_changed', name: 'Status Changed', icon: 'fas fa-exchange-alt' },
            { type: 'priority_changed', name: 'Priority Changed', icon: 'fas fa-exclamation-triangle' },
            { type: 'customer_reply', name: 'Customer Reply', icon: 'fas fa-comment' },
            { type: 'scheduled', name: 'Scheduled', icon: 'fas fa-clock' }
        ],
        
        conditions: [
            { type: 'field_check', name: 'Field Check', icon: 'fas fa-question-circle' },
            { type: 'time_check', name: 'Time Check', icon: 'fas fa-hourglass' },
            { type: 'user_check', name: 'User Check', icon: 'fas fa-user-check' },
            { type: 'custom', name: 'Custom Condition', icon: 'fas fa-code' }
        ],
        
        actions: [
            { type: 'assign_ticket', name: 'Assign Ticket', icon: 'fas fa-user-plus' },
            { type: 'change_status', name: 'Change Status', icon: 'fas fa-tasks' },
            { type: 'change_priority', name: 'Change Priority', icon: 'fas fa-flag' },
            { type: 'send_email', name: 'Send Email', icon: 'fas fa-envelope' },
            { type: 'send_notification', name: 'Send Notification', icon: 'fas fa-bell' },
            { type: 'add_note', name: 'Add Note', icon: 'fas fa-sticky-note' },
            { type: 'escalate', name: 'Escalate', icon: 'fas fa-level-up-alt' },
            { type: 'webhook', name: 'Webhook Call', icon: 'fas fa-globe' }
        ],
        
        connections: [],
        
        dragStart(event, type, template) {
            this.draggedComponent = {
                type: type,
                template: template
            };
        },
        
        drop(event) {
            if (!this.draggedComponent) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const component = {
                id: Date.now(),
                type: this.draggedComponent.type,
                name: this.draggedComponent.template.name,
                icon: this.draggedComponent.template.icon,
                x: x - 100,
                y: y - 50,
                config: this.getDefaultConfig(this.draggedComponent.type)
            };
            
            this.workflow.components.push(component);
            this.draggedComponent = null;
        },
        
        getDefaultConfig(type) {
            switch(type) {
                case 'trigger':
                    return {
                        eventType: 'ticket_created',
                        filters: []
                    };
                case 'condition':
                    return {
                        field: 'ticket.priority',
                        operator: 'equals',
                        value: '',
                        expression: 'priority = high'
                    };
                case 'action':
                    return {
                        actionType: 'assign_ticket',
                        description: 'Assign to support team',
                        continueOnError: false,
                        delay: 0,
                        retryCount: 0
                    };
                default:
                    return {};
            }
        },
        
        startDrag(event, component) {
            this.selectedComponent = component;
            const startX = event.clientX;
            const startY = event.clientY;
            const origX = component.x;
            const origY = component.y;
            
            const handleMouseMove = (e) => {
                component.x = origX + (e.clientX - startX);
                component.y = origY + (e.clientY - startY);
                this.updateConnections();
            };
            
            const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        },
        
        editComponent(component) {
            this.selectedComponent = component;
        },
        
        removeComponent(id) {
            this.workflow.components = this.workflow.components.filter(c => c.id !== id);
            this.connections = this.connections.filter(c => c.from !== id && c.to !== id);
            if (this.selectedComponent?.id === id) {
                this.selectedComponent = null;
            }
        },
        
        updateConnections() {
            // Update connection paths when nodes move
            // This would calculate SVG paths between connected nodes
        },
        
        testWorkflow() {
            this.showTestModal = true;
            this.executionLog = [];
        },
        
        runTest() {
            this.executionLog = [];
            
            try {
                const data = JSON.parse(this.testData);
                
                this.addLog('info', 'Starting workflow test...');
                
                // Simulate workflow execution
                this.workflow.components.forEach((component, index) => {
                    setTimeout(() => {
                        this.addLog('success', `Executing ${component.name}`);
                        
                        if (component.type === 'condition') {
                            this.addLog('info', `Evaluating condition: ${component.config.expression}`);
                        } else if (component.type === 'action') {
                            this.addLog('success', `Action completed: ${component.config.description}`);
                        }
                    }, index * 500);
                });
                
                setTimeout(() => {
                    this.addLog('success', 'Workflow test completed successfully');
                }, this.workflow.components.length * 500 + 500);
                
            } catch (error) {
                this.addLog('error', `Invalid test data: ${error.message}`);
            }
        },
        
        addLog(status, message) {
            this.executionLog.push({
                timestamp: new Date().toLocaleTimeString(),
                status: status,
                message: message
            });
        },
        
        saveWorkflow() {
            // Save workflow via API
            fetch('/api/v1/workflows', {
                method: this.workflow.id ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(this.workflow)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.workflow.id = data.data.id;
                    alert('Workflow saved successfully');
                } else {
                    alert('Error saving workflow: ' + data.error);
                }
            });
        },
        
        deployWorkflow() {
            if (this.workflow.status !== 'active') {
                alert('Only active workflows can be deployed');
                return;
            }
            
            fetch(`/api/v1/workflows/${this.workflow.id}/deploy`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Workflow deployed successfully');
                } else {
                    alert('Error deploying workflow: ' + data.error);
                }
            });
        },
        
        updateActionFields() {
            // Update available fields based on selected action type
            // This would dynamically show/hide relevant configuration options
        },
        
        init() {
            // Load workflow if editing existing
            const urlParams = new URLSearchParams(window.location.search);
            const workflowId = urlParams.get('id');
            
            if (workflowId) {
                fetch(`/api/v1/workflows/${workflowId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.workflow = data.data;
                        }
                    });
            }
        }
    }
}
</script>
{{end}}