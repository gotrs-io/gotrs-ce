{{define "list.html"}}
{{template "base.html" .}}
{{end}}

{{define "title"}}Queues - GOTRS{{end}}

{{define "content"}}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 dark:text-white sm:truncate sm:text-3xl sm:tracking-tight">
                Queue Management
            </h2>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Manage ticket queues and routing rules
            </p>
        </div>
        <div class="mt-4 flex md:ml-4 md:mt-0">
            <button type="button" 
                    hx-get="/queues/new"
                    hx-target="body"
                    hx-swap="beforeend"
                    class="inline-flex items-center rounded-md bg-gotrs-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gotrs-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gotrs-600">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                New Queue
            </button>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="bg-white dark:bg-gray-800 shadow sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <div class="md:grid md:grid-cols-3 md:gap-6">
                <div class="md:col-span-1">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">Search & Filter</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Find queues by name or description
                    </p>
                </div>
                <div class="mt-5 md:mt-0 md:col-span-2">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Search Input -->
                        <div>
                            <label for="search" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <input type="text" 
                                       name="search" 
                                       id="search"
                                       value="{{.SearchTerm}}"
                                       placeholder="Search queues..."
                                       hx-get="/queues"
                                       hx-trigger="input changed delay:300ms"
                                       hx-target="#queue-list-container"
                                       hx-swap="innerHTML"
                                       hx-include="[name='status']"
                                       class="focus:ring-gotrs-500 focus:border-gotrs-500 block w-full pr-10 sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Status Filter -->
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                            <div class="mt-1">
                                <select name="status" 
                                        id="status"
                                        hx-get="/queues"
                                        hx-trigger="change"
                                        hx-target="#queue-list-container"
                                        hx-swap="innerHTML"
                                        hx-include="[name='search']"
                                        class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 sm:text-sm rounded-md dark:bg-gray-700 dark:text-white">
                                    <option value="all" {{if eq .StatusFilter "all"}}selected{{end}}>All Statuses</option>
                                    <option value="active" {{if eq .StatusFilter "active"}}selected{{end}}>Active</option>
                                    <option value="inactive" {{if eq .StatusFilter "inactive"}}selected{{end}}>Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sort Dropdown -->
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 mt-4">
                        <div>
                            <label for="queue-sort" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sort by</label>
                            <div class="mt-1">
                                <select name="sort" 
                                        id="queue-sort"
                                        hx-get="/queues"
                                        hx-trigger="change"
                                        hx-target="#queue-list-container"
                                        hx-swap="innerHTML"
                                        hx-include="[name='search'],[name='status'],[name='per_page']"
                                        class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 sm:text-sm rounded-md dark:bg-gray-700 dark:text-white">
                                    <option value="" {{if not .SortBy}}selected{{end}}>Default</option>
                                    <option value="name_asc" {{if eq .SortBy "name_asc"}}selected{{end}}>Name (A-Z)</option>
                                    <option value="name_desc" {{if eq .SortBy "name_desc"}}selected{{end}}>Name (Z-A)</option>
                                    <option value="tickets_asc" {{if eq .SortBy "tickets_asc"}}selected{{end}}>Tickets (Low to High)</option>
                                    <option value="tickets_desc" {{if eq .SortBy "tickets_desc"}}selected{{end}}>Tickets (High to Low)</option>
                                    <option value="status_asc" {{if eq .SortBy "status_asc"}}selected{{end}}>Status</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Items Per Page -->
                        <div>
                            <label for="per_page" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Items per page</label>
                            <div class="mt-1">
                                <select name="per_page" 
                                        id="per_page"
                                        hx-get="/queues"
                                        hx-trigger="change"
                                        hx-target="#queue-list-container"
                                        hx-swap="innerHTML"
                                        hx-include="[name='search'],[name='status'],[name='sort']"
                                        class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 sm:text-sm rounded-md dark:bg-gray-700 dark:text-white">
                                    <option value="10" {{if eq .PerPage 10}}selected{{end}}>10</option>
                                    <option value="25" {{if eq .PerPage 25}}selected{{end}}>25</option>
                                    <option value="50" {{if eq .PerPage 50}}selected{{end}}>50</option>
                                    <option value="100" {{if eq .PerPage 100}}selected{{end}}>100</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Button -->
                    <div class="mt-4">
                        <button type="button"
                                hx-get="/queues/clear-search"
                                hx-target="#queue-list-container"
                                hx-swap="innerHTML"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gotrs-500">
                            <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk actions toolbar (hidden by default) -->
    <div id="bulk-actions-toolbar" style="display: none"></div>

    <!-- Queues list -->
    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-md" id="queue-list-container">
        {{template "queue_list.html" .}}
    </div>
</div>

<!-- JavaScript for bulk operations -->
<script>
    function selectAllQueues(checked) {
        const checkboxes = document.querySelectorAll('input[name="queue-select"]');
        checkboxes.forEach(cb => cb.checked = checked);
        updateBulkToolbar();
    }
    
    function updateBulkToolbar() {
        const checkboxes = document.querySelectorAll('input[name="queue-select"]:checked');
        const count = checkboxes.length;
        const toolbar = document.getElementById('bulk-actions-toolbar');
        
        if (count > 0) {
            // Show toolbar with count
            htmx.ajax('GET', '/queues/bulk-toolbar?count=' + count, {
                target: '#bulk-actions-toolbar',
                swap: 'outerHTML'
            });
            toolbar.style.display = 'block';
        } else {
            // Hide toolbar
            toolbar.style.display = 'none';
            toolbar.innerHTML = '';
        }
        
        // Update select-all checkbox state
        const selectAll = document.getElementById('select-all-queues');
        const allCheckboxes = document.querySelectorAll('input[name="queue-select"]');
        if (selectAll) {
            selectAll.checked = count > 0 && count === allCheckboxes.length;
            selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
        }
    }
    
    function cancelBulkSelection() {
        const checkboxes = document.querySelectorAll('input[name="queue-select"]');
        checkboxes.forEach(cb => cb.checked = false);
        const selectAll = document.getElementById('select-all-queues');
        if (selectAll) selectAll.checked = false;
        updateBulkToolbar();
    }
    
    // Add event listeners on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Add listeners to all queue checkboxes
        const checkboxes = document.querySelectorAll('input[name="queue-select"]');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateBulkToolbar);
        });
    });
    
    // Re-initialize after HTMX updates
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'queue-list-container') {
            const checkboxes = document.querySelectorAll('input[name="queue-select"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateBulkToolbar);
            });
        }
    });
</script>
{{end}}