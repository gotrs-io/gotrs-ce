<!DOCTYPE html>
<html lang="{{ getLang() }}" dir="{{ getDirection() }}" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ t("app.title") }}{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    
    <!-- Dark mode detection script (must be inline to avoid flash) -->
    <script>
        // Set dark mode class before Tailwind loads to prevent flash
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    
    <!-- Tailwind CSS (production build) -->
    <link rel="stylesheet" href="/static/css/output.css">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- HTMX for dynamic updates -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- HTMX extensions -->
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    
    <!-- Common utilities -->
    <script src="/static/js/common.js"></script>
    <!-- GoatKit typeahead enhancement -->
    <script src="/static/js/goatkit-typeahead.js"></script>
    <script src="/static/js/goatkit-autocomplete.js"></script>
    <script src="/static/js/goatkit-validate.js"></script>
        <!-- Validation i18n (only current language) -->
        <script id="gk-validation-msgs" type="application/json">{
            "lang": "{{ getLang()|default:"en" }}",
            "messages": {
                "validation.required": "{field} {{ t("validation.required_suffix")|default:"is required" }}",
                "validation.minlength": "{field} {{ t("validation.minlength_suffix")|default:"must be at least {min} characters" }}",
                "validation.pattern": "{field} {{ t("validation.pattern_suffix")|default:"has invalid format" }}",
                "validation.filesize": "{file} {{ t("validation.filesize_suffix")|default:"exceeds maximum size {size}MB" }}",
                "validation.summary": "{{ t("validation.summary_title")|default:"Please correct the following:" }}"
            }
        }</script>
    
    <!-- Custom styles -->
    <style>
        /* Smooth transitions for dark mode */
        * {
            transition: background-color 0.2s, border-color 0.2s;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-3 py-2 rounded-md">{{ t("common.skip_to_content")|default:"Skip to content" }}</a>
    <div class="min-h-full">
    {% set isAdmin = ActivePage and ActivePage|lower == "admin" %}
    {% set isCustomer = User and User.Role and User.Role|lower == "customer" %}
    {% if not isAdmin and not isCustomer and (Portal or PortalConfig) %}
        {% set isCustomer = true %}
    {% endif %}
    {% if not isAdmin and not isCustomer and ActivePage and ActivePage|lower|slice:"0:8" == "customer" %}
        {% set isCustomer = true %}
    {% endif %}

    {% set navDashboard = t("navigation.dashboard") %}
    {% if not navDashboard or navDashboard == "navigation.dashboard" %}
        {% set navDashboard = "Dashboard" %}
    {% endif %}
    {% set navTickets = t("navigation.tickets") %}
    {% if not navTickets or navTickets == "navigation.tickets" %}
        {% set navTickets = "Tickets" %}
    {% endif %}
    {% set navQueues = t("navigation.queues") %}
    {% if not navQueues or navQueues == "navigation.queues" %}
        {% set navQueues = "Queues" %}
    {% endif %}
    {% set navAdmin = t("navigation.admin") %}
    {% if not navAdmin or navAdmin == "navigation.admin" %}
        {% set navAdmin = "Admin" %}
    {% endif %}
    {% set navDev = t("navigation.dev") %}
    {% if not navDev or navDev == "navigation.dev" %}
        {% set navDev = "Dev" %}
    {% endif %}

    {% set dashboardHref = "/dashboard" %}
    {% set ticketsHref = "/tickets" %}
    {% set queuesHref = "/queues" %}
    {% set profileHref = "/profile" %}
    {% set settingsHref = "/settings" %}
    {% set logoutHref = "/logout" %}
    {% if isCustomer %}
        {% set dashboardHref = "/customer" %}
        {% set ticketsHref = "/customer/tickets" %}
        {% set profileHref = "/customer/profile" %}
        {% set settingsHref = "/customer/profile" %}
        {% set logoutHref = "/customer/logout" %}
    {% endif %}

    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm" role="navigation" aria-label="Main navigation" x-data="{ mobileMenuOpen: false }">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 justify-between">
                    <div class="flex">
                        <div class="flex flex-shrink-0 items-center">
                            <img src="/static/favicon.svg" alt="GOTRS Logo" class="h-8 w-8 mr-2">
                            <span class="text-2xl font-bold text-gotrs-600 dark:text-gotrs-400">GOTRS</span>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="{{ dashboardHref }}" class="{% if ActivePage == 'dashboard' %}border-gotrs-500 text-gray-900 dark:text-white{% else %}border-transparent text-gray-500 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200{% endif %} inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                                {{ navDashboard }}
                            </a>
                            <a href="{{ ticketsHref }}" class="{% if ActivePage == 'tickets' %}border-gotrs-500 text-gray-900 dark:text-white{% else %}border-transparent text-gray-500 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200{% endif %} inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                                {{ navTickets }}
                            </a>
                            {% if not isCustomer %}
                            <a href="{{ queuesHref }}" rel="nofollow" class="{% if ActivePage == 'queues' %}border-gotrs-500 text-gray-900 dark:text-white{% else %}border-transparent text-gray-500 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200{% endif %} inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                                {{ navQueues }}
                            </a>
                            {% endif %}
                            {% if not isCustomer and (User and (User.Role == "Admin" or User.IsInAdminGroup or IsInAdminGroup)) %}
                            <a href="/admin" class="{% if ActivePage == 'admin' %}border-gotrs-500 text-gray-900 dark:text-white{% else %}border-transparent text-gray-500 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200{% endif %} inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                                {{ navAdmin }}
                            </a>
                            {% endif %}
                            {% if not isCustomer and (IsInAdminGroup or (User and (User.IsInAdminGroup or User.Role == "Admin"))) %}
                            <a href="/dev" class="{% if ActivePage == 'dev' %}border-gotrs-500 text-gray-900 dark:text-white{% else %}border-transparent text-gray-500 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200{% endif %} inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                                {{ navDev }}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:items-center">
                        <!-- Dark mode toggle -->
                        <button type="button" onclick="toggleDarkMode()" class="rounded-md p-1 text-gray-400 hover:text-gray-500 dark:text-gray-300 dark:hover:text-gray-200">
                            <i class="fas fa-moon icon-md"></i>
                        </button>
                        
                        <!-- User menu -->
                        <div class="relative ml-3" x-data="{ open: false }">
                            <button @click="open = !open" type="button" class="flex rounded-full bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-gotrs-500 focus:ring-offset-2">
                                <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-gray-500">
                                    <span class="text-sm font-medium leading-none text-white">
                                        {% if User and (User.FirstName or User.LastName) %}
                                            {{ User.FirstName|default:""|slice:"0:1"|upper }}{{ User.LastName|default:""|slice:"0:1"|upper }}
                                        {% else %}DU{% endif %}
                                    </span>
                                </span>
                            </button>
                            <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white dark:bg-gray-800 py-1 shadow-lg ring-1 ring-black ring-opacity-5">
                                <a href="{{ profileHref }}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">{{ t("navigation.profile") }}</a>
                                <a href="{{ settingsHref }}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">{{ t("navigation.settings") }}</a>
                                <hr class="my-1 border-gray-200 dark:border-gray-700">
                                <a href="{{ logoutHref }}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">{{ t("auth.logout") }}</a>
                            </div>
                        </div>
                    </div>
                    <div class="-mr-2 flex items-center sm:hidden">
                        <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-gotrs-500" aria-label="Toggle navigation">
                            <svg x-show="!mobileMenuOpen" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg>
                            <svg x-show="mobileMenuOpen" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div x-show="mobileMenuOpen" class="sm:hidden" x-transition>
                    <div class="space-y-1 pb-3 pt-2">
                            <a href="{{ dashboardHref }}" class="block border-l-4 px-3 py-2 text-base font-medium {% if ActivePage == 'dashboard' %}bg-gray-100 border-gotrs-500 text-gray-900 dark:bg-gray-900 dark:text-white{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 dark:text-gray-300 dark:hover:text-white{% endif %}">
                                {{ navDashboard }}
                            </a>
                            <a href="{{ ticketsHref }}" class="block border-l-4 px-3 py-2 text-base font-medium {% if ActivePage == 'tickets' %}bg-gray-100 border-gotrs-500 text-gray-900 dark:bg-gray-900 dark:text-white{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 dark:text-gray-300 dark:hover:text-white{% endif %}">
                                {{ navTickets }}
                            </a>
                            {% if not isCustomer %}
                            <a href="{{ queuesHref }}" class="block border-l-4 px-3 py-2 text-base font-medium {% if ActivePage == 'queues' %}bg-gray-100 border-gotrs-500 text-gray-900 dark:bg-gray-900 dark:text-white{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 dark:text-gray-300 dark:hover:text-white{% endif %}">
                                {{ navQueues }}
                            </a>
                            {% endif %}
                        {% if not isCustomer and (User and (User.Role == "Admin" or User.IsInAdminGroup or IsInAdminGroup)) %}
                        <a href="/admin" class="block border-l-4 px-3 py-2 text-base font-medium {% if ActivePage == 'admin' %}bg-gray-100 border-gotrs-500 text-gray-900 dark:bg-gray-900 dark:text-white{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 dark:text-gray-300 dark:hover:text-white{% endif %}">
                                    {{ navAdmin }}
                        </a>
                        {% endif %}
                        {% if not isCustomer and (IsInAdminGroup or (User and (User.IsInAdminGroup or User.Role == "Admin"))) %}
                        <a href="/dev" class="block border-l-4 px-3 py-2 text-base font-medium {% if ActivePage == 'dev' %}bg-gray-100 border-gotrs-500 text-gray-900 dark:bg-gray-900 dark:text-white{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 dark:text-gray-300 dark:hover:text-white{% endif %}">
                                    {{ navDev }}
                        </a>
                        {% endif %}
                    </div>
                    {% if User %}
                    <div class="border-t border-gray-200 dark:border-gray-700 pb-3 pt-4">
                        <div class="flex items-center px-4">
                            <div class="flex-shrink-0">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-gray-500">
                                    <span class="text-sm font-medium leading-none text-white">
                                        {% if User.FirstName or User.LastName %}
                                            {{ User.FirstName|default:""|slice:"0:1"|upper }}{{ User.LastName|default:""|slice:"0:1"|upper }}
                                        {% else %}DU{% endif %}
                                    </span>
                                </span>
                            </div>
                            <div class="ml-3">
                                <div class="text-base font-medium text-gray-800 dark:text-gray-200">{{ User.FullName|default:User.Email|default:"Demo User" }}</div>
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ User.Email|default:"demo@example.com" }}</div>
                            </div>
                        </div>
                        <div class="mt-3 space-y-1">
                            <a href="{{ profileHref }}" class="block px-4 py-2 text-base font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white">{{ t("navigation.profile") }}</a>
                            <a href="{{ settingsHref }}" class="block px-4 py-2 text-base font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white">{{ t("navigation.settings") }}</a>
                            <a href="{{ logoutHref }}" class="block px-4 py-2 text-base font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white">{{ t("auth.logout") }}</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main id="main-content" role="main">
            {% block content %}{% endblock %}
        </main>

        {% if Portal and Portal.FooterText %}
        <footer class="mt-10 border-t border-gray-200 dark:border-gray-700 py-6 text-center text-sm text-gray-500 dark:text-gray-400">
            {{ Portal.FooterText }}
        </footer>
        {% endif %}
    </div>

    <!-- Toast container for notifications -->
    <div id="toast-container" class="fixed bottom-0 right-0 p-6 space-y-4 z-50"></div>

    <!-- Include Guru Meditation component for error handling -->
    {% include "components/guru_meditation.pongo2" %}

    <!-- Dark mode toggle and lightweight helpers -->
    <script>
        function toggleDarkMode() {
            const root = document.documentElement
            const enableDark = !root.classList.contains('dark')
            root.classList.toggle('dark', enableDark)
            localStorage.theme = enableDark ? 'dark' : 'light'
        }

        document.addEventListener('htmx:responseError', function (event) {
            console.error('HTMX response error', event.detail)
        })

        document.addEventListener('DOMContentLoaded', function () {
            const groupsTable = document.getElementById('groupsTable')
            if (!groupsTable) {
                return
            }

            const labels = {
                'admin.group_name': 'Group Name',
                'admin.description': 'Description',
                'admin.members': 'Members',
                'admin.created': 'Created',
                'admin.add_group': 'Add Group',
                'admin.actions': 'Actions'
            }
            const nodes = document.querySelectorAll('th, label, span, div, a, button')
            nodes.forEach(function (node) {
                const html = node.innerHTML
                if (!html) {
                    return
                }
                let updated = html
                Object.keys(labels).forEach(function (key) {
                    if (updated.indexOf(key) !== -1) {
                        updated = updated.replaceAll(key, labels[key])
                    }
                })
                if (updated !== html) {
                    node.innerHTML = updated
                }
            })

            const addGroup = Array.from(document.querySelectorAll('button')).find(function (btn) {
                return /Add Group/i.test(btn.textContent || '')
            })
            if (addGroup) {
                addGroup.addEventListener('click', function (event) {
                    event.preventDefault()
                    const modal = document.getElementById('groupModal')
                    if (modal) {
                        modal.classList.remove('hidden')
                    }
                })
            }

            const searchInput = document.getElementById('groupSearch')
            const clearBtn = document.getElementById('clearSearchBtn')
            if (searchInput && clearBtn) {
                const toggle = function () {
                    clearBtn.style.display = searchInput.value ? 'block' : 'none'
                }
                searchInput.addEventListener('input', toggle)
                toggle()
            }
        })
    </script>
    
    {% block scripts %}{% endblock %}
    
    <!-- Claude Code Chat Assistant -->
    <script src="/static/js/claude-chat.js"></script>
    {% block script %}{% endblock %}
</body>
</html>