{% extends "layouts/base.pongo2" %}

{% block title %}{{ t("agent.ticket.zoom.title") }} #{{ ticket.tn }} - {{ ticket.title }}{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4">
    <!-- Breadcrumb -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/agent/dashboard" class="text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white">
                    <i class="fas fa-home mr-2"></i>{{ t("navigation.dashboard") }}
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="/agent/tickets" class="text-gray-700 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white">
                        {{ t("navigation.tickets") }}
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500 dark:text-gray-400">#{{ ticket.tn }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Ticket Header -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-4">
        <div class="px-4 py-3 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                        {{ ticket.title }}
                    </h1>
                    <div class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        <span class="mr-4">{{ t("tickets.ticket_number") }}: #{{ ticket.tn }}</span>
                        <span class="mr-4">{{ t("tickets.created_at") }}: {{ ticket.create_time }}</span>
                        <span>{{ t("tickets.updated_at") }}: {{ ticket.change_time }}</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Ticket State Badge -->
                    <span class="px-3 py-1 text-xs font-medium rounded-full
                        {% if ticket.state_type == 'open' %}
                            bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                        {% elif ticket.state_type == 'closed' %}
                            bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300
                        {% elif ticket.state_type == 'pending' %}
                            bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                        {% else %}
                            bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                        {% endif %}">
                        {{ ticket.state_name|default:t("status.open") }}
                    </span>
                    <!-- Priority Badge -->
                    <span class="px-3 py-1 text-xs font-medium rounded-full
                        {% if ticket.priority_name == '5 very high' or ticket.priority_name == '4 high' %}
                            bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                        {% elif ticket.priority_name == '3 normal' %}
                            bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                        {% else %}
                            bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300
                        {% endif %}">
                        <i class="fas fa-flag mr-1"></i>{{ ticket.priority_name|default:t("priority.normal") }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Action Bar - FIXED FUNCTION CALLS -->
        <div class="px-4 py-3 sm:px-6 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
            <div class="flex flex-wrap gap-2">
                <!-- Primary Actions - FIXED TO MATCH JAVASCRIPT FUNCTIONS -->
                <button onclick="replyToTicket()" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                    <i class="fas fa-reply mr-1"></i>{{ t("tickets.reply") }}
                </button>
                <button onclick="replyToTicket()" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                    <i class="fas fa-reply-all mr-1"></i>{{ t("tickets.reply_all") }}
                </button>
                <button onclick="replyToTicket()" class="px-3 py-1.5 bg-gray-600 text-white text-sm rounded hover:bg-gray-700">
                    <i class="fas fa-forward mr-1"></i>{{ t("tickets.forward") }}
                </button>
                <button onclick="replyToTicket()" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                    <i class="fas fa-phone mr-1"></i>{{ t("tickets.phone") }}
                </button>
                <button onclick="addNote({{ ticket.id }})" class="px-3 py-1.5 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700">
                    <i class="fas fa-sticky-note mr-1"></i>{{ t("tickets.note") }}
                </button>
                
                <!-- Ticket Actions Dropdown -->
                <div class="relative inline-block text-left">
                    <button onclick="toggleDropdown('ticketActionsDropdown')" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded hover:bg-gray-300 dark:hover:bg-gray-500">
                        <i class="fas fa-cog mr-1"></i>{{ t("tickets.actions") }}
                        <i class="fas fa-chevron-down ml-1"></i>
                    </button>
                    <div id="ticketActionsDropdown" class="hidden absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5">
                        <div class="py-1">
                            <a href="#" onclick="assignAgent()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-user mr-2"></i>{{ t("tickets.owner") }}
                            </a>
                            <a href="#" onclick="assignAgent()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-user-check mr-2"></i>{{ t("tickets.responsible") }}
                            </a>
                            <a href="#" onclick="assignAgent()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-user-tie mr-2"></i>{{ t("tickets.customer") }}
                            </a>
                            <hr class="my-1 border-gray-200 dark:border-gray-600">
                            <a href="#" onclick="changePriority()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-flag mr-2"></i>{{ t("tickets.priority") }}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-tasks mr-2"></i>{{ t("tickets.state") }}
                            </a>
                            <a href="#" onclick="moveQueue()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-inbox mr-2"></i>{{ t("tickets.queue") }}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-tag mr-2"></i>{{ t("tickets.type") }}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-cogs mr-2"></i>{{ t("tickets.service") }}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-clock mr-2"></i>{{ t("tickets.sla") }}
                            </a>
                            <hr class="my-1 border-gray-200 dark:border-gray-600">
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-{% if ticket.lock_id == 2 %}unlock{% else %}lock{% endif %} mr-2"></i>
                                {% if ticket.lock_id == 2 %}{{ t("tickets.unlock") }}{% else %}{{ t("tickets.lock") }}{% endif %}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-history mr-2"></i>{{ t("tickets.history") }}
                            </a>
                            <a href="#" onclick="window.print()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-print mr-2"></i>{{ t("tickets.print") }}
                            </a>
                            <hr class="my-1 border-gray-200 dark:border-gray-600">
                            <a href="#" onclick="mergeTicket()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-code-branch mr-2"></i>{{ t("tickets.merge") }}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-link mr-2"></i>{{ t("tickets.link") }}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Miscellaneous Actions -->
                <div class="relative inline-block text-left">
                    <button onclick="toggleDropdown('miscActionsDropdown')" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-sm rounded hover:bg-gray-300 dark:hover:bg-gray-500">
                        <i class="fas fa-ellipsis-h mr-1"></i>{{ t("tickets.miscellaneous") }}
                        <i class="fas fa-chevron-down ml-1"></i>
                    </button>
                    <div id="miscActionsDropdown" class="hidden absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5">
                        <div class="py-1">
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-eye mr-2"></i>{{ t("tickets.watch") }}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-layer-group mr-2"></i>{{ t("tickets.bulk") }}
                            </a>
                            <a href="#" onclick="changeStatus()" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-ban mr-2"></i>{{ t("tickets.spam") }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Left Column: Articles/Messages -->
        <div class="lg:col-span-2">
            <!-- Articles -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                <div class="px-4 py-3 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                        Articles
                    </h2>
                </div>
                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for article in articles %}
                    <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-gray-400 flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                            </div>
                            <div class="ml-3 flex-1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="text-sm font-medium text-gray-900 dark:text-white">
                                            {{ article.from }}
                                        </span>
                                        {% if article.sender_type_id == 1 %}
                                            <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded">
                                                Customer
                                            </span>
                                        {% elif article.sender_type_id == 2 %}
                                            <span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded">
                                                Agent
                                            </span>
                                        {% elif article.sender_type_id == 3 %}
                                            <span class="ml-2 px-2 py-1 text-xs bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded">
                                                System
                                            </span>
                                        {% endif %}
                                    </div>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">
                                        {{ article.create_time }}
                                    </span>
                                </div>
                                {% if article.to %}
                                <div class="mt-1 text-sm text-gray-600 dark:text-gray-300">
                                    <strong>To:</strong> {{ article.to }}
                                </div>
                                {% endif %}
                                {% if article.subject %}
                                <div class="mt-1 text-sm text-gray-600 dark:text-gray-300">
                                    <strong>Subject:</strong> {{ article.subject }}
                                </div>
                                {% endif %}
                                <div class="mt-2 text-sm text-gray-900 dark:text-white whitespace-pre-wrap">
                                    {{ article.body|safe }}
                                </div>
                                {% if article.attachments %}
                                <div class="mt-2">
                                    <strong class="text-sm text-gray-600 dark:text-gray-400">
                                        {{ t("tickets.attachments") }}:
                                    </strong>
                                    <div class="mt-1 space-y-1">
                                        {% for attachment in article.attachments %}
                                        <a href="/agent/tickets/{{ ticket.id }}/article/{{ article.id }}/attachment/{{ attachment.id }}" 
                                           class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200">
                                            <i class="fas fa-paperclip mr-1"></i>
                                            {{ attachment.filename }} ({{ attachment.filesize }} bytes)
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right Column: Ticket Information -->
        <div class="space-y-4">
            <!-- Ticket Details -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                <div class="px-4 py-3 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                        {{ t("tickets.details") }}
                    </h3>
                </div>
                <div class="px-4 py-3 sm:px-6 space-y-3" data-queue-id="{{ ticket.queue_id }}">
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("tickets.queue") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ ticket.queue_name|default:"-" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("tickets.owner") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ ticket.owner_name|default:t("common.unassigned") }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("tickets.responsible") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ ticket.responsible_user|default:t("common.unassigned") }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("tickets.type") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ ticket.type_name|default:"-" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("tickets.service") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ ticket.service_name|default:"-" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("tickets.sla") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ ticket.sla_name|default:"-" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("tickets.lock") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                            {% if ticket.lock_id == 2 %}
                                <span class="text-red-600 dark:text-red-400">
                                    <i class="fas fa-lock"></i> {{ t("tickets.locked") }}
                                </span>
                            {% else %}
                                <span class="text-green-600 dark:text-green-400">
                                    <i class="fas fa-unlock"></i> {{ t("tickets.unlocked") }}
                                </span>
                            {% endif %}
                        </dd>
                    </div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                <div class="px-4 py-3 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                        {{ t("tickets.customer_info") }}
                    </h3>
                </div>
                <div class="px-4 py-3 sm:px-6 space-y-3">
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("customer.name") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                            {{ customer.first_name }} {{ customer.last_name }}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("customer.email") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                            <a href="mailto:{{ customer.email }}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200">
                                {{ customer.email }}
                            </a>
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("customer.phone") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ customer.phone|default:"-" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ t("customer.company") }}</dt>
                        <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{ customer.company_name|default:"-" }}</dd>
                    </div>
                </div>
            </div>

            <!-- Linked Tickets -->
            {% if linked_tickets %}
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                <div class="px-4 py-3 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                        {{ t("tickets.linked_tickets") }}
                    </h3>
                </div>
                <div class="px-4 py-3 sm:px-6">
                    <ul class="space-y-2">
                        {% for linked in linked_tickets %}
                        <li>
                            <a href="/agent/tickets/{{ linked.id }}" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200">
                                #{{ linked.tn }} - {{ linked.title }}
                            </a>
                            <span class="text-xs text-gray-500 dark:text-gray-400">({{ linked.link_type }})</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- STATIC MODAL STRUCTURES - EXPECTED BY JAVASCRIPT -->
<!-- Note Modal -->
<div id="noteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Add Internal Note</h3>
        </div>
        <form onsubmit="submitNote(event)">
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                    <input type="text" name="subject" value="Internal Note" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Note</label>
                    <textarea name="body" rows="8" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white" required></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-700 rounded-b-lg flex justify-end space-x-3">
                <button type="button" onclick="closeModal('noteModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-gotrs-600 text-white rounded hover:bg-gotrs-700">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Reply Modal -->
<div id="replyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reply to Ticket</h3>
        </div>
        <form onsubmit="submitReply(event)">
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">To</label>
                    <input type="email" name="to" value="{{ ticket.customer_email }}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                    <input type="text" name="subject" value="Re: {{ ticket.title }}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message</label>
                    <textarea name="body" rows="8" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white" required></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-700 rounded-b-lg flex justify-end space-x-3">
                <button type="button" onclick="closeModal('replyModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-gotrs-600 text-white rounded hover:bg-gotrs-700">Send</button>
            </div>
        </form>
    </div>
</div>

<!-- Status Modal -->
<div id="statusModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Change Status</h3>
        </div>
        <form onsubmit="submitStatus(event)">
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                    <select name="state_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Select status...</option>
                        <option value="1">open</option>
                        <option value="2">closed successful</option>
                        <option value="3">closed unsuccessful</option>
                        <option value="4">open</option>
                        <option value="5">removed</option>
                        <option value="6">pending reminder</option>
                        <option value="7">pending auto close+</option>
                        <option value="8">pending auto close-</option>
                        <option value="9">closed with workaround</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-700 rounded-b-lg flex justify-end space-x-3">
                <button type="button" onclick="closeModal('statusModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-gotrs-600 text-white rounded hover:bg-gotrs-700">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Assign Modal -->
<div id="assignModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Assign Ticket</h3>
        </div>
        <form onsubmit="submitAssign(event)">
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Agent</label>
                    <select name="user_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Select agent...</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-700 rounded-b-lg flex justify-end space-x-3">
                <button type="button" onclick="closeModal('assignModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-gotrs-600 text-white rounded hover:bg-gotrs-700">Assign</button>
            </div>
        </form>
    </div>
</div>

<!-- Priority Modal -->
<div id="priorityModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Change Priority</h3>
        </div>
        <form onsubmit="submitPriority(event)">
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                    <select name="priority_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Select priority...</option>
                        <option value="1">1 very low</option>
                        <option value="2">2 low</option>
                        <option value="3">3 normal</option>
                        <option value="4">4 high</option>
                        <option value="5">5 very high</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-700 rounded-b-lg flex justify-end space-x-3">
                <button type="button" onclick="closeModal('priorityModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-gotrs-600 text-white rounded hover:bg-gotrs-700">Update</button>
            </div>
        </form>
    </div>
</div>

<!-- Queue Modal -->
<div id="queueModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Move to Queue</h3>
        </div>
        <form onsubmit="submitQueue(event)">
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Queue</label>
                    <select name="queue_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Select queue...</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-700 rounded-b-lg flex justify-end space-x-3">
                <button type="button" onclick="closeModal('queueModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-gotrs-600 text-white rounded hover:bg-gotrs-700">Move</button>
            </div>
        </form>
    </div>
</div>

<!-- Merge Modal -->
<div id="mergeModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Merge Ticket</h3>
        </div>
        <form onsubmit="submitMerge(event)">
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target Ticket</label>
                    <input type="number" name="target_ticket_id" placeholder="Enter ticket ID" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-gotrs-500 focus:border-gotrs-500 dark:bg-gray-700 dark:text-white">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-700 rounded-b-lg flex justify-end space-x-3">
                <button type="button" onclick="closeModal('mergeModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-gotrs-600 text-white rounded hover:bg-gotrs-700">Merge</button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript for dropdowns -->
<script>
const ticketId = {{ ticket.id }};

// Dropdown toggle function
function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.classList.toggle('hidden');
    
    // Close other dropdowns
    document.querySelectorAll('[id$="Dropdown"]').forEach(d => {
        if (d.id !== dropdownId && !d.classList.contains('hidden')) {
            d.classList.add('hidden');
        }
    });
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick*="toggleDropdown"]')) {
        document.querySelectorAll('[id$="Dropdown"]').forEach(d => {
            d.classList.add('hidden');
        });
    }
});
</script>

<!-- Include Ticket Zoom JavaScript Functions -->
<script src="/static/js/ticket-zoom.js"></script>
<script>
// Initialize ticket zoom with the ticket ID
initTicketZoom({{ ticket.id }});
</script>
{% endblock %}