{{define "internal-notes"}}
<div id="internal-notes-section" class="space-y-4">
    <!-- Notes Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <h3 class="text-lg font-semibold text-gray-900">Internal Notes</h3>
            <div class="flex items-center space-x-2">
                <button hx-get="/api/tickets/{{.ticket.ID}}/internal-notes/pinned"
                        hx-target="#notes-list"
                        class="text-sm text-gray-600 hover:text-indigo-600">
                    <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 5a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2V9a2 2 0 012-2V5z"/>
                    </svg>
                    Pinned
                </button>
                <button hx-get="/api/tickets/{{.ticket.ID}}/internal-notes/important"
                        hx-target="#notes-list"
                        class="text-sm text-gray-600 hover:text-red-600">
                    <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    Important
                </button>
            </div>
        </div>
        <button onclick="openInternalNoteModal()"
                class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Note
        </button>
    </div>

    <!-- Notes Filter and Search -->
    <div class="flex items-center space-x-2">
        <input type="text"
               placeholder="Search notes..."
               hx-get="/api/tickets/{{.ticket.ID}}/internal-notes/search"
               hx-trigger="keyup changed delay:500ms"
               hx-target="#notes-list"
               class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
        
        <select hx-get="/api/tickets/{{.ticket.ID}}/internal-notes"
                hx-trigger="change"
                hx-target="#notes-list"
                name="category"
                class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
            <option value="">All Categories</option>
            <option value="investigation">Investigation</option>
            <option value="resolution">Resolution</option>
            <option value="customer">Customer Info</option>
            <option value="escalation">Escalation</option>
            <option value="technical">Technical</option>
        </select>
    </div>

    <!-- Notes List -->
    <div id="notes-list" 
         hx-get="/api/tickets/{{.ticket.ID}}/internal-notes"
         hx-trigger="load"
         class="space-y-3">
        <div class="flex justify-center p-4">
            <div class="animate-spin w-6 h-6 border-2 border-gray-300 border-t-indigo-600 rounded-full"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Note Modal -->
<div id="internal-note-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Add Internal Note</h3>
                <button onclick="closeInternalNoteModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="internal-note-form"
                  hx-post="/api/tickets/{{.ticket.ID}}/internal-notes"
                  hx-target="#notes-list"
                  hx-on="htmx:afterRequest: closeInternalNoteModal()"
                  class="p-6 space-y-4">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Note Content *
                    </label>
                    <textarea name="content" 
                              rows="6" 
                              required
                              placeholder="Enter your internal note here. Use @username to mention team members."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500"></textarea>
                    <div class="mt-1 flex items-center justify-between text-xs text-gray-500">
                        <span>Use @username to mention team members</span>
                        <span id="char-count">0 characters</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select name="category"
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="">Select category</option>
                            <option value="investigation">Investigation</option>
                            <option value="resolution">Resolution</option>
                            <option value="customer">Customer Info</option>
                            <option value="escalation">Escalation</option>
                            <option value="technical">Technical</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Template</label>
                        <select name="template_id"
                                onchange="loadNoteTemplate(this.value)"
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="">No template</option>
                            <option value="1">Investigation Started</option>
                            <option value="2">Escalation Note</option>
                            <option value="3">Resolution Steps</option>
                            <option value="4">Customer Contact</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="is_internal" value="true" checked
                               class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-700">Internal only</span>
                    </label>
                    
                    <label class="flex items-center">
                        <input type="checkbox" name="is_important" value="true"
                               class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                        <span class="ml-2 text-sm text-gray-700">Mark as important</span>
                    </label>
                    
                    <label class="flex items-center">
                        <input type="checkbox" name="is_pinned" value="true"
                               class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-700">Pin to top</span>
                    </label>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" 
                            onclick="closeInternalNoteModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">
                        Add Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Internal Notes functionality
function openInternalNoteModal(noteId = null) {
    const modal = document.getElementById('internal-note-modal');
    const form = document.getElementById('internal-note-form');
    
    if (noteId) {
        // Edit mode
        fetch(`/api/tickets/{{.ticket.ID}}/internal-notes/${noteId}`)
            .then(response => response.json())
            .then(data => {
                form.querySelector('[name="content"]').value = data.content;
                form.querySelector('[name="category"]').value = data.category || '';
                form.querySelector('[name="is_internal"]').checked = data.is_internal;
                form.querySelector('[name="is_important"]').checked = data.is_important;
                form.querySelector('[name="is_pinned"]').checked = data.is_pinned;
                
                // Change form action to update
                form.setAttribute('hx-put', `/api/tickets/{{.ticket.ID}}/internal-notes/${noteId}`);
                modal.querySelector('h3').textContent = 'Edit Internal Note';
            });
    } else {
        // Create mode
        form.setAttribute('hx-post', '/api/tickets/{{.ticket.ID}}/internal-notes');
        modal.querySelector('h3').textContent = 'Add Internal Note';
    }
    
    modal.classList.remove('hidden');
}

function closeInternalNoteModal() {
    const modal = document.getElementById('internal-note-modal');
    const form = document.getElementById('internal-note-form');
    modal.classList.add('hidden');
    form.reset();
}

function deleteInternalNote(noteId) {
    if (confirm('Are you sure you want to delete this note?')) {
        htmx.ajax('DELETE', `/api/tickets/{{.ticket.ID}}/internal-notes/${noteId}`, {
            target: '#notes-list',
            swap: 'outerHTML'
        });
    }
}

function togglePinNote(noteId, isPinned) {
    const action = isPinned ? 'unpin' : 'pin';
    htmx.ajax('POST', `/api/tickets/{{.ticket.ID}}/internal-notes/${noteId}/${action}`, {
        target: '#notes-list',
        swap: 'outerHTML'
    });
}

function toggleImportantNote(noteId, isImportant) {
    const action = isImportant ? 'unmark' : 'important';
    htmx.ajax('POST', `/api/tickets/{{.ticket.ID}}/internal-notes/${noteId}/${action}`, {
        target: '#notes-list',
        swap: 'outerHTML'
    });
}

function loadNoteTemplate(templateId) {
    if (!templateId) return;
    
    fetch(`/api/internal-notes/templates/${templateId}`)
        .then(response => response.json())
        .then(data => {
            const contentField = document.querySelector('#internal-note-form [name="content"]');
            contentField.value = data.content;
            updateCharCount();
        });
}

// Character counter
document.querySelector('#internal-note-form [name="content"]').addEventListener('input', updateCharCount);

function updateCharCount() {
    const content = document.querySelector('#internal-note-form [name="content"]').value;
    document.getElementById('char-count').textContent = `${content.length} characters`;
}

// Mention autocomplete
document.querySelector('#internal-note-form [name="content"]').addEventListener('input', function(e) {
    const text = e.target.value;
    const cursorPos = e.target.selectionStart;
    const textUpToCursor = text.substring(0, cursorPos);
    const mentionMatch = textUpToCursor.match(/@(\w*)$/);
    
    if (mentionMatch) {
        // Show autocomplete dropdown with matching users
        const searchTerm = mentionMatch[1];
        // TODO: Implement user search and autocomplete UI
    }
});
</script>
{{end}}