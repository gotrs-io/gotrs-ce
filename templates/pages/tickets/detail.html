{{define "detail.html"}}
{{template "base.html" .}}
{{end}}

{{define "title"}}Ticket #{{.TicketID}} - GOTRS{{end}}

{{define "content"}}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <!-- Notification area for HTMX messages -->
    <div id="notification" class="hidden mb-4 rounded-md p-4">
        <div class="flex">
            <div class="ml-3">
                <p class="text-sm font-medium" id="notification-message"></p>
            </div>
        </div>
    </div>
    
    <!-- Ticket Header -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                        Ticket #{{.TicketID}}
                    </h2>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Created on <time>{{.Ticket.CreateTime}}</time>
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Status Badge -->
                    <span id="status-badge" class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200">
                        <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-yellow-400" fill="currentColor" viewBox="0 0 8 8">
                            <circle cx="4" cy="4" r="3" />
                        </svg>
                        <span id="status-text">New</span>
                    </span>
                    <!-- Priority Badge -->
                    <span class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-200">
                        Normal Priority
                    </span>
                </div>
            </div>
        </div>

        <!-- Ticket Details Grid -->
        <div class="px-4 py-5 sm:px-6">
            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Subject</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{.Ticket.Title}}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Customer</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{.Ticket.CustomerEmail}}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Queue</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">{{.Ticket.Queue}}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Assigned To</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white" id="assigned-to">
                        {{if .Ticket.AssignedTo}}
                            {{.Ticket.AssignedTo}}
                        {{else}}
                            <span class="text-gray-500 dark:text-gray-400">Unassigned</span>
                        {{end}}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">SLA Status</dt>
                    <dd class="mt-1" id="sla-status" 
                        hx-get="/api/tickets/{{.TicketID}}/sla"
                        hx-trigger="load, every 60s"
                        hx-swap="innerHTML">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Loading SLA...</span>
                    </dd>
                </div>
            </dl>
        </div>

        <!-- Action Buttons -->
        <div class="bg-gray-50 dark:bg-gray-900/50 px-4 py-4 sm:px-6 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-wrap gap-2">
                <a href="/tickets/{{.TicketID}}/edit"
                   class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gotrs-500">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                    Edit
                </a>
                <button type="button"
                        id="assign-btn"
                        hx-post="/api/tickets/{{.TicketID}}/assign"
                        hx-swap="none"
                        hx-on::after-request="handleAssignSuccess(event)"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gotrs-500">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Assign to Me
                </button>
                <button type="button"
                        id="open-btn"
                        hx-post="/api/tickets/{{.TicketID}}/status"
                        hx-vals='{"status": "open"}'
                        hx-swap="none"
                        hx-on::after-request="handleStatusChange(event, 'open')"
                        class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Mark as Open
                </button>
                <button type="button"
                        id="close-btn"
                        hx-post="/api/tickets/{{.TicketID}}/status"
                        hx-vals='{"status": "closed"}'
                        hx-swap="none"
                        hx-on::after-request="handleStatusChange(event, 'closed')"
                        class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Close Ticket
                </button>
                <button type="button"
                        onclick="showEscalateModal()"
                        class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                    </svg>
                    Escalate
                </button>
            </div>
        </div>
    </div>

    <!-- Attachments Section -->
    <div class="mt-8 bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                    Attachments
                </h3>
                <button type="button" 
                        onclick="document.getElementById('attachment-upload').click()"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm leading-5 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gotrs-500">
                    <svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    Upload File
                </button>
                <input type="file" 
                       id="attachment-upload" 
                       multiple 
                       class="hidden"
                       onchange="uploadAttachments(this.files)">
            </div>
        </div>
        
        <!-- Drag and Drop Zone -->
        <div id="attachment-drop-zone" 
             class="px-4 py-8 border-2 border-dashed border-gray-300 dark:border-gray-600 m-4 rounded-lg text-center transition-colors"
             ondrop="handleAttachmentDrop(event)"
             ondragover="handleAttachmentDragOver(event)"
             ondragleave="handleAttachmentDragLeave(event)">
            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                <span class="font-medium">Drop files here</span> or click Upload File button
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                PNG, JPG, PDF, DOC up to 10MB each
            </p>
        </div>
        
        <!-- Attachments List -->
        <div id="attachments-list" 
             class="px-4 py-3"
             hx-get="/api/tickets/{{.TicketID}}/attachments"
             hx-trigger="load, attachmentUploaded from:body"
             hx-swap="innerHTML">
            <div class="text-center py-4">
                <span class="text-sm text-gray-500 dark:text-gray-400">Loading attachments...</span>
            </div>
        </div>
    </div>

    <!-- Messages/Articles -->
    <div class="mt-8 bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                Messages
            </h3>
        </div>
        
        <div id="messages-list" 
             class="divide-y divide-gray-200 dark:divide-gray-700"
             hx-get="/api/tickets/{{.TicketID}}/messages"
             hx-trigger="load"
             hx-swap="innerHTML">
            <!-- Messages will be loaded here via HTMX -->
            <div class="px-4 py-8 text-center">
                <span class="text-sm text-gray-500 dark:text-gray-400">Loading messages...</span>
            </div>
            {{range .Articles}}
            <!-- Message/Article -->
            <div class="px-4 py-5 sm:px-6">
                <div class="flex space-x-3">
                    <div class="flex-shrink-0">
                        <div class="h-10 w-10 rounded-full bg-gray-400 dark:bg-gray-600 flex items-center justify-center">
                            <span class="text-white font-medium">{{.AuthorInitials}}</span>
                        </div>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div>
                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                {{.AuthorName}}
                                {{if eq .AuthorType "Customer"}}
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-200">
                                    Customer
                                </span>
                                {{else if eq .AuthorType "Agent"}}
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200">
                                    Agent
                                </span>
                                {{end}}
                                {{if .IsInternal}}
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200">
                                    Internal
                                </span>
                                {{end}}
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                <time>{{.TimeAgo}}</time>
                            </p>
                        </div>
                        <div class="mt-2 text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{{.Body}}</div>
                        {{if .Attachments}}
                        <div class="mt-3 border-t border-gray-200 dark:border-gray-700 pt-3">
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Attachments:</p>
                            <div class="space-y-2">
                                {{range .Attachments}}
                                <div class="inline-flex items-center space-x-2 bg-gray-50 dark:bg-gray-900/50 rounded-lg px-3 py-2">
                                    <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                    </svg>
                                    <a href="{{.URL}}" 
                                       class="text-sm text-gotrs-600 hover:text-gotrs-700 dark:text-gotrs-400 dark:hover:text-gotrs-300"
                                       download="{{.Filename}}">
                                        {{.Filename}}
                                    </a>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">({{.Size}})</span>
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}

            <!-- Reply Form -->
            <div class="px-4 py-5 sm:px-6">
                <form hx-post="/api/tickets/{{.TicketID}}/reply"
                      hx-target="#messages-list"
                      hx-swap="beforeend"
                      hx-on::after-request="if(event.detail.successful) { this.reset(); showNotification('Reply added successfully', 'success'); }"
                      class="space-y-4">
                    <div>
                        <label for="reply" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Add Reply
                        </label>
                        <div class="mt-1">
                            <textarea id="reply" 
                                      name="reply" 
                                      rows="4"
                                      class="shadow-sm focus:ring-gotrs-500 focus:border-gotrs-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"
                                      placeholder="Type your reply here..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="checkbox" 
                                       name="internal" 
                                       class="rounded border-gray-300 dark:border-gray-600 text-gotrs-600 focus:ring-gotrs-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Internal note</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" 
                                       name="close_ticket"
                                       class="rounded border-gray-300 dark:border-gray-600 text-gotrs-600 focus:ring-gotrs-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Close ticket</span>
                            </label>
                        </div>
                        
                        <button type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gotrs-600 hover:bg-gotrs-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gotrs-500">
                            Send Reply
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar Info -->
    <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Ticket Information -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                        Ticket Information
                    </h3>
                    <dl class="mt-4 grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2">
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Ticket Number</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">TICKET-{{.TicketID}}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Type</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">Service Request</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Last Updated</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">2 hours ago</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">SLA</dt>
                            <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                                <span class="text-green-600 dark:text-green-400">Within SLA</span>
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div>
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                        Activity Log
                    </h3>
                    <div class="mt-4 flow-root">
                        <ul class="-mb-4">
                            <li>
                                <div class="relative pb-4">
                                    <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200 dark:bg-gray-700"></span>
                                    <div class="relative flex space-x-3">
                                        <div>
                                            <span class="h-8 w-8 rounded-full bg-green-500 flex items-center justify-center ring-8 ring-white dark:ring-gray-800">
                                                <svg class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                            <div>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                                    Ticket created
                                                </p>
                                            </div>
                                            <div class="text-right text-sm whitespace-nowrap text-gray-500 dark:text-gray-400">
                                                <time>2h ago</time>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    const messageEl = document.getElementById('notification-message');
    
    // Set message
    messageEl.textContent = message;
    
    // Set styling based on type
    notification.className = 'mb-4 rounded-md p-4';
    if (type === 'success') {
        notification.classList.add('bg-green-50', 'dark:bg-green-900/20', 'border', 'border-green-200', 'dark:border-green-800');
        messageEl.classList.add('text-green-800', 'dark:text-green-200');
    } else if (type === 'error') {
        notification.classList.add('bg-red-50', 'dark:bg-red-900/20', 'border', 'border-red-200', 'dark:border-red-800');
        messageEl.classList.add('text-red-800', 'dark:text-red-200');
    }
    
    // Show notification
    notification.classList.remove('hidden');
    
    // Hide after 3 seconds
    setTimeout(() => {
        notification.classList.add('hidden');
    }, 3000);
}

function handleAssignSuccess(event) {
    if(event.detail.successful) {
        const btn = document.getElementById('assign-btn');
        btn.disabled = true;
        btn.innerHTML = '<svg class="-ml-0.5 mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>Assigned to You';
        
        // Update the assigned to field
        const assignedTo = document.getElementById('assigned-to');
        if (assignedTo) {
            assignedTo.innerHTML = '<span class="font-medium">Demo Agent</span> <span class="text-xs text-gray-500">(You)</span>';
        }
        
        showNotification('Ticket assigned successfully', 'success');
    }
}

function handleStatusChange(event, newStatus) {
    if(event.detail.successful) {
        const badge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');
        
        if (newStatus === 'open') {
            // Change badge to green for open
            badge.className = 'inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200';
            badge.innerHTML = '<svg class="-ml-0.5 mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg><span id="status-text">Open</span>';
            
            // Disable the open button
            const openBtn = document.getElementById('open-btn');
            if (openBtn) {
                openBtn.disabled = true;
                openBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            showNotification('Ticket marked as Open', 'success');
        } else if (newStatus === 'closed') {
            // Change badge to gray for closed
            badge.className = 'inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-200';
            badge.innerHTML = '<svg class="-ml-0.5 mr-1.5 h-2 w-2 text-gray-400" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg><span id="status-text">Closed</span>';
            
            // Disable both status buttons
            const openBtn = document.getElementById('open-btn');
            const closeBtn = document.getElementById('close-btn');
            if (openBtn) {
                openBtn.disabled = true;
                openBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            if (closeBtn) {
                closeBtn.disabled = true;
                closeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            showNotification('Ticket closed successfully', 'success');
        }
    }
}

// Attachment handling functions
function handleAttachmentDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const dropZone = document.getElementById('attachment-drop-zone');
    dropZone.classList.remove('border-gotrs-500', 'bg-gotrs-50', 'dark:bg-gotrs-900/10');
    
    const files = Array.from(event.dataTransfer.files);
    uploadAttachments(files);
}

function handleAttachmentDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const dropZone = document.getElementById('attachment-drop-zone');
    dropZone.classList.add('border-gotrs-500', 'bg-gotrs-50', 'dark:bg-gotrs-900/10');
}

function handleAttachmentDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const dropZone = document.getElementById('attachment-drop-zone');
    dropZone.classList.remove('border-gotrs-500', 'bg-gotrs-50', 'dark:bg-gotrs-900/10');
}

function uploadAttachments(files) {
    const ticketID = {{.TicketID}};
    let uploadCount = 0;
    let errorCount = 0;
    
    Array.from(files).forEach(file => {
        // Validate file size
        if (file.size > 10 * 1024 * 1024) {
            showNotification(`File ${file.name} exceeds 10MB limit`, 'error');
            errorCount++;
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch(`/api/tickets/${ticketID}/attachments`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Upload failed: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            uploadCount++;
            if (uploadCount === files.length - errorCount) {
                showNotification(`Successfully uploaded ${uploadCount} file(s)`, 'success');
                // Trigger HTMX to reload attachments list
                htmx.trigger('#attachments-list', 'attachmentUploaded');
            }
        })
        .catch(error => {
            errorCount++;
            showNotification(`Failed to upload ${file.name}: ${error.message}`, 'error');
        });
    });
}

function previewAttachment(url, filename, contentType) {
    // For images, show in advanced lightbox with zoom
    if (contentType.startsWith('image/')) {
        showAdvancedImageViewer(url, filename, contentType);
    } 
    // For PDFs, show inline viewer
    else if (contentType === 'application/pdf') {
        showPDFViewer(url, filename);
    }
    // For code/text files, show with syntax highlighting
    else if (contentType.startsWith('text/') || contentType === 'application/json' || contentType === 'application/xml' 
             || filename.match(/\.(js|ts|jsx|tsx|py|go|java|c|cpp|h|hpp|cs|rb|php|sh|bash|yml|yaml|toml|ini|cfg|conf|sql|html|css|scss|sass|less|md|markdown)$/i)) {
        showCodeViewer(url, filename, contentType);
    }
    // For video files
    else if (contentType.startsWith('video/')) {
        showVideoPlayer(url, filename, contentType);
    }
    // For audio files
    else if (contentType.startsWith('audio/')) {
        showAudioPlayer(url, filename, contentType);
    }
    // For office documents
    else if (contentType.includes('spreadsheet') || contentType.includes('word') || contentType.includes('presentation')) {
        showOfficeViewer(url, filename, contentType);
    }
    // For others, download
    else {
        window.location.href = url;
    }
}

// Advanced Image Viewer with zoom, pan, and gallery navigation
function showAdvancedImageViewer(url, filename, contentType) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 bg-black flex flex-col';
    modal.innerHTML = `
        <div class="flex items-center justify-between p-4 bg-gray-900/90 backdrop-blur">
            <div class="flex items-center space-x-4">
                <h3 class="text-white font-medium">${filename}</h3>
                <span class="text-gray-400 text-sm">${contentType}</span>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="imageZoomIn()" class="p-2 text-white hover:bg-white/10 rounded" title="Zoom In">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                    </svg>
                </button>
                <button onclick="imageZoomOut()" class="p-2 text-white hover:bg-white/10 rounded" title="Zoom Out">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                    </svg>
                </button>
                <button onclick="imageRotate()" class="p-2 text-white hover:bg-white/10 rounded" title="Rotate">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
                <button onclick="imageFullscreen()" class="p-2 text-white hover:bg-white/10 rounded" title="Fullscreen">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                    </svg>
                </button>
                <a href="${url}" download="${filename}" class="p-2 text-white hover:bg-white/10 rounded" title="Download">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                    </svg>
                </a>
                <button onclick="this.closest('.fixed').remove()" class="p-2 text-white hover:bg-white/10 rounded" title="Close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-hidden relative" id="imageViewerContainer">
            <img id="viewerImage" src="${url}" alt="${filename}" 
                 class="absolute inset-0 w-full h-full object-contain cursor-move transition-transform duration-200"
                 style="transform: scale(1) rotate(0deg);"
                 draggable="false">
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900/80 backdrop-blur px-3 py-1 rounded-full">
                <span id="zoomLevel" class="text-white text-sm">100%</span>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    setupImageControls();
}

function showTextPreview(url, filename) {
    fetch(url)
        .then(response => response.text())
        .then(text => {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-auto bg-black bg-opacity-75 flex items-center justify-center p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            // Create content container
            const container = document.createElement('div');
            container.className = 'relative bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between p-4 border-b dark:border-gray-700';
            header.innerHTML = `
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">${filename}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            // Create content area
            const content = document.createElement('pre');
            content.className = 'p-4 overflow-auto max-h-[60vh] text-sm text-gray-800 dark:text-gray-200 font-mono';
            content.textContent = text;
            
            container.appendChild(header);
            container.appendChild(content);
            modal.appendChild(container);
            document.body.appendChild(modal);
        })
        .catch(error => {
            showNotification(`Failed to preview ${filename}`, 'error');
        });
}

function deleteAttachment(attachmentID, filename) {
    if (!confirm(`Are you sure you want to delete ${filename}?`)) {
        return;
    }
    
    const ticketID = {{.TicketID}};
    
    fetch(`/api/tickets/${ticketID}/attachments/${attachmentID}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Delete failed: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        showNotification(`${filename} deleted successfully`, 'success');
        // Trigger HTMX to reload attachments list
        htmx.trigger('#attachments-list', 'attachmentUploaded');
    })
    .catch(error => {
        showNotification(`Failed to delete ${filename}: ${error.message}`, 'error');
    });
}

// Image viewer controls
let currentZoom = 1;
let currentRotation = 0;

function setupImageControls() {
    const img = document.getElementById('viewerImage');
    const container = document.getElementById('imageViewerContainer');
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;
    
    img.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.pageX - container.offsetLeft;
        startY = e.pageY - container.offsetTop;
        img.style.cursor = 'grabbing';
    });
    
    img.addEventListener('mouseup', () => {
        isDragging = false;
        img.style.cursor = 'grab';
    });
    
    img.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - container.offsetLeft;
        const y = e.pageY - container.offsetTop;
        const walkX = (x - startX) * 2;
        const walkY = (y - startY) * 2;
        img.style.left = walkX + 'px';
        img.style.top = walkY + 'px';
    });
    
    // Mouse wheel zoom
    container.addEventListener('wheel', (e) => {
        e.preventDefault();
        if (e.deltaY < 0) imageZoomIn();
        else imageZoomOut();
    });
}

function imageZoomIn() {
    currentZoom = Math.min(currentZoom + 0.2, 5);
    updateImageTransform();
}

function imageZoomOut() {
    currentZoom = Math.max(currentZoom - 0.2, 0.2);
    updateImageTransform();
}

function imageRotate() {
    currentRotation += 90;
    updateImageTransform();
}

function updateImageTransform() {
    const img = document.getElementById('viewerImage');
    const zoomLevel = document.getElementById('zoomLevel');
    img.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
    zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
}

function imageFullscreen() {
    const container = document.getElementById('imageViewerContainer');
    if (container.requestFullscreen) {
        container.requestFullscreen();
    } else if (container.webkitRequestFullscreen) {
        container.webkitRequestFullscreen();
    } else if (container.msRequestFullscreen) {
        container.msRequestFullscreen();
    }
}

// PDF Viewer
function showPDFViewer(url, filename) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 bg-gray-900 flex flex-col';
    modal.innerHTML = `
        <div class="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
            <div class="flex items-center space-x-4">
                <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-5L9 2H4z"></path>
                </svg>
                <h3 class="text-white font-medium">${filename}</h3>
            </div>
            <div class="flex items-center space-x-2">
                <a href="${url}" download="${filename}" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Download PDF
                </a>
                <button onclick="this.closest('.fixed').remove()" class="p-2 text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <iframe src="${url}" class="flex-1 w-full bg-white" style="min-height: 80vh;"></iframe>
    `;
    document.body.appendChild(modal);
}

// Code Viewer with Syntax Highlighting
function showCodeViewer(url, filename, contentType) {
    fetch(url)
        .then(response => response.text())
        .then(code => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-gray-900 flex flex-col';
            
            // Detect language from filename
            const ext = filename.split('.').pop().toLowerCase();
            const langMap = {
                'js': 'javascript', 'ts': 'typescript', 'py': 'python',
                'go': 'go', 'java': 'java', 'cpp': 'cpp', 'c': 'c',
                'html': 'html', 'css': 'css', 'json': 'json', 'xml': 'xml',
                'sh': 'bash', 'yml': 'yaml', 'sql': 'sql', 'php': 'php',
                'rb': 'ruby', 'rs': 'rust', 'swift': 'swift', 'kt': 'kotlin'
            };
            const language = langMap[ext] || 'plaintext';
            
            // Count lines
            const lines = code.split('\n').length;
            const fileSize = (new Blob([code]).size / 1024).toFixed(1);
            
            modal.innerHTML = `
                <div class="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
                    <div class="flex items-center space-x-4">
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                        <h3 class="text-white font-medium">${filename}</h3>
                        <span class="text-gray-400 text-sm">${lines} lines • ${fileSize} KB • ${language}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="copyCode('${btoa(code)}')" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-600">
                            Copy Code
                        </button>
                        <a href="${url}" download="${filename}" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Download
                        </a>
                        <button onclick="this.closest('.fixed').remove()" class="p-2 text-gray-400 hover:text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto bg-gray-900 p-4">
                    <pre class="text-gray-300 font-mono text-sm"><code class="language-${language}">${escapeHtml(code)}</code></pre>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Try to apply syntax highlighting if available
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        });
}

// Video Player
function showVideoPlayer(url, filename, contentType) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 bg-black flex items-center justify-center';
    modal.innerHTML = `
        <div class="relative max-w-4xl w-full">
            <div class="absolute top-0 right-0 p-4 z-10">
                <button onclick="this.closest('.fixed').remove()" class="p-2 bg-black/50 text-white rounded-full hover:bg-black/70">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <video controls autoplay class="w-full rounded-lg shadow-2xl">
                <source src="${url}" type="${contentType}">
                Your browser does not support the video tag.
            </video>
            <div class="mt-4 text-center">
                <h3 class="text-white font-medium">${filename}</h3>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Audio Player
function showAudioPlayer(url, filename, contentType) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 bg-gradient-to-br from-purple-900 to-blue-900 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-32 h-32 mx-auto mb-4 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center animate-pulse">
                    <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"></path>
                    </svg>
                </div>
                <h3 class="text-white font-semibold text-lg">${filename}</h3>
            </div>
            <audio controls class="w-full">
                <source src="${url}" type="${contentType}">
                Your browser does not support the audio element.
            </audio>
            <div class="mt-6 flex justify-center">
                <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-white/20 text-white rounded-full hover:bg-white/30">
                    Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Office Document Viewer
function showOfficeViewer(url, filename, contentType) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 bg-gray-900 flex flex-col';
    
    // Use Google Docs viewer for office files
    const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(window.location.origin + url)}&embedded=true`;
    
    modal.innerHTML = `
        <div class="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
            <div class="flex items-center space-x-4">
                <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 100 4h2a2 2 0 100-4h-.5a1 1 0 000-2H14a2 2 0 012 2v9a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7zm0 3a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                </svg>
                <h3 class="text-white font-medium">${filename}</h3>
            </div>
            <div class="flex items-center space-x-2">
                <a href="${url}" download="${filename}" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Download
                </a>
                <button onclick="this.closest('.fixed').remove()" class="p-2 text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <iframe src="${viewerUrl}" class="flex-1 w-full bg-white" style="min-height: 80vh;"></iframe>
    `;
    document.body.appendChild(modal);
}

function copyCode(encodedCode) {
    const code = atob(encodedCode);
    navigator.clipboard.writeText(code).then(() => {
        showNotification('Code copied to clipboard!', 'success');
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{{end}}