name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly security scan
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write
  actions: read

jobs:
  gitleaks:
    name: Detect Secrets
    runs-on: ubuntu-latest
    environment: Development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for scanning
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
          GITLEAKS_ENABLE_COMMENTS: true
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: true
          GITLEAKS_ENABLE_SUMMARY: true

      # Alternative: Run Gitleaks with Docker
      # - name: Run Gitleaks with Docker
      #   run: |
      #     docker run --rm \
      #       -v "${{ github.workspace }}:/workspace" \
      #       -w /workspace \
      #       zricethezav/gitleaks:latest \
      #       detect --source . --verbose --report-format json --report-path gitleaks-report.json

      - name: Upload Gitleaks Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: |
            gitleaks-report.json
            gitleaks-report.sarif
          retention-days: 30

  trivy-secrets:
    name: Trivy Secret Scanning
    runs-on: ubuntu-latest
    environment: Development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-secrets.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'secret'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-secrets.sarif'
          category: 'trivy-secrets'

      - name: Upload Trivy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-secrets-report
          path: trivy-secrets.sarif
          retention-days: 30

  notify-on-failure:
    name: Notify on Secret Detection
    needs: [gitleaks, trivy-secrets]
    if: failure()
    runs-on: ubuntu-latest
    environment: Development
    steps:
      - name: Create Issue on Secret Detection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security: Secrets Detected in Repository',
              body: `## Security Alert: Secrets Detected
            
            Secrets or sensitive information have been detected in the repository.
            
            **Workflow Run:** [${context.workflow} #${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Branch:** ${context.ref}
            **Commit:** ${context.sha}
            
            ### Immediate Actions Required:
            1. Review the security scan results in the workflow artifacts
            2. Rotate any exposed credentials immediately
            3. Remove secrets from the repository history if needed
            4. Update the code to use environment variables instead
            
            ### Resources:
            - [GitHub Secret Scanning Documentation](https://docs.github.com/en/code-security/secret-scanning)
            - [Removing Sensitive Data from Repository](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository)
            
            cc: @${context.actor}`,
              labels: ['security', 'critical', 'secrets-detected']
            });
            console.log(`Issue created: ${issue.data.html_url}`);