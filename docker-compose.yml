# Podman-compatible compose file (also works with Docker)
# No version specified for better Podman compatibility

services:
  # MariaDB Database - Secure non-root container for OTRS compatibility
  mariadb:
    image: docker.io/mariadb:11
    container_name: gotrs-mariadb
    user: "999:999" # Run as mysql user (standard for MariaDB)
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme}
      MYSQL_DATABASE: ${DB_NAME:-otrs}
      MYSQL_USER: ${DB_USER:-otrs}
      MYSQL_PASSWORD: ${DB_PASSWORD:-LetClaude.1n}
      # MariaDB specific settings for better performance
      MYSQL_INITDB_SKIP_TZINFO: 1
    ports:
      - "${DB_PORT:-3306}:3306"
    expose:
      - "3306"
    volumes:
      - mariadb_data:/var/lib/mysql:Z
      - ./docker/mariadb/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro,Z
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gotrs-network
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: gotrs-postgres
  #   environment:
  #     POSTGRES_DB: ${DB_NAME}
  #     POSTGRES_USER: ${DB_USER}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD}
  #     # Pass APP_ENV to prevent test database creation in production
  #     APP_ENV: ${APP_ENV:-development}
  #   ports:
  #     - "${DB_PORT:-5432}:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #     # Init script handles any username and creates test database safely
  #     - ./docker/postgres/01-init-databases.sql:/docker-entrypoint-initdb.d/01-init-databases.sql:ro,Z
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - gotrs-network

    # Valkey Cache - High-performance Redis-compatible cache
  valkey:
    image: docker.io/valkey/valkey:7-alpine
    container_name: gotrs-valkey
    user: "999:1000" # Run as valkey user (standard for Valkey)
    ports:
      - "${VALKEY_PORT:-6388}:6379"
    volumes:
      - valkey_data:/data:Z
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gotrs-network

  # GOTRS Backend - Main application server
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: localhost/gotrs-backend:latest
    command: >
      sh -c "
        # Generate self-signed certificates if they don't exist
        if [ ! -f /app/certs/server.crt ] || [ ! -f /app/certs/server.key ]; then
          echo 'ðŸ” Generating self-signed TLS certificates...'
          mkdir -p /app/certs
          openssl req -x509 -newkey rsa:4096 -keyout /app/certs/server.key -out /app/certs/server.crt -days 365 -nodes -subj '/CN=gotrs-backend'
          echo 'âœ… TLS certificates generated'
        fi
        # Start the application
        ./goats
      "
    environment:
      # Enable YAML-based routing by default
      ENABLE_YAML_ROUTING: ${ENABLE_YAML_ROUTING:-true}
      ROUTES_DIR: /app/routes
      APP_ENV: ${APP_ENV:-development}
      APP_PORT: ${APP_PORT:-8080}
      DB_DRIVER: ${DB_DRIVER:-mariadb}
      DB_HOST: ${DB_HOST:-mariadb}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DATABASE_URL: ${DATABASE_URL}
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      PASSWORD_HASH_TYPE: ${PASSWORD_HASH_TYPE:-sha256}
      MIGRATE_PASSWORD_HASHES: ${MIGRATE_PASSWORD_HASHES:-false}
      STORAGE_LOCAL_PATH: ./storage
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10MB}
      ALLOWED_FILE_TYPES: ${ALLOWED_FILE_TYPES:-pdf,doc,docx,txt,png,jpg,jpeg,gif,zip}
      # TLS configuration
      TLS_CERT_FILE: /app/certs/server.crt
      TLS_KEY_FILE: /app/certs/server.key
    ports:
      - "${BACKEND_PORT:-8081}:8080"
    volumes:
       - ./storage:/app/storage:Z
       - ./certs:/app/certs:Z
    depends_on:
      # postgres:
      #   condition: service_healthy
      valkey:
        condition: service_healthy
    networks:
      - gotrs-network
    # Production binary runs automatically from Dockerfile CMD
    # For development hot reload, volume mount handles code changes

  # Nginx Reverse Proxy (serves static assets and proxies to backend)
  # nginx:
  #   image: nginx:alpine
  #   container_name: gotrs-nginx
  #   user: "101:101" # Run as nginx user for Podman rootless compatibility
  #   command: >
  #     sh -c "
  #       mkdir -p /tmp/nginx/client_temp /tmp/nginx/proxy_temp /tmp/nginx/fastcgi_temp /tmp/nginx/uwsgi_temp /tmp/nginx/scgi_temp &&
  #       nginx -g 'daemon off;'
  #     "
  #   ports:
  #     - "${NGINX_PORT:-80}:80"
  #   volumes:
  #     - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro,Z
  #     - ./docker/nginx/error.html:/etc/nginx/error.html:ro,Z
  #     - ./static:/var/www/static:ro,Z
  #   depends_on:
  #     - backend
  #   networks:
  #     - gotrs-network

  # Mailhog for Email Testing
  #mailhog:
  #  image: mailhog/mailhog:latest
  #  container_name: gotrs-mailhog
  #  ports:
  #    - "${MAILHOG_SMTP_PORT:-1025}:1025" # SMTP
  #    - "${MAILHOG_UI_PORT:-8025}:8025" # Web UI
  #  networks:
  #    - gotrs-network

  # Temporal Workflow Engine - COMMENTED OUT until code is implemented
  # temporal:
  #   image: temporalio/auto-setup:1.22.4
  #   container_name: gotrs-temporal
  #   depends_on:
  #     - postgres
  #   environment:
  #     - DB=postgresql
  #     - DB_PORT=5432
  #     - POSTGRES_USER=${DB_USER}
  #     - POSTGRES_PWD=${DB_PASSWORD}
  #     - POSTGRES_SEEDS=postgres
  #     - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig.yaml
  #   ports:
  #     - "${TEMPORAL_PORT:-7233}:7233"
  #   volumes:
  #     - ./docker/temporal/dynamicconfig.yaml:/etc/temporal/config/dynamicconfig.yaml:ro,Z
  #   networks:
  #     - gotrs-network

  # Temporal Web UI - COMMENTED OUT until code is implemented
  # temporal-ui:
  #   image: temporalio/ui:2.21.3
  #   container_name: gotrs-temporal-ui
  #   depends_on:
  #     - temporal
  #   environment:
  #     - TEMPORAL_ADDRESS=temporal:7233
  #     - TEMPORAL_CORS_ORIGINS=http://localhost:3000
  #   ports:
  #     - "${TEMPORAL_UI_PORT:-8088}:8080"
  #   networks:
  #     - gotrs-network

  # Zinc Search Engine (Elasticsearch compatible) - COMMENTED OUT until code is implemented
  # zinc:
  #   image: public.ecr.aws/zinclabs/zincsearch:latest
  #   container_name: gotrs-zinc
  #   environment:
  #     - ZINC_FIRST_ADMIN_USER=${ZINC_USER}
  #     - ZINC_FIRST_ADMIN_PASSWORD=${ZINC_PASSWORD}
  #     - ZINC_DATA_PATH=/data
  #   ports:
  #     - "${ZINC_PORT:-4080}:4080"
  #   volumes:
  #     - zinc_data:/data
  #   networks:
  #     - gotrs-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:4080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # OpenLDAP Server for Testing - COMMENTED OUT until code is implemented
  # openldap:
  #   image: osixia/openldap:1.5.0
  #   container_name: gotrs-openldap
  #   environment:
  #     - LDAP_ORGANISATION=GOTRS Test Corp
  #     - LDAP_DOMAIN=gotrs.local
  #     - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD:-admin123}
  #     - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD:-config123}
  #     - LDAP_READONLY_USER=true
  #     - LDAP_READONLY_USER_USERNAME=readonly
  #     - LDAP_READONLY_USER_PASSWORD=${LDAP_READONLY_PASSWORD:-readonly123}
  #     - LDAP_RFC2307BIS_SCHEMA=false
  #     - LDAP_BACKEND=mdb
  #     - LDAP_TLS=true
  #     - LDAP_TLS_CRT_FILENAME=ldap.crt
  #     - LDAP_TLS_KEY_FILENAME=ldap.key
  #     - LDAP_TLS_DH_PARAM_FILENAME=dhparam.pem
  #     - LDAP_TLS_CA_CRT_FILENAME=ca.crt
  #     - LDAP_TLS_ENFORCE=false
  #     - LDAP_TLS_CIPHER_SUITE=SECURE256:-VERS-SSL3.0
  #     - LDAP_TLS_PROTOCOL_MIN=3.1
  #     - LDAP_TLS_VERIFY_CLIENT=demand
  #     - LDAP_REPLICATION=false
  #     - KEEP_EXISTING_CONFIG=false
  #     - LDAP_REMOVE_CONFIG_AFTER_SETUP=true
  #     - LDAP_SSL_HELPER_PREFIX=ldap
  #   ports:
  #     - "${LDAP_PORT:-389}:389"
  #     - "${LDAPS_PORT:-636}:636"
  #   volumes:
  #     - ldap_data:/var/lib/ldap
  #     - ldap_config:/etc/ldap/slapd.d
  #     - ./docker/ldap/bootstrap:/container/service/slapd/assets/config/bootstrap/ldif/custom:Z
  #   command: --copy-service --loglevel debug
  #   networks:
  #     - gotrs-network
  #   healthcheck:
  #     test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "dc=gotrs,dc=local", "-D", "cn=admin,dc=gotrs,dc=local", "-w", "${LDAP_ADMIN_PASSWORD:-admin123}", "(objectclass=*)", "dn"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 60s

  # phpLDAPadmin for LDAP Management (Optional) - COMMENTED OUT until code is implemented
  # phpldapadmin:
  #   image: osixia/phpldapadmin:latest
  #   container_name: gotrs-phpldapadmin
  #   environment:
  #     - PHPLDAPADMIN_LDAP_HOSTS=openldap
  #     - PHPLDAPADMIN_HTTPS=false
  #   ports:
  #     - "${PHPLDAPADMIN_PORT:-8091}:80"
  #   depends_on:
  #     - openldap
  #   networks:
  #     - gotrs-network
  #   profiles:
  #     - tools

    # Adminer - Database management tool
  adminer:
    image: docker.io/adminer:latest
    container_name: gotrs-adminer
    ports:
      - "${ADMINER_PORT:-8090}:8080"
    depends_on:
      - mariadb
    networks:
      - gotrs-network
    profiles:
      - tools

  # Container-first test runner
  gotrs-tests:
    build:
      context: .
      dockerfile: Dockerfile.tests
    container_name: gotrs-tests
    environment:
      GOTRS_HOST: http://gotrs-backend:8080
      VERBOSE: "true"
      OUTPUT_DIR: /app/results
    volumes:
      - ./test-results:/app/results:Z
    depends_on:
      - backend
    networks:
      - gotrs-network
    profiles: ["testing"]

  # Development toolbox with all-in-one development tools
  toolbox:
    build:
      context: .
      dockerfile: Dockerfile.toolbox
    image: localhost/gotrs-toolbox:latest
    container_name: gotrs-toolbox
    user: "1000:1000" # Run as non-root user (matching backend)
    environment:
      # Go development environment
      GOCACHE: /workspace/.cache/go-build
      GOMODCACHE: /workspace/.cache/go-mod
      GOLANGCI_LINT_CACHE: /workspace/.cache/golangci-lint
      GOTOOLCHAIN: local
      PATH: /usr/local/go/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - .:/workspace:Z
      - gotrs_go_build_cache:/workspace/.cache/go-build
      - gotrs_go_mod_cache:/workspace/.cache/go-mod
      - gotrs_golangci_cache:/workspace/.cache/golangci-lint
      - gotrs_node_modules:/workspace/node_modules
      - gotrs_runtime:/workspace/runtime
    working_dir: /workspace
    networks:
      - gotrs-network
    profiles: ["toolbox"]
    # Interactive shell by default
    stdin_open: true
    tty: true
    command: ["/bin/bash"]

networks:
  gotrs-network:
    driver: bridge

volumes:
  mariadb_data:
  # postgres_data:     # Commented out - using MariaDB instead
  valkey_data:
  gotrs_node_modules:
  gotrs_go_build_cache:
  gotrs_go_mod_cache:
  gotrs_golangci_cache:
  gotrs_runtime:
  # zinc_data:         # Commented out - zinc service disabled
  # temporal_data:     # Commented out - temporal service disabled
  # ldap_data:         # Commented out - openldap service disabled
  # ldap_config:       # Commented out - openldap service disabled
