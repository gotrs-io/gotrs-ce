{% extends "layouts/base.pongo2" %}

{% block title %}{{ t("admin.modules.generic_agent.title") }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 min-h-screen">
    <!-- Page header -->
    <header class="mb-8">
        <div class="sm:flex sm:items-center sm:justify-between">
            <div>
                <h1 class="text-3xl font-bold gk-heading">
                    <span class="gk-text-gradient">{{ t("admin.modules.generic_agent.title") }}</span>
                </h1>
                <p class="mt-2 text-sm" style="color: var(--gk-text-muted);">{{ t("admin.modules.generic_agent.description") }}</p>
            </div>
            <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                <button onclick="openJobModal()" class="gk-btn-neon" title="{{ t("admin.modules.generic_agent.add_job") }}">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    {{ t("admin.modules.generic_agent.add_job") }}
                </button>
            </div>
        </div>
    </header>

    <!-- Filters -->
    <div class="mb-6 gk-card-glow rounded-lg p-4">
        <form method="GET" action="/admin/generic-agent" class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <input type="text" name="search" value="{{ SearchQuery }}"
                    placeholder="{{ t("admin.modules.generic_agent.placeholders.search") }}"
                    class="gk-input-neon w-full"
                >
            </div>
            <div>
                <select name="valid" class="gk-select-neon">
                    <option value="all" {% if ValidFilter == "all" %}selected{% endif %}>{{ t("admin.modules.generic_agent.filter.all_status") }}</option>
                    <option value="valid" {% if ValidFilter == "valid" %}selected{% endif %}>{{ t("admin.modules.generic_agent.filter.valid_only") }}</option>
                    <option value="invalid" {% if ValidFilter == "invalid" %}selected{% endif %}>{{ t("admin.modules.generic_agent.filter.invalid_only") }}</option>
                </select>
            </div>
            <button type="submit" class="gk-btn-neon" title="{{ t("admin.modules.generic_agent.actions.filter") }}">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                {{ t("admin.modules.generic_agent.actions.filter") }}
            </button>
            {% if SearchQuery or ValidFilter != "all" %}
            <a href="/admin/generic-agent" class="gk-btn-secondary" title="{{ t("admin.modules.generic_agent.actions.clear") }}">
                {{ t("admin.modules.generic_agent.actions.clear") }}
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Jobs Table -->
    <div class="gk-card-glow overflow-hidden rounded-lg">
        <table class="gk-table">
            <thead>
                <tr>
                    <th scope="col">{{ t("admin.modules.generic_agent.fields.name") }}</th>
                    <th scope="col">{{ t("admin.modules.generic_agent.fields.schedule") }}</th>
                    <th scope="col">{{ t("admin.modules.generic_agent.fields.status") }}</th>
                    <th scope="col">{{ t("common.actions") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for job in Jobs %}
                <tr>
                    <td>
                        <span class="font-medium" style="color: var(--gk-text-primary);">{{ job.Name }}</span>
                    </td>
                    <td>
                        {% if job.Config.ScheduleDays or job.Config.ScheduleHours or job.Config.ScheduleMinutes %}
                        <span class="text-xs" style="color: var(--gk-text-secondary);">
                            {% if job.Config.ScheduleDays %}{{ t("admin.modules.generic_agent.fields.days") }}: {{ job.Config.ScheduleDays }}{% endif %}
                            {% if job.Config.ScheduleHours %} {{ t("admin.modules.generic_agent.fields.hours") }}: {{ job.Config.ScheduleHours }}{% endif %}
                            {% if job.Config.ScheduleMinutes %} {{ t("admin.modules.generic_agent.fields.minutes") }}: {{ job.Config.ScheduleMinutes }}{% endif %}
                        </span>
                        {% else %}
                        <span style="color: var(--gk-text-muted);">{{ t("admin.modules.generic_agent.messages.not_scheduled") }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if job.Valid %}
                        <span class="gk-badge gk-badge-success">{{ t("common.valid") }}</span>
                        {% else %}
                        <span class="gk-badge gk-badge-error">{{ t("common.invalid") }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex items-center justify-end space-x-2">
                            <button onclick="editJob('{{ job.Name }}')"
                                class="p-1 rounded transition-colors hover:bg-white/10"
                                style="color: var(--gk-primary);"
                                title="{{ t("admin.modules.generic_agent.edit_job") }}"
                            >
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="toggleJobStatus('{{ job.Name }}', {% if job.Valid %}true{% else %}false{% endif %})"
                                class="p-1 rounded transition-colors hover:bg-white/10"
                                style="color: var(--gk-warning);"
                                title="{% if job.Valid %}{{ t("admin.modules.generic_agent.actions.deactivate") }}{% else %}{{ t("admin.modules.generic_agent.actions.activate") }}{% endif %}"
                            >
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    {% if job.Valid %}
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                    {% else %}
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    {% endif %}
                                </svg>
                            </button>
                            <button onclick="deleteJob('{{ job.Name }}')"
                                class="p-1 rounded transition-colors hover:bg-white/10"
                                style="color: var(--gk-error);"
                                title="{{ t("common.delete") }}"
                            >
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="px-6 py-12 text-center" style="color: var(--gk-text-muted);">
                        <svg class="mx-auto h-12 w-12 mb-3" style="color: var(--gk-text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <h3 class="text-sm font-medium mb-1" style="color: var(--gk-text-primary);">{{ t("admin.modules.generic_agent.messages.no_jobs") }}</h3>
                        <p class="text-sm mb-4" style="color: var(--gk-text-muted);">{{ t("admin.modules.generic_agent.messages.get_started")|default:"Get started by creating your first job." }}</p>
                        <button onclick="openJobModal()" class="gk-btn-neon">
                            {{ t("admin.modules.generic_agent.add_job") }}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Job Modal -->
<div id="jobModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="gk-modal-backdrop fixed inset-0" aria-hidden="true" onclick="closeJobModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="gk-modal inline-block align-bottom text-left overflow-hidden transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full max-h-[90vh] overflow-y-auto">
            <form id="jobForm" onsubmit="saveJob(event)">
                <div class="gk-modal-header">
                    <h2 id="modalTitle" class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("admin.modules.generic_agent.add_job") }}</h2>
                    <button type="button" onclick="closeJobModal()" class="p-1 rounded transition-colors hover:bg-white/10" style="color: var(--gk-text-muted);">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="gk-modal-body space-y-6">
                    <input type="hidden" id="jobOriginalName" name="original_name">

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" style="color: var(--gk-text-secondary);">{{ t("admin.modules.generic_agent.fields.name") }} *</label>
                            <input type="text" id="jobName" name="name" required class="gk-input-neon w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" style="color: var(--gk-text-secondary);">{{ t("admin.modules.generic_agent.fields.status") }}</label>
                            <select id="jobValid" name="valid" class="gk-select-neon w-full">
                                <option value="true">{{ t("common.valid") }}</option>
                                <option value="false">{{ t("common.invalid") }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="border-t pt-4" style="border-color: var(--gk-border);">
                        <h3 class="text-base font-medium mb-3" style="color: var(--gk-text-primary);">{{ t("admin.modules.generic_agent.fields.schedule") }}</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1" style="color: var(--gk-text-secondary);">{{ t("admin.modules.generic_agent.fields.days") }}</label>
                                <input type="text" id="jobScheduleDays" name="schedule_days"
                                    placeholder="{{ t("admin.modules.generic_agent.placeholders.days") }}"
                                    class="gk-input-neon w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" style="color: var(--gk-text-secondary);">{{ t("admin.modules.generic_agent.fields.hours") }}</label>
                                <input type="text" id="jobScheduleHours" name="schedule_hours"
                                    placeholder="{{ t("admin.modules.generic_agent.placeholders.hours") }}"
                                    class="gk-input-neon w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1" style="color: var(--gk-text-secondary);">{{ t("admin.modules.generic_agent.fields.minutes") }}</label>
                                <input type="text" id="jobScheduleMinutes" name="schedule_minutes"
                                    placeholder="{{ t("admin.modules.generic_agent.placeholders.minutes") }}"
                                    class="gk-input-neon w-full">
                            </div>
                        </div>
                    </div>

                    <div class="border-t pt-4" style="border-color: var(--gk-border);">
                        <h3 class="text-base font-medium mb-2" style="color: var(--gk-text-primary);">{{ t("admin.modules.generic_agent.fields.config") }}</h3>
                        <p class="text-sm mb-3" style="color: var(--gk-text-muted);">{{ t("admin.modules.generic_agent.help.config") }}</p>
                        <textarea id="jobConfig" name="config" rows="8"
                            placeholder='{"TicketStateMatch": "new", "NewTicketState": "open"}'
                            class="gk-input-neon w-full font-mono text-sm"></textarea>
                    </div>
                </div>

                <div class="gk-modal-footer">
                    <button type="button" onclick="closeJobModal()" class="gk-btn-secondary">
                        {{ t("common.cancel") }}
                    </button>
                    <button type="submit" class="gk-btn-neon">
                        {{ t("common.save") }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Translated strings for JavaScript
const i18n = {
    addJob: '{{ t("admin.modules.generic_agent.add_job") }}',
    editJob: '{{ t("admin.modules.generic_agent.edit_job") }}',
    saving: '{{ t("common.saving") }}',
    save: '{{ t("common.save") }}',
    loadFailed: '{{ t("admin.modules.generic_agent.messages.load_failed") }}',
    invalidJson: '{{ t("admin.modules.generic_agent.messages.invalid_json") }}',
    errorOccurred: '{{ t("admin.modules.generic_agent.messages.error_occurred") }}',
    confirmActivate: '{{ t("admin.modules.generic_agent.messages.confirm_activate") }}',
    confirmDeactivate: '{{ t("admin.modules.generic_agent.messages.confirm_deactivate") }}',
    jobActivated: '{{ t("admin.modules.generic_agent.messages.job_activated") }}',
    jobDeactivated: '{{ t("admin.modules.generic_agent.messages.job_deactivated") }}',
    confirmDelete: '{{ t("admin.modules.generic_agent.messages.confirm_delete") }}'
};

function openJobModal() {
    document.getElementById('modalTitle').textContent = i18n.addJob;
    document.getElementById('jobForm').reset();
    document.getElementById('jobOriginalName').value = '';
    document.getElementById('jobConfig').value = '';
    const modal = document.getElementById('jobModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function editJob(name) {
    fetch('/admin/api/generic-agent/' + encodeURIComponent(name))

        .then(result => {
            if (result.success) {
                const job = result.data;
                document.getElementById('modalTitle').textContent = i18n.editJob;
                document.getElementById('jobOriginalName').value = job.name;
                document.getElementById('jobName').value = job.name;
                document.getElementById('jobValid').value = job.valid ? 'true' : 'false';

                // Extract schedule fields from config
                document.getElementById('jobScheduleDays').value = job.config.ScheduleDays || '';
                document.getElementById('jobScheduleHours').value = job.config.ScheduleHours || '';
                document.getElementById('jobScheduleMinutes').value = job.config.ScheduleMinutes || '';

                // Remove schedule and valid from config for display
                const displayConfig = {...job.config};
                delete displayConfig.ScheduleDays;
                delete displayConfig.ScheduleHours;
                delete displayConfig.ScheduleMinutes;
                delete displayConfig.Valid;

                if (Object.keys(displayConfig).length > 0) {
                    document.getElementById('jobConfig').value = JSON.stringify(displayConfig, null, 2);
                } else {
                    document.getElementById('jobConfig').value = '';
                }

                const modal = document.getElementById('jobModal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            } else {
                showToast(result.error || i18n.loadFailed, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(i18n.loadFailed, 'error');
        });
}

function closeJobModal() {
    const modal = document.getElementById('jobModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function saveJob(event) {
    event.preventDefault();

    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = i18n.saving;

    const formData = new FormData(event.target);
    const originalName = formData.get('original_name');

    // Build config object
    let config = {};

    // Add schedule fields
    const scheduleDays = formData.get('schedule_days');
    const scheduleHours = formData.get('schedule_hours');
    const scheduleMinutes = formData.get('schedule_minutes');

    if (scheduleDays) config.ScheduleDays = scheduleDays;
    if (scheduleHours) config.ScheduleHours = scheduleHours;
    if (scheduleMinutes) config.ScheduleMinutes = scheduleMinutes;

    // Parse additional config JSON
    const configText = document.getElementById('jobConfig').value.trim();
    if (configText) {
        try {
            const additionalConfig = JSON.parse(configText);
            config = {...config, ...additionalConfig};
        } catch (e) {
            showToast(i18n.invalidJson, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = i18n.save;
            return;
        }
    }

    const data = {
        name: formData.get('name'),
        valid: formData.get('valid') === 'true',
        config: config
    };

    const url = originalName ? '/admin/api/generic-agent/' + encodeURIComponent(originalName) : '/admin/api/generic-agent';
    const method = originalName ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })

    .then(result => {
        if (result.success) {
            showToast(result.message, 'success');
            closeJobModal();
            window.location.reload();
        } else {
            showToast(result.error || i18n.errorOccurred, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = i18n.save;
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        showToast(i18n.errorOccurred + ': ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = i18n.save;
    });
}

function toggleJobStatus(name, currentValid) {
    const newValid = !currentValid;
    const confirmMsg = newValid ? i18n.confirmActivate : i18n.confirmDeactivate;
    const successMsg = newValid ? i18n.jobActivated : i18n.jobDeactivated;

    if (confirm(confirmMsg.replace('{name}', name))) {
        fetch('/admin/api/generic-agent/' + encodeURIComponent(name), {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ valid: newValid })
        })

        .then(result => {
            if (result.success) {
                showToast(successMsg, 'success');
                setTimeout(() => window.location.reload(), 500);
            } else {
                showToast(result.error || i18n.errorOccurred, 'error');
            }
        })
        .catch(error => {
            console.error('Toggle error:', error);
            showToast(i18n.errorOccurred + ': ' + error.message, 'error');
        });
    }
}

function deleteJob(name) {
    if (confirm(i18n.confirmDelete.replace('{name}', name))) {
        fetch('/admin/api/generic-agent/' + encodeURIComponent(name), {
            method: 'DELETE'
        })

        .then(result => {
            if (result.success) {
                showToast(result.message, 'success');
                setTimeout(() => window.location.reload(), 500);
            } else {
                showToast(result.error || i18n.errorOccurred, 'error');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showToast(i18n.errorOccurred + ': ' + error.message, 'error');
        });
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeJobModal();
    }
});

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
        type === 'error' ? 'bg-red-600' :
        type === 'success' ? 'bg-green-600' :
        'bg-blue-600'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
