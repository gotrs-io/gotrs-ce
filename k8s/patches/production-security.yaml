# Production security patches

# Enhanced security context for backend
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gotrs-backend
  namespace: gotrs
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: gotrs-backend
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          capabilities:
            drop:
            - ALL
        env:
        # Enhanced security environment variables
        - name: SECURITY_HEADERS_ENABLED
          value: "true"
        - name: CSRF_ENABLED
          value: "true"
        - name: RATE_LIMIT_ENABLED
          value: "true"
        - name: RATE_LIMIT_RPS
          value: "100"  # More restrictive in production
        - name: RATE_LIMIT_BURST
          value: "200"
        - name: CORS_ALLOWED_ORIGINS
          value: "https://gotrs.local,https://www.gotrs.local"  # Specific domains only
---
# Enhanced network policies for production
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gotrs-backend-netpol
  namespace: gotrs
spec:
  podSelector:
    matchLabels:
      app: gotrs-backend
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Only allow traffic from nginx frontend
  - from:
    - podSelector:
        matchLabels:
          app: nginx-frontend
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090  # metrics

  # Allow monitoring
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9090

  egress:
  # Database access
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432

  # Redis access
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379

  # DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # HTTPS for external APIs (restricted)
  - to: []
    ports:
    - protocol: TCP
      port: 443
---
# Database network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpol
  namespace: gotrs
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Only allow backend and monitoring
  - from:
    - podSelector:
        matchLabels:
          app: gotrs-backend
    ports:
    - protocol: TCP
      port: 5432

  - from:
    - podSelector:
        matchLabels:
          app: postgres-exporter
    ports:
    - protocol: TCP
      port: 5432

  # Replication traffic
  - from:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432

  egress:
  # DNS only
  - to: []
    ports:
    - protocol: UDP
      port: 53

  # Replication
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
---
# Redis network policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-netpol
  namespace: gotrs
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Backend access
  - from:
    - podSelector:
        matchLabels:
          app: gotrs-backend
    ports:
    - protocol: TCP
      port: 6379

  # Monitoring
  - from:
    - podSelector:
        matchLabels:
          app: redis-exporter
    ports:
    - protocol: TCP
      port: 6379

  # Sentinel traffic
  - from:
    - podSelector:
        matchLabels:
          app: redis-sentinel
    ports:
    - protocol: TCP
      port: 6379

  # Inter-redis communication
  - from:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379

  egress:
  # DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53

  # Redis replication
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
