{% extends "layouts/base.pongo2" %}

{% block title %}{{ module.Plural }} Management{% endblock %}

{% block styles %}
<style>
    /* Inline Edit Styles */
    .inline-edit-display {
        cursor: text;
        padding: 2px 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .inline-edit-display:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }
    
    .inline-edit-display::after {
        content: '✎';
        margin-left: 4px;
        font-size: 10px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .inline-edit-display:hover::after {
        opacity: 0.5;
    }
    
    .inline-edit-saving {
        opacity: 0.5;
        pointer-events: none;
    }
    
    .inline-edit-success {
        animation: flashGreen 0.5s;
    }
    
    .inline-edit-error {
        animation: flashRed 0.5s;
    }
    
    @keyframes flashGreen {
        0%, 100% { background-color: transparent; }
        50% { background-color: rgba(34, 197, 94, 0.2); }
    }
    
    @keyframes flashRed {
        0%, 100% { background-color: transparent; }
        50% { background-color: rgba(239, 68, 68, 0.2); }
    }

    .mail-row-selected {
        background-color: rgba(59, 130, 246, 0.08);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="mb-6">
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ module.Plural }} Management</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">{{ module.Description }}</p>
    </div>

    <!-- Action Bar -->
    <div class="mb-4 flex justify-between items-center">
        <div class="flex space-x-2">
            <button onclick="openCreateModal()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus icon-sm mr-2"></i>
                New {{ module.Singular }}
            </button>
            
            <!-- Bulk Actions (hidden by default) -->
            <div id="bulkActions" class="hidden flex gap-2">
                <span class="self-center text-sm text-gray-600 dark:text-gray-400">
                    <span id="selectedCount">0</span> selected
                </span>
                {% if features.StatusToggle %}
                <button onclick="bulkToggleStatus()" 
                        class="px-3 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors text-sm">
                    <i class="fas fa-toggle-on icon-sm mr-1"></i>
                    Toggle Status
                </button>
                {% endif %}
                {% if features.ExportCSV %}
                <button onclick="exportSelected()" 
                        class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm">
                    <i class="fas fa-file-export icon-sm mr-1"></i>
                    Export Selected
                </button>
                {% endif %}
                <button onclick="bulkDelete()" 
                        class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm">
                    <i class="fas fa-trash icon-sm mr-1"></i>
                    Delete Selected
                </button>
            </div>
            {% if features.ImportCSV %}
            <button onclick="openImportModal()" 
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                <i class="fas fa-file-upload icon-sm mr-2"></i>
                Import CSV
            </button>
            {% endif %}
            {% if features.ExportCSV %}
            <button onclick="exportToCSV()" 
                    class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                <i class="fas fa-file-download icon-sm mr-2"></i>
                Export CSV
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Data Table -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        {% if features.Search %}
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1 relative">
                    <!-- Magnifying glass icon -->
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search icon-sm text-gray-400"></i>
                    </div>
                    <input type="text" 
                           id="searchInput"
                           placeholder="Search by name, login, email, group..."
                           value="{{ currentFilters.search|default:'' }}"
                           onkeyup="filterTable()"
                           class="w-full pl-10 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
                    <!-- Clear button (X icon) -->
                    <button id="clearSearchBtn"
                            onclick="clearSearch()"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                            style="display: none;">
                        <i class="fas fa-times icon-sm"></i>
                    </button>
                </div>
                <div class="flex gap-2 flex-wrap">
                    {% if module.Name == "state" or module.Name == "users" or module.Name == "queue" %}
                    <!-- Quick filter presets -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 text-sm flex items-center gap-1">
                            <i class="fas fa-filter icon-sm"></i>
                            Quick Filters
                            <i class="fas fa-chevron-down icon-xs"></i>
                        </button>
                        <div x-show="open" @click.away="open = false" 
                             class="absolute z-10 mt-1 bg-white dark:bg-gray-800 rounded-md shadow-lg min-w-[150px]">
                            {% if module.Name == "state" %}
                            <button onclick="applyQuickFilter('active')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Active States
                            </button>
                            <button onclick="applyQuickFilter('open')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Open States
                            </button>
                            <button onclick="applyQuickFilter('closed')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Closed States
                            </button>
                            <button onclick="applyQuickFilter('pending')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Pending States
                            </button>
                            {% elif module.Name == "users" %}
                            <button onclick="applyQuickFilter('active_users')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Active Users
                            </button>
                            <button onclick="applyQuickFilter('inactive_users')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Inactive Users
                            </button>
                            <button onclick="applyQuickFilter('agents')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Agents Only
                            </button>
                            {% elif module.Name == "queue" %}
                            <button onclick="applyQuickFilter('active_queues')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Active Queues
                            </button>
                            <button onclick="applyQuickFilter('email_queues')" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Email Queues
                            </button>
                            {% endif %}
                            <hr class="my-1 border-gray-200 dark:border-gray-700">
                            <button onclick="clearAllFilters()" 
                                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                Clear All
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Saved Filter Sets -->
                    <div class="relative">
                        <button onclick="toggleSavedFiltersMenu()" 
                                class="flex items-center gap-2 px-3 py-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-md hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                            </svg>
                            Saved Filters
                        </button>
                        <div id="savedFiltersMenu" class="hidden absolute left-0 mt-2 w-72 bg-white dark:bg-gray-800 rounded-md shadow-lg z-10 border border-gray-200 dark:border-gray-700">
                            <div class="p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Saved Filter Sets</h3>
                                    <button onclick="saveCurrentFilters()" 
                                            class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                        Save Current
                                    </button>
                                </div>
                                
                                <!-- Saved filters list -->
                                <div id="savedFiltersList" class="space-y-2 max-h-64 overflow-y-auto mb-3">
                                    <!-- Saved filters will be populated here -->
                                </div>
                                
                                <!-- Save new filter form -->
                                <div id="saveFilterForm" class="hidden border-t border-gray-200 dark:border-gray-700 pt-3">
                                    <input type="text" 
                                           id="filterSetName"
                                           placeholder="Enter filter set name..." 
                                           class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded dark:bg-gray-700 dark:text-white mb-2">
                                    <div class="flex gap-2">
                                        <button onclick="confirmSaveFilters()" 
                                                class="flex-1 px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">
                                            Save
                                        </button>
                                        <button onclick="cancelSaveFilters()" 
                                                class="flex-1 px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="pt-3 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400">
                                    <div class="flex items-center justify-between">
                                        <span id="filterSetCount">0 saved filter sets</span>
                                        <button onclick="clearAllFilterSets()" 
                                                class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300">
                                            Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Column Visibility Toggle -->
                    <div class="relative">
                        <button onclick="toggleColumnMenu()" 
                                class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Columns
                        </button>
                        <div id="columnMenu" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-md shadow-lg z-10 border border-gray-200 dark:border-gray-700">
                            <div class="p-3">
                                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Show/Hide Columns</h3>
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    {% for field in fields %}
                                    {% if field.ShowInList %}
                                    <label class="flex items-center">
                                        <input type="checkbox" 
                                               class="column-toggle rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500"
                                               data-column="{{ field.Name }}"
                                               checked
                                               onchange="toggleColumn('{{ field.Name }}')">
                                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ field.Label }}</span>
                                    </label>
                                    {% endif %}
                                    {% endfor %}
                                    {% for field in computedFields %}
                                    {% if field.ShowInList %}
                                    <label class="flex items-center">
                                        <input type="checkbox" 
                                               class="column-toggle rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500"
                                               data-column="{{ field.Name }}"
                                               checked
                                               onchange="toggleColumn('{{ field.Name }}')">
                                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ field.Label }}</span>
                                    </label>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 flex gap-2">
                                    <button onclick="showAllColumns()" 
                                            class="flex-1 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                        Show All
                                    </button>
                                    <button onclick="hideAllColumns()" 
                                            class="flex-1 px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600">
                                        Hide All
                                    </button>
                                    <button onclick="resetColumns()" 
                                            class="flex-1 px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">
                                        Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if filters %}
                        {% for filter in filters %}
                        {% if filter.Type == "date_range" %}
                            <!-- Date range filter -->
                            <div class="flex gap-1 items-center">
                                <label class="text-xs text-gray-600 dark:text-gray-400">{{ filter.Label }}:</label>
                                {% set from_key = "filter_" + filter.Field + "_from" %}
                                {% set to_key = "filter_" + filter.Field + "_to" %}
                                <input type="date" 
                                       id="{{ filter.Field }}FilterFrom"
                                       value="{{ currentFilters[from_key]|default:'' }}"
                                       onchange="filterTable()"
                                       class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
                                <span class="text-xs text-gray-600 dark:text-gray-400">to</span>
                                <input type="date" 
                                       id="{{ filter.Field }}FilterTo"
                                       value="{{ currentFilters[to_key]|default:'' }}"
                                       onchange="filterTable()"
                                       class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
                            </div>
                        {% elif filter.Type == "multi_select" %}
                            <!-- Multi-select filter -->
                            {% set filter_key = "filter_" + filter.Field %}
                            {% set current_value = currentFilters[filter_key]|default:"" %}
                            <select id="{{ filter.Field|lower }}Filter" 
                                    multiple
                                    onchange="filterTable()" 
                                    class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm min-w-[150px]">
                                {% if filter.Options %}
                                    {% for option in filter.Options %}
                                    <option value="{{ option.Value }}" {% if option.Value in current_value %}selected{% endif %}>{{ option.Label }}</option>
                                    {% endfor %}
                                {% else %}
                                    <!-- Options will be populated from database if source is 'database' -->
                                {% endif %}
                            </select>
                        {% else %}
                            <!-- Regular select filter -->
                            {% set filter_key = "filter_" + filter.Field %}
                            {% set current_value = currentFilters[filter_key]|default:"" %}
                            <select id="{{ filter.Field|lower }}Filter" 
                                    onchange="filterTable()" 
                                    class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
                                {% if filter.Options %}
                                    {% for option in filter.Options %}
                                    <option value="{{ option.Value }}" {% if option.Value == current_value or (option.Value == "" and current_value == "") %}selected{% endif %}>{{ option.Label }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="">All {{ filter.Label }}</option>
                                    <!-- Options will be populated from database if source is 'database' -->
                                {% endif %}
                            </select>
                        {% endif %}
                        {% endfor %}
                    {% elif module.Name == "users" %}
                    <!-- Fallback for users module if no filters defined -->
                    <select id="statusFilter" onchange="filterTable()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
                        <option value="">All Status</option>
                        <option value="1">Active</option>
                        <option value="2">Inactive</option>
                    </select>
                    <select id="groupFilter" onchange="filterTable()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white text-sm">
                        <option value="">All Groups</option>
                        <!-- Groups will be populated dynamically -->
                    </select>
                    {% endif %}
                </div>
                <span class="text-sm text-gray-600 dark:text-gray-400 self-center">
                    <span id="filteredCount">{{ items|length }}</span> items
                </span>
            </div>
        </div>
        {% endif %}
        
        <div class="overflow-x-auto">
            <table id="dataTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-3 py-3 text-left">
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" 
                                   class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500">
                        </th>
                        {% if allFields %}
                            {% for field in allFields %}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                {{ field.Label }}
                            </th>
                            {% endfor %}
                        {% else %}
                            {% for field in fields %}
                            {% if field.ShowInList %}
                            <th data-column="{{ field.Name }}" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider column-header">
                                {{ field.Label }}
                            </th>
                            {% endif %}
                            {% endfor %}
                            {% for field in computedFields %}
                            {% if field.ShowInList %}
                            <th data-column="{{ field.Name }}" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider column-header">
                                {{ field.Label }}
                            </th>
                            {% endif %}
                            {% endfor %}
                            {% if module.Name == "users" %}
                            <th data-column="groups" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider column-header">
                                Groups
                            </th>
                            {% endif %}
                        {% endif %}
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for item in items %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors {% if module.Name == 'mail_account' %}cursor-pointer{% endif %}" 
                        data-id="{{ item.id }}" 
                        data-valid_id="{{ item.valid_id|default:'1' }}"
                        data-group_id="{{ item.group_id|default:'' }}"
                        {% if module.Name == 'mail_account' %}onclick="handleMailAccountRowSelect('{{ item.id }}', this, event)"{% endif %}>
                        <td class="px-3 py-4">
                            <input type="checkbox" class="item-checkbox rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" 
                                   value="{{ item.id }}" onchange="updateBulkActions()">
                        </td>
                        {% if allFields %}
                            {% for field in allFields %}
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                {% set chip_key = field.Name + "_chip" %}
                                {% set display_key = field.Name + "_display" %}
                                {% set chip_type = field.Name + "_chip_type" %}
                                {% if item[chip_key] %}
                                    <!-- Display as chip if configured -->
                                    {% if field.Name == "group_id" %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-100">
                                        {{ item[display_key]|default:item[field.Name] }}
                                    </span>
                                    {% elif field.Name == "valid_id" %}
                                    {% if item[field.Name] == 1 %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        {{ item[display_key]|default:"Valid" }}
                                    </span>
                                    {% else %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                                        {{ item[display_key]|default:"Invalid" }}
                                    </span>
                                    {% endif %}
                                    {% else %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        {{ item[display_key]|default:item[field.Name] }}
                                    </span>
                                    {% endif %}
                                {% elif field.Name == "valid_id" %}
                                    {% if item[field.Name] == 1 %}
                                    <span class="status-badge px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Active</span>
                                    {% else %}
                                    <span class="status-badge px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">Inactive</span>
                                    {% endif %}
                                {% elif field.Type == "password" %}
                                    <span class="text-gray-400 dark:text-gray-500">••••••••</span>
                                {% elif field.Type == "color" %}
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded" style="background-color: {{ item[field.Name] }}"></div>
                                        <span class="ml-2">{{ item[field.Name] }}</span>
                                    </div>
                                {% elif field.Name == "group_names" %}
                                    {% if item.Groups %}
                                    <div class="flex flex-wrap gap-1">
                                        {% for group in item.Groups %}
                                        <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">{{ group }}</span>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                {% elif field.Type == "datetime" %}
                                    <span class="datetime-field" data-utc="{{ item[field.Name] }}">{{ item[field.Name]|default:"-" }}</span>
                                {% elif field.Lambda %}
                                    {{ item[field.Name]|default:"-"|safe }}
                                {% else %}
                                    {% if field.Type == "string" and field.Name != "id" and field.Name != "login" %}
                                    <div class="inline-edit-container">
                                        <span class="inline-edit-display" 
                                              data-field="{{ field.Name }}" 
                                              data-item-id="{{ item.id }}"
                                              data-value="{{ item[field.Name]|default:'' }}"
                                              ondblclick="startInlineEdit(this)">
                                            {{ item[field.Name]|default:"-" }}
                                        </span>
                                        <input type="text" 
                                               class="inline-edit-input hidden px-2 py-1 border border-blue-400 rounded text-sm dark:bg-gray-700 dark:text-white"
                                               value="{{ item[field.Name]|default:'' }}"
                                               onblur="saveInlineEdit(this)"
                                               onkeydown="handleInlineEditKey(event, this)">
                                    </div>
                                    {% else %}
                                    {{ item[field.Name]|default:"-" }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        {% else %}
                            {% for field in fields %}
                            {% if field.ShowInList %}
                            <td data-column="{{ field.Name }}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100 column-cell">
                                {% set chip_key = field.Name + "_chip" %}
                                {% set display_key = field.Name + "_display" %}
                                {% set chip_type = field.Name + "_chip_type" %}
                                {% if item[chip_key] %}
                                    <!-- Display as chip if configured -->
                                    {% if field.Name == "group_id" %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-100">
                                        {{ item[display_key]|default:item[field.Name] }}
                                    </span>
                                    {% elif field.Name == "valid_id" %}
                                    {% if item[field.Name] == 1 %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        {{ item[display_key]|default:"Valid" }}
                                    </span>
                                    {% else %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                                        {{ item[display_key]|default:"Invalid" }}
                                    </span>
                                    {% endif %}
                                    {% else %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        {{ item[display_key]|default:item[field.Name] }}
                                    </span>
                                    {% endif %}
                                {% elif field.Name == "valid_id" %}
                                    {% if item[field.Name] == 1 %}
                                    <span class="status-badge px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Active</span>
                                    {% else %}
                                    <span class="status-badge px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">Inactive</span>
                                    {% endif %}
                                {% elif field.Type == "password" %}
                                    <span class="text-gray-400 dark:text-gray-500">••••••••</span>
                                {% elif field.Type == "color" %}
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded" style="background-color: {{ item[field.Name] }}"></div>
                                        <span class="ml-2">{{ item[field.Name] }}</span>
                                    </div>
                                {% elif field.Type == "datetime" %}
                                    <span class="datetime-field" data-utc="{{ item[field.Name] }}">{{ item[field.Name]|default:"-" }}</span>
                                {% elif field.Lambda %}
                                    {{ item[field.Name]|default:"-"|safe }}
                                {% else %}
                                    {% if field.Type == "string" and field.Name != "id" and field.Name != "login" %}
                                    <div class="inline-edit-container">
                                        <span class="inline-edit-display" 
                                              data-field="{{ field.Name }}" 
                                              data-item-id="{{ item.id }}"
                                              data-value="{{ item[field.Name]|default:'' }}"
                                              ondblclick="startInlineEdit(this)">
                                            {{ item[field.Name]|default:"-" }}
                                        </span>
                                        <input type="text" 
                                               class="inline-edit-input hidden px-2 py-1 border border-blue-400 rounded text-sm dark:bg-gray-700 dark:text-white"
                                               value="{{ item[field.Name]|default:'' }}"
                                               onblur="saveInlineEdit(this)"
                                               onkeydown="handleInlineEditKey(event, this)">
                                    </div>
                                    {% else %}
                                    {{ item[field.Name]|default:"-" }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% endif %}
                            {% endfor %}
                            {% for field in computedFields %}
                            {% if field.ShowInList %}
                            <td data-column="{{ field.Name }}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100 column-cell">
                                {{ item[field.Name]|default:"-"|safe }}
                            </td>
                            {% endif %}
                            {% endfor %}
                            {% if module.Name == "users" %}
                            <td data-column="groups" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100 column-cell">
                                {% if item.Groups %}
                                <div class="flex flex-wrap gap-1">
                                    {% for group in item.Groups %}
                                    <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">{{ group }}</span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            {% endif %}
                        {% endif %}
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editItem('{{ item.id }}')" 
                                    title="Edit"
                                    class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-2">
                                <i class="fas fa-edit icon-sm"></i>
                            </button>
                            {% if features.SoftDelete %}
                                {% if item.valid_id == 1 %}
                                <button onclick="toggleStatus('{{ item.id }}', '{{ item.valid_id }}')" 
                                        title="Disable"
                                        class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300">
                                    <i class="fas fa-times-circle icon-sm"></i>
                                </button>
                                {% else %}
                                <button onclick="toggleStatus('{{ item.id }}', '{{ item.valid_id }}')" 
                                        title="Enable"
                                        class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                                    <i class="fas fa-check-circle icon-sm"></i>
                                </button>
                                {% endif %}
                            {% else %}
                                <button onclick="deleteItem('{{ item.id }}')" 
                                        title="Delete"
                                        class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                    <i class="fas fa-trash icon-sm"></i>
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="100%" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            No data available
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if module.Name == "mail_account" %}
        {% set mailStatusStatusLabel = t("admin.modules.mail_account.status.status") %}
        {% set mailStatusLastPollLabel = t("admin.modules.mail_account.status.last_poll") %}
        {% set mailStatusMessagesLabel = t("admin.modules.mail_account.status.messages_fetched") %}
        {% set mailStatusNextPollLabel = t("admin.modules.mail_account.status.next_poll") %}
        <div id="mailStatusPane" class="hidden mt-4 rounded border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 p-3">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusStatusLabel == "admin.modules.mail_account.status.status" %}Status{% else %}{{ mailStatusStatusLabel }}{% endif %}</div>
                    <div id="mailStatusPaneBadge" class="text-sm font-semibold text-gray-900 dark:text-gray-50">--</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusLastPollLabel == "admin.modules.mail_account.status.last_poll" %}Last poll{% else %}{{ mailStatusLastPollLabel }}{% endif %}</div>
                    <div id="mailStatusPaneLastPoll" class="text-sm text-gray-900 dark:text-gray-50">--</div>
                </div>
            </div>
            <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                <div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusMessagesLabel == "admin.modules.mail_account.status.messages_fetched" %}Messages fetched{% else %}{{ mailStatusMessagesLabel }}{% endif %}</div>
                    <div id="mailStatusPaneMessages" class="text-gray-900 dark:text-gray-50">--</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusNextPollLabel == "admin.modules.mail_account.status.next_poll" %}Next poll{% else %}{{ mailStatusNextPollLabel }}{% endif %}</div>
                    <div id="mailStatusPaneNextPoll" class="text-gray-900 dark:text-gray-50">--</div>
                </div>
            </div>
            <div class="mt-2 text-xs text-red-600 dark:text-red-400" id="mailStatusPaneError"></div>
            <div class="mt-1 text-xs text-amber-600 dark:text-amber-400" id="mailStatusPaneStale"></div>
        </div>
        {% endif %}

        <!-- Pagination -->
        {% if pagination and pagination.totalPages > 1 %}
        <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    Showing 
                    <span class="font-medium">{{ (pagination.page - 1) * pagination.pageSize + 1 }}</span>
                    to 
                    <span class="font-medium">{{ (pagination.page - 1) * pagination.pageSize + items|length }}</span>
                    of 
                    <span class="font-medium">{{ pagination.totalCount }}</span>
                    results
                </div>
                
                <!-- Page size selector -->
                <div class="flex items-center gap-2">
                    <label for="pageSize" class="text-sm text-gray-700 dark:text-gray-300">{{ t("admin.common.pagination.show") }}</label>
                    <select id="pageSize" onchange="changePageSize(this.value)" 
                            class="px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="10" {% if pagination.pageSize == 10 %}selected{% endif %}>10</option>
                        <option value="25" {% if pagination.pageSize == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if pagination.pageSize == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if pagination.pageSize == 100 %}selected{% endif %}>100</option>
                    </select>
                    <span class="text-sm text-gray-700 dark:text-gray-300">{{ t("admin.common.pagination.per_page") }}</span>
                </div>
            </div>
            
            <div class="flex items-center gap-1">
                <!-- Previous button -->
                {% if pagination.hasPrev %}
                <button onclick="goToPage({{ pagination.page - 1 }})" 
                        class="px-3 py-1 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-l-md hover:bg-gray-50 dark:hover:bg-gray-600">
                    {{ t("admin.common.pagination.previous") }}
                </button>
                {% else %}
                <button disabled 
                        class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-500 border border-gray-300 dark:border-gray-600 rounded-l-md cursor-not-allowed">
                    {{ t("admin.common.pagination.previous") }}
                </button>
                {% endif %}
                
                <!-- Page numbers -->
                {% for pageNum in pagination.pageRange %}
                    {% if pageNum == pagination.page %}
                    <button class="px-3 py-1 text-sm bg-blue-500 text-white border border-blue-500">
                        {{ pageNum }}
                    </button>
                    {% else %}
                    <button onclick="goToPage({{ pageNum }})" 
                            class="px-3 py-1 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600">
                        {{ pageNum }}
                    </button>
                    {% endif %}
                {% endfor %}
                
                <!-- Next button -->
                {% if pagination.hasNext %}
                <button onclick="goToPage({{ pagination.page + 1 }})" 
                        class="px-3 py-1 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-r-md hover:bg-gray-50 dark:hover:bg-gray-600">
                    {{ t("admin.common.pagination.next") }}
                </button>
                {% else %}
                <button disabled 
                        class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-500 border border-gray-300 dark:border-gray-600 rounded-r-md cursor-not-allowed">
                    {{ t("admin.common.pagination.next") }}
                </button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="moduleModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="moduleForm" onsubmit="saveItem(event)">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100 mb-4">
                        New {{ module.Singular }}
                    </h3>
                    {% if module.Name == "mail_account" %}
                    <div id="mailStatusCard" class="hidden mb-4 rounded border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 p-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusStatusLabel == "admin.modules.mail_account.status.status" %}Status{% else %}{{ mailStatusStatusLabel }}{% endif %}</div>
                                <div id="mailStatusBadge" class="text-sm font-semibold text-gray-900 dark:text-gray-50">--</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusLastPollLabel == "admin.modules.mail_account.status.last_poll" %}Last poll{% else %}{{ mailStatusLastPollLabel }}{% endif %}</div>
                                <div id="mailStatusLastPoll" class="text-sm text-gray-900 dark:text-gray-50">--</div>
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusMessagesLabel == "admin.modules.mail_account.status.messages_fetched" %}Messages fetched{% else %}{{ mailStatusMessagesLabel }}{% endif %}</div>
                                <div id="mailStatusMessages" class="text-gray-900 dark:text-gray-50">--</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 dark:text-gray-400">{% if mailStatusNextPollLabel == "admin.modules.mail_account.status.next_poll" %}Next poll{% else %}{{ mailStatusNextPollLabel }}{% endif %}</div>
                                <div id="mailStatusNextPoll" class="text-gray-900 dark:text-gray-50">--</div>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-red-600 dark:text-red-400" id="mailStatusError"></div>
                        <div class="mt-1 text-xs text-amber-600 dark:text-amber-400" id="mailStatusStale"></div>
                    </div>
                    {% endif %}
                    <div class="mt-4 space-y-4">
                        {% for field in fields %}
                        {% if field.ShowInForm %}
                        <div id="field_{{ field.Name }}" data-field-name="{{ field.Name }}">
                            <label for="{{ field.Name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ field.Label }}
                                {% if field.Required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            {% set help_inline = false %}
                            {% if field.Type == "text" or field.Type == "textarea" or field.Type == "notes" %}
                                <textarea id="{{ field.Name }}" name="{{ field.Name }}" rows="{{ field.Rows|default:3 }}" {% if field.Required %}required{% endif %}
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm"
                                    placeholder="{{ field.Placeholder|default:'' }}"></textarea>
                            {% elif field.Type == "select" %}
                                {% if field.Widget == "typeahead" %}
                                    <div class="mt-1" data-typeahead="true" data-field="{{ field.Name }}">
                                        <input type="hidden" id="{{ field.Name }}" name="{{ field.Name }}" value="{{ field.Default|default:'' }}" {% if field.Required %}required{% endif %}>
                                        <input type="text" id="{{ field.Name }}_typeahead" list="{{ field.Name }}_options"
                                            placeholder="{{ field.Placeholder|default:'Start typing to search' }}"
                                            class="block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                                        <datalist id="{{ field.Name }}_options">
                                            {% for option in field.Options %}
                                            <option value="{{ option.Label }}" data-value="{{ option.Value }}"></option>
                                            {% endfor %}
                                        </datalist>
                                    </div>
                                {% else %}
                                    {% set current_group = "" %}
                                    <select id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                        class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                                        <option value="">-- Select --</option>
                                        {% for option in field.Options %}
                                            {% if option.Group %}
                                                {% if option.Group != current_group %}
                                                    {% if current_group != "" %}</optgroup>{% endif %}
                                                    <optgroup label="{{ option.Group }}">
                                                    {% set current_group = option.Group %}
                                                {% endif %}
                                            {% elif current_group != "" %}
                                                </optgroup>
                                                {% set current_group = "" %}
                                            {% endif %}
                                            <option value="{{ option.Value }}">{{ option.Label }}</option>
                                        {% endfor %}
                                        {% if current_group != "" %}</optgroup>{% endif %}
                                    </select>
                                {% endif %}
                            {% elif field.Type == "color" %}
                                <input type="color" id="{{ field.Name }}" name="{{ field.Name }}" value="{{ field.Default|default:'#000000' }}"
                                    class="mt-1 block h-10 w-20 border-gray-300 dark:border-gray-600 rounded-md shadow-sm">
                            {% elif field.Type == "password" %}
                                <div class="relative">
                                    <input type="password" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                        placeholder="{{ field.Placeholder|default:'' }}"
                                        class="mt-1 block w-full pr-10 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                                    <button type="button" onclick="togglePassword('{{ field.Name }}')" 
                                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                        <i id="{{ field.Name }}_eye_toggle" class="fas fa-eye icon-sm"></i>
                                    </button>
                                </div>
                            {% elif field.Type == "radio" %}
                                <div class="mt-1 space-y-2">
                                    {% for option in field.Options %}
                                    <label class="inline-flex items-center mr-4">
                                        <input type="radio" id="{{ field.Name }}_{{ option.Value }}" name="{{ field.Name }}" value="{{ option.Value }}" {% if field.Required %}required{% endif %}
                                            class="rounded-full border-gray-300 dark:border-gray-600 text-blue-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{{ option.Label }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            {% elif field.Type == "file" %}
                                <input type="file" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    {% if field.Accept %}accept="{{ field.Accept }}"{% endif %}
                                    {% if field.Multiple %}multiple{% endif %}
                                    class="mt-1 block w-full text-sm text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-md cursor-pointer focus:outline-none focus:border-blue-500 dark:bg-gray-700">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ field.Help|default:"Max file size: 10MB" }}</p>
                            {% elif field.Type == "files" or field.Type == "filelist" %}
                                <div class="mt-1">
                                    <input type="file" id="{{ field.Name }}" name="{{ field.Name }}[]" multiple {% if field.Required %}required{% endif %}
                                        {% if field.Accept %}accept="{{ field.Accept }}"{% endif %}
                                        class="block w-full text-sm text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-md cursor-pointer focus:outline-none focus:border-blue-500 dark:bg-gray-700">
                                    <div id="{{ field.Name }}_list" class="mt-2 space-y-1"></div>
                                </div>
                            {% elif field.Type == "date" %}
                                <input type="date" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    min="{{ field.Min|default:'' }}" max="{{ field.Max|default:'' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% elif field.Type == "datetime" or field.Type == "datetime-local" %}
                                <input type="datetime-local" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    min="{{ field.Min|default:'' }}" max="{{ field.Max|default:'' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% elif field.Type == "time" %}
                                <input type="time" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% elif field.Type == "email" %}
                                <input type="email" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    placeholder="{{ field.Placeholder|default:'user@example.com' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% elif field.Type == "url" %}
                                <input type="url" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    placeholder="{{ field.Placeholder|default:'https://example.com' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% elif field.Type == "tel" or field.Type == "phone" %}
                                <input type="tel" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    pattern="{{ field.Pattern|default:'[0-9]{3}-[0-9]{3}-[0-9]{4}' }}"
                                    placeholder="{{ field.Placeholder|default:'123-456-7890' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% elif field.Type == "range" %}
                                <div class="mt-1">
                                    <input type="range" id="{{ field.Name }}" name="{{ field.Name }}"
                                        min="{{ field.Min|default:0 }}" max="{{ field.Max|default:100 }}" step="{{ field.Step|default:1 }}"
                                        value="{{ field.Default|default:50 }}"
                                        oninput="document.getElementById('{{ field.Name }}_value').textContent = this.value"
                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                                    <span id="{{ field.Name }}_value" class="text-sm text-gray-600 dark:text-gray-400">{{ field.Default|default:50 }}</span>
                                </div>
                            {% elif field.Type == "bool" or field.Type == "boolean" or field.Type == "checkbox" %}
                                {% if field.Name == "allow_trusted_headers" %}
                                    {% set help_inline = true %}
                                    <div class="mt-2 flex items-center justify-between gap-3">
                                        <span class="text-sm text-gray-700 dark:text-gray-300">{{ field.Help|default:"Accept queue overrides from X-Znuny-Dest / X-GOTRS headers for this mailbox." }}</span>
                                        <input type="checkbox" id="{{ field.Name }}" name="{{ field.Name }}" value="1"
                                            class="h-5 w-5 rounded border-gray-300 dark:border-gray-600 text-blue-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                                    </div>
                                {% else %}
                                    <input type="checkbox" id="{{ field.Name }}" name="{{ field.Name }}" value="1"
                                        class="mt-1 rounded border-gray-300 dark:border-gray-600 text-blue-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                                {% endif %}
                            {% elif field.Type == "int" or field.Type == "integer" or field.Type == "number" %}
                                <input type="number" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    min="{{ field.Min|default:'' }}" max="{{ field.Max|default:'' }}" step="{{ field.Step|default:1 }}"
                                    placeholder="{{ field.Placeholder|default:'' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% elif field.Type == "float" or field.Type == "decimal" %}
                                <input type="number" id="{{ field.Name }}" name="{{ field.Name }}" step="0.01" {% if field.Required %}required{% endif %}
                                    min="{{ field.Min|default:'' }}" max="{{ field.Max|default:'' }}"
                                    placeholder="{{ field.Placeholder|default:'' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% else %}
                                <input type="text" id="{{ field.Name }}" name="{{ field.Name }}" {% if field.Required %}required{% endif %}
                                    placeholder="{{ field.Placeholder|default:'' }}"
                                    class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                            {% endif %}
                            {% if field.Help and not help_inline %}
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ field.Help }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                        
                        {% if module.Name == "users" %}
                        <!-- Groups assignment for users -->
                        <div>
                            <label for="groups" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Groups
                            </label>
                            <select id="groups" name="groups" multiple size="6"
                                class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm">
                                <!-- Groups will be populated dynamically -->
                            </select>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Hold Ctrl/Cmd to select multiple groups</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Save
                    </button>
                    <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div id="confirmIcon" class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 dark:bg-yellow-900 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle icon-lg text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 id="confirmTitle" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
                            Confirm Action
                        </h3>
                        <div class="mt-2">
                            <p id="confirmMessage" class="text-sm text-gray-500 dark:text-gray-400">
                                Are you sure you want to proceed with this action?
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Confirm
                </button>
                <button type="button" onclick="closeConfirmModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamic module configuration passed from server  
var moduleConfig;
try {
    moduleConfig = JSON.parse('{{ config_json|escapejs }}');
} catch (e) {
    console.error('Failed to parse module config:', e);
    moduleConfig = {};
}
var moduleName = '{{ module.Name }}';
// Support both /admin/users and /admin/dynamic/users paths
var currentPath = window.location.pathname;
var API_BASE = currentPath.includes('/dynamic/') ? '/admin/dynamic/' + moduleName : '/admin/' + moduleName;
// Friendly alias for mail accounts uses a hyphenated path; align API_BASE so fetch hits the routed alias
if (moduleName === 'mail_account' && currentPath.includes('/mail-accounts')) {
    API_BASE = '/admin/mail-accounts';
}
var currentEditId = null;

// Mail status labels with fallback to plain English when translation keys leak through
const mailStatusLabels = {
    ok: '{{ t("admin.modules.mail_account.status.ok") }}',
    error: '{{ t("admin.modules.mail_account.status.error") }}',
    no_data: '{{ t("admin.modules.mail_account.status.no_data") }}',
    stale: '{{ t("admin.modules.mail_account.status.stale") }}',
    unavailable: '{{ t("admin.modules.mail_account.status.unavailable") }}'
};
const mailStatusFallbacks = {
    ok: 'OK',
    error: 'Error',
    no_data: 'No poll yet',
    stale: 'No recent poll',
    unavailable: 'Status unavailable'
};
function translateMailStatusLabel(key) {
    const val = mailStatusLabels[key];
    if (!val) return mailStatusFallbacks[key] || key;
    if (val.indexOf('admin.modules.mail_account.status') === 0) {
        return mailStatusFallbacks[key] || key;
    }
    return val;
}

function showGuruFromPayload(status, data, task) {
    if (typeof showGuruMeditation !== 'function') {
        return;
    }
    const code = `0000${('0000' + status).slice(-4)}.HTTPERR0`;
    const details = { task: task || moduleName.toUpperCase(), location: currentPath };
    if (data && data.guru_meditation) {
        showGuruMeditation(
            data.guru_meditation.code || code,
            data.guru_meditation.message || data.error || data.message || `HTTP ${status} ERROR`,
            {
                task: data.guru_meditation.task || details.task,
                location: data.guru_meditation.location || details.location
            }
        );
        return;
    }
    const message = data && (data.error || data.message) ? data.error || data.message : `HTTP ${status} ERROR`;
    showGuruMeditation(code, message, details);
}

// Debug logging
console.log('Module Name:', moduleName);
console.log('Current Path:', currentPath);
console.log('API_BASE:', API_BASE);

function openCreateModal() {
    currentEditId = null;
    document.getElementById('modalTitle').textContent = 'New {{ module.Singular }}';
    document.getElementById('moduleForm').reset();
    if (moduleName === 'mail_account') {
        resetMailAccountStatus('modal');
    }
    if (moduleName === 'mail_account') {
        const accountSelect = document.getElementById('account_type');
        if (accountSelect && !accountSelect.value) {
            accountSelect.value = 'pop3';
        }
        const dispatchSelect = document.getElementById('dispatching_mode');
        if (dispatchSelect) {
            dispatchSelect.value = 'queue';
        }
        const pollInput = document.getElementById('poll_interval_seconds');
        if (pollInput) {
            pollInput.value = 600;
        }
        const validSelect = document.getElementById('valid_id');
        if (validSelect) {
            validSelect.value = '1';
        }
        setTypeaheadValue('queue_id', '');
        updateMailAccountFieldVisibility();
    }
    openModal();
}

function editItem(id) {
    currentEditId = id;
    document.getElementById('modalTitle').textContent = 'Edit {{ module.Singular }}';
    
    fetch(`${API_BASE}/${id}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        let data = null;
        try {
            data = await response.json();
        } catch (e) {}

        if (!response.ok) {
            showGuruFromPayload(response.status, data, `${moduleName.toUpperCase()}.GET`);
            showToast((data && (data.error || data.message)) || 'Failed to load item', 'error');
            return;
        }

        if (data && data.success) {
            // Populate form fields
            {% for field in fields %}
            {% if field.ShowInForm %}
            {% if field.Type == "password" %}
            // Password fields are not populated for security
            document.getElementById('{{ field.Name }}').value = '';
            document.getElementById('{{ field.Name }}').placeholder = 'Leave blank to keep existing';
            {% elif field.Type == "radio" %}
            // Handle radio buttons
            if (data.data['{{ field.Name }}'] !== undefined) {
                const radio = document.getElementById('{{ field.Name }}_' + data.data['{{ field.Name }}']);
                if (radio) radio.checked = true;
            }
            {% elif field.Type == "checkbox" or field.Type == "bool" or field.Type == "boolean" %}
            // Handle checkboxes
            if (data.data['{{ field.Name }}'] !== undefined) {
                document.getElementById('{{ field.Name }}').checked = !!data.data['{{ field.Name }}'];
            }
            {% elif field.Type == "file" or field.Type == "files" or field.Type == "filelist" %}
            // File fields cannot be pre-populated for security reasons
            {% elif field.Type == "range" %}
            // Handle range inputs
            if (data.data['{{ field.Name }}'] !== undefined) {
                document.getElementById('{{ field.Name }}').value = data.data['{{ field.Name }}'];
                document.getElementById('{{ field.Name }}_value').textContent = data.data['{{ field.Name }}'];
            }
            {% else %}
            // Handle all other input types
            if (data.data['{{ field.Name }}'] !== undefined) {
                document.getElementById('{{ field.Name }}').value = data.data['{{ field.Name }}'];
            }
            {% endif %}
            {% endif %}
            {% endfor %}
            
            // Handle groups for users module
            if (moduleName === 'users' && data.data.Groups) {
                // First load the groups, then select the user's groups
                loadGroups().then(() => {
                    const groupSelect = document.getElementById('groups');
                    if (groupSelect) {
                        // Select the user's groups
                        data.data.Groups.forEach(groupName => {
                            for (let option of groupSelect.options) {
                                if (option.textContent === groupName) {
                                    option.selected = true;
                                    break;
                                }
                            }
                        });
                    }
                });
            }
            
            if (moduleName === 'mail_account') {
                setTypeaheadValue('queue_id', data.data['queue_id']);
            }
            openModal();
            if (moduleName === 'mail_account') {
                updateMailAccountFieldVisibility();
                loadMailAccountStatus(id, 'modal');
            }
            return;
        }

        if (data) {
            showGuruFromPayload(response.status, data, `${moduleName.toUpperCase()}.GET`);
        }
        showToast((data && (data.error || data.message)) || 'Failed to load item', 'error');
    })
    .catch(err => {
        showGuruFromPayload(500, { error: err.message }, `${moduleName.toUpperCase()}.GET`);
        showToast('Failed to load item', 'error');
    });
}

function saveItem(event) {
    event.preventDefault();
    syncAllTypeaheadFields();
    
    const formData = new FormData(document.getElementById('moduleForm'));
    const url = currentEditId ? `${API_BASE}/${currentEditId}` : API_BASE;
    const method = currentEditId ? 'PUT' : 'POST';
    
    // Handle multi-select groups for users module
    if (moduleName === 'users') {
        const groupSelect = document.getElementById('groups');
        if (groupSelect) {
            // Remove any existing groups entries from formData
            formData.delete('groups');
            
            // Collect selected group IDs
            const selectedGroups = [];
            for (let option of groupSelect.options) {
                if (option.selected) {
                    selectedGroups.push(option.value);
                }
            }
            
            // Add as comma-separated string
            if (selectedGroups.length > 0) {
                formData.append('groups', selectedGroups.join(','));
            }
        }
    }
    
    fetch(url, {
        method: method,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams(formData)
    })
    .then(async response => {
        let data = null;
        try {
            data = await response.json();
        } catch (e) {}

        if (!response.ok) {
            showGuruFromPayload(response.status, data, `${moduleName.toUpperCase()}.${method}`);
            showToast((data && (data.error || data.message)) || 'An error occurred', 'error');
            return;
        }

        if (data && data.success) {
            closeModal();
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
            return;
        }

        if (data) {
            showGuruFromPayload(response.status, data, `${moduleName.toUpperCase()}.${method}`);
        }
        showToast((data && (data.error || data.message)) || 'An error occurred', 'error');
    })
    .catch(err => {
        showGuruFromPayload(500, { error: err.message }, `${moduleName.toUpperCase()}.${method}`);
        showToast('An error occurred', 'error');
    });
}

// Confirmation modal functions
function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    
    const confirmBtn = document.getElementById('confirmButton');
    // Remove old event listeners by cloning the button
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.addEventListener('click', function() {
        closeConfirmModal();
        onConfirm();
    });
    
    document.getElementById('confirmModal').classList.remove('hidden');
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
}

function toggleStatus(id, currentStatus) {
    const newStatus = currentStatus == 1 ? 2 : 1;
    const action = newStatus == 1 ? 'activate' : 'deactivate';
    
    showConfirmModal(
        `${action.charAt(0).toUpperCase() + action.slice(1)} {{ module.Singular }}`,
        `Are you sure you want to ${action} this {{ module.Singular }}?`,
        function() {
        fetch(`${API_BASE}/${id}`, {
            method: 'PUT',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ valid_id: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`{{ module.Singular }} ${action}d successfully`, 'success');
                
                // Update the UI dynamically instead of reloading
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) {
                    // Update the status badge
                    const statusBadge = row.querySelector('.status-badge');
                    if (statusBadge) {
                        if (newStatus == 1) {
                            statusBadge.className = 'status-badge px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                            statusBadge.textContent = 'Active';
                        } else {
                            statusBadge.className = 'status-badge px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
                            statusBadge.textContent = 'Inactive';
                        }
                    }
                    
                    // Update the button
                    const toggleBtn = row.querySelector(`button[onclick*="toggleStatus(${id}"]`);
                    if (toggleBtn) {
                        toggleBtn.setAttribute('onclick', `toggleStatus(${id}, ${newStatus})`);
                        if (newStatus == 1) {
                            toggleBtn.className = 'text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300';
                            toggleBtn.title = 'Disable';
                            // Update the icon to X circle
                            const svg = toggleBtn.querySelector('svg path');
                            if (svg) {
                                svg.setAttribute('d', 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z');
                            }
                        } else {
                            toggleBtn.className = 'text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300';
                            toggleBtn.title = 'Enable';
                            // Update the icon to check circle
                            const svg = toggleBtn.querySelector('svg path');
                            if (svg) {
                                svg.setAttribute('d', 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z');
                            }
                        }
                    }
                    
                    // Store the new status in the row data attribute
                    row.setAttribute('data-status', newStatus);
                }
                
            }
        });
        }
    );
}

function deleteItem(id) {
    if (confirm('Are you sure you want to delete this {{ module.Singular }}?')) {
        fetch(`${API_BASE}/${id}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            }
        });
    }
}

function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = '';
        filterTable();
        updateClearButton();
    }
}

function updateClearButton() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    if (searchInput && clearBtn) {
        clearBtn.style.display = searchInput.value.length > 0 ? 'flex' : 'none';
    }
}

function filterTable() {
    // For server-side filtering, collect all filter values and reload page with parameters
    const url = new URL(window.location);
    
    // Clear existing filter parameters but preserve other URL params
    const params = new URLSearchParams(url.search);
    // Remove old filter parameters
    for (const key of [...params.keys()]) {
        if (key.startsWith('filter_') || key === 'search') {
            params.delete(key);
        }
    }
    
    // Add search parameter if present
    const searchInput = document.getElementById('searchInput');
    if (searchInput && searchInput.value.trim() !== '') {
        params.set('search', searchInput.value.trim());
    }
    
    // Add filter parameters from dynamic configuration
    if (moduleConfig.filters) {
        for (const filter of moduleConfig.filters) {
            if (filter.type === 'date_range') {
                // Handle date range filters
                const fromElement = document.getElementById(filter.field + 'FilterFrom');
                const toElement = document.getElementById(filter.field + 'FilterTo');
                if (fromElement && fromElement.value !== '') {
                    params.set('filter_' + filter.field + '_from', fromElement.value);
                }
                if (toElement && toElement.value !== '') {
                    params.set('filter_' + filter.field + '_to', toElement.value);
                }
            } else if (filter.type === 'multi_select') {
                // Handle multi-select filters
                const filterId = filter.field.toLowerCase() + 'Filter';
                const filterElement = document.getElementById(filterId);
                if (filterElement && filterElement.selectedOptions.length > 0) {
                    const values = Array.from(filterElement.selectedOptions).map(opt => opt.value);
                    if (values.length > 0 && values[0] !== '') {
                        params.set('filter_' + filter.field, values.join(','));
                    }
                }
            } else {
                // Handle regular filters
                const filterId = filter.field + 'Filter';
                const filterElement = document.getElementById(filterId);
                if (filterElement && filterElement.value !== '') {
                    params.set('filter_' + filter.field, filterElement.value);
                }
            }
        }
    }
    
    // Legacy support for users module
    if (moduleName === 'users') {
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter && statusFilter.value !== '') {
            params.set('filter_valid_id', statusFilter.value);
        }
        
        const groupFilter = document.getElementById('groupFilter');
        if (groupFilter && groupFilter.value !== '') {
            params.set('filter_group', groupFilter.value);
        }
    }
    
    // Reset to page 1 when filtering
    params.set('page', '1');
    
    // Update URL and reload page with filter parameters
    url.search = params.toString();
    window.location.href = url.toString();
}

// Pagination functions
function goToPage(pageNum) {
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    params.set('page', pageNum);
    url.search = params.toString();
    window.location.href = url.toString();
}

function changePageSize(size) {
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    params.set('page_size', size);
    params.set('page', '1'); // Reset to first page when changing page size
    url.search = params.toString();
    window.location.href = url.toString();
}

function openModal() {
    document.getElementById('moduleModal').classList.remove('hidden');
    
    // Load groups if this is the users module
    if (moduleName === 'users') {
        loadGroups();
    }
}

function loadGroups() {
    return apiFetch('/api/groups')
    .then(data => {
        const groupSelect = document.getElementById('groups');
        if (groupSelect && data.groups) {
            groupSelect.innerHTML = '';
            data.groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Failed to load groups:', error);
    });
}

function closeModal() {
    document.getElementById('moduleModal').classList.add('hidden');
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white shadow-lg transition-opacity duration-500 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

// Toggle password visibility
function togglePassword(fieldName) {
    const input = document.getElementById(fieldName);
    const eyeToggleIcon = document.getElementById(fieldName + '_eye_toggle');
    
    if (input.type === 'password') {
        input.type = 'text';
        if (eyeToggleIcon) {
            eyeToggleIcon.classList.remove('fa-eye');
            eyeToggleIcon.classList.add('fa-eye-slash');
        }
    } else {
        input.type = 'password';
        if (eyeToggleIcon) {
            eyeToggleIcon.classList.remove('fa-eye-slash');
            eyeToggleIcon.classList.add('fa-eye');
        }
    }
}

// Handle file list display
// Format datetime to local timezone
function formatLocalDateTime(utcDateStr) {
    if (!utcDateStr || utcDateStr === '-') return '-';
    
    try {
        // Parse the UTC date string
        const date = new Date(utcDateStr);
        
        // Check if date is valid
        if (isNaN(date.getTime())) return utcDateStr;
        
        // Format options for local timezone
        const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        };
        
        // Format to local timezone
        const localStr = date.toLocaleString(undefined, options);
        
        // Add relative time (e.g., "2 hours ago")
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        let relativeTime = '';
        if (diffDays > 365) {
            relativeTime = Math.floor(diffDays / 365) + ' year' + (Math.floor(diffDays / 365) > 1 ? 's' : '') + ' ago';
        } else if (diffDays > 30) {
            relativeTime = Math.floor(diffDays / 30) + ' month' + (Math.floor(diffDays / 30) > 1 ? 's' : '') + ' ago';
        } else if (diffDays > 0) {
            relativeTime = diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
        } else if (diffHours > 0) {
            relativeTime = diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
        } else if (diffMins > 0) {
            relativeTime = diffMins + ' minute' + (diffMins > 1 ? 's' : '') + ' ago';
        } else {
            relativeTime = 'just now';
        }
        
        // Return formatted string with tooltip showing relative time
        return `<span title="${relativeTime}">${localStr}</span>`;
    } catch (e) {
        console.error('Error formatting date:', e);
        return utcDateStr;
    }
}

// Apply datetime formatting to all datetime fields
function formatAllDateTimes() {
    document.querySelectorAll('.datetime-field').forEach(element => {
        const utcDate = element.getAttribute('data-utc');
        if (utcDate) {
            element.innerHTML = formatLocalDateTime(utcDate);
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Format all datetime fields to local timezone
    formatAllDateTimes();
    
    // Initialize clear button visibility
    updateClearButton();
    
    // Setup file list handlers
    document.querySelectorAll('input[type="file"][multiple]').forEach(input => {
        input.addEventListener('change', function() {
            const listId = this.id + '_list';
            const listEl = document.getElementById(listId);
            if (listEl) {
                listEl.innerHTML = '';
                Array.from(this.files).forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'text-sm text-gray-600 dark:text-gray-400';
                    div.innerHTML = `
                        <i class="fas fa-file icon-sm mr-1"></i>
                        ${file.name} (${formatFileSize(file.size)})
                    `;
                    listEl.appendChild(div);
                });
            }
        });
    });
    
    // Don't restore filter values from URL - they're already set server-side
    // restoreFiltersFromURL();
});

// Filter restoration is now handled server-side through template context
// The selected values are set directly in the HTML when the page renders

// Populate group filter on page load for users module
if (moduleName === 'users') {
    document.addEventListener('DOMContentLoaded', function() {
        populateGroupFilter();
    });
}

// Populate group filter dropdown
function populateGroupFilter() {
    apiFetch('/api/groups')
    .then(data => {
        const groupFilter = document.getElementById('groupFilter');
        if (groupFilter && data.groups) {
            // Keep the "All Groups" option
            groupFilter.innerHTML = '<option value="">All Groups</option>';
            data.groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.name.toLowerCase();
                option.textContent = group.name;
                groupFilter.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Failed to load groups for filter:', error);
    });
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// View configuration details function for sysconfig module  
function viewConfigDetails(configName) {
    // Show detailed information about a configuration setting
    fetch(`${API_BASE}/${encodeURIComponent(configName)}/details`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const details = data.data;
            const html = `
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">${details.name}</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Category:</strong> ${details.navigation || 'N/A'}</div>
                        <div><strong>Type:</strong> ${details.type || 'string'}</div>
                        <div><strong>Current Value:</strong> <code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">${details.effective_value || ''}</code></div>
                        <div><strong>Default Value:</strong> <code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">${details.default_value || details.effective_value || ''}</code></div>
                        <div class="col-span-2"><strong>Description:</strong> ${details.description || 'No description available'}</div>
                        ${details.validation ? `<div class="col-span-2"><strong>Validation:</strong> <code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">${details.validation}</code></div>` : ''}
                        <div><strong>User Modifiable:</strong> ${details.user_modification_possible ? 'Yes' : 'No'}</div>
                        <div><strong>Read Only:</strong> ${details.is_readonly ? 'Yes' : 'No'}</div>
                    </div>
                </div>
            `;
            
            showConfirmModal('Configuration Details', html, null);
        } else {
            showToast('Error loading configuration details: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error loading configuration details', 'error');
    });
}

// Reset configuration to default function for sysconfig module
function resetToDefault(configName) {
    showConfirmModal(
        'Reset Configuration', 
        `Are you sure you want to reset "${configName}" to its default value? This action cannot be undone.`,
        function() {
            fetch(`${API_BASE}/${encodeURIComponent(configName)}/reset`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Configuration reset to default successfully', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error resetting configuration: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error resetting configuration', 'error');
            });
        }
    );
}

// Export to CSV with current filters
function exportToCSV() {
    // Build URL with current filters
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    
    // Add export format parameter
    params.set('format', 'csv');
    
    // Create download URL
    const exportUrl = `${window.location.pathname}/export?${params.toString()}`;
    
    // Trigger download
    window.location.href = exportUrl;
}

// Apply quick filter presets
function applyQuickFilter(preset) {
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    
    // Clear existing filters
    for (const key of [...params.keys()]) {
        if (key.startsWith('filter_')) {
            params.delete(key);
        }
    }
    
    // Apply preset filters based on the selected preset
    switch(preset) {
        // State presets
        case 'active':
            params.set('filter_valid_id', '1');
            break;
        case 'open':
            params.set('filter_type_id', '2');
            params.set('filter_valid_id', '1');
            break;
        case 'closed':
            params.set('filter_type_id', '3,4'); // Both closed successful and unsuccessful
            params.set('filter_valid_id', '1');
            break;
        case 'pending':
            params.set('filter_type_id', '3');
            params.set('filter_valid_id', '1');
            break;
            
        // User presets
        case 'active_users':
            params.set('filter_valid_id', '1');
            break;
        case 'inactive_users':
            params.set('filter_valid_id', '2');
            break;
        case 'agents':
            params.set('filter_group_id', '1,2'); // Assuming groups 1 and 2 are agent groups
            params.set('filter_valid_id', '1');
            break;
            
        // Queue presets
        case 'active_queues':
            params.set('filter_valid_id', '1');
            break;
        case 'email_queues':
            params.set('search', 'email');
            params.set('filter_valid_id', '1');
            break;
    }
    
    // Apply the filters
    url.search = params.toString();
    window.location.href = url.toString();
}

// Clear all filters
function clearAllFilters() {
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    
    // Remove all filter parameters and search
    for (const key of [...params.keys()]) {
        if (key.startsWith('filter_') || key === 'search') {
            params.delete(key);
        }
    }
    
    url.search = params.toString();
    window.location.href = url.toString();
}

// Bulk actions functions
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateBulkActions();
}

function updateBulkActions() {
    const selected = document.querySelectorAll('.item-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selected.length > 0) {
        bulkActions.classList.remove('hidden');
        selectedCount.textContent = selected.length;
    } else {
        bulkActions.classList.add('hidden');
    }
    
    // Update select all checkbox state
    const selectAll = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    selectAll.checked = allCheckboxes.length > 0 && selected.length === allCheckboxes.length;
    selectAll.indeterminate = selected.length > 0 && selected.length < allCheckboxes.length;
}

function getSelectedIds() {
    const selected = document.querySelectorAll('.item-checkbox:checked');
    return Array.from(selected).map(cb => cb.value);
}

function bulkToggleStatus() {
    const ids = getSelectedIds();
    if (ids.length === 0) return;
    
    showConfirmModal(
        'Toggle Status',
        `Are you sure you want to toggle the status of ${ids.length} item(s)?`,
        function() {
            // Process each selected item
            Promise.all(ids.map(id => {
                return fetch(`${API_BASE}/${id}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        const newStatus = data.data.valid_id == 1 ? 2 : 1;
                        return fetch(`${API_BASE}/${id}`, {
                            method: 'PUT',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ valid_id: newStatus })
                        });
                    }
                });
            })).then(() => {
                showToast(`Status toggled for ${ids.length} item(s)`, 'success');
                setTimeout(() => location.reload(), 1000);
            }).catch(error => {
                showToast('Error toggling status', 'error');
            });
        }
    );
}

function bulkDelete() {
    const ids = getSelectedIds();
    if (ids.length === 0) return;
    
    showConfirmModal(
        'Delete Items',
        `Are you sure you want to delete ${ids.length} item(s)? This action cannot be undone.`,
        function() {
            Promise.all(ids.map(id => {
                return fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
            })).then(() => {
                showToast(`Deleted ${ids.length} item(s)`, 'success');
                setTimeout(() => location.reload(), 1000);
            }).catch(error => {
                showToast('Error deleting items', 'error');
            });
        }
    );
}

function exportSelected() {
    const ids = getSelectedIds();
    if (ids.length === 0) return;
    
    // Build URL with selected IDs
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    params.set('format', 'csv');
    params.set('ids', ids.join(','));
    
    const exportUrl = `${window.location.pathname}/export?${params.toString()}`;
    window.location.href = exportUrl;
}

// Column Visibility Functions
let columnVisibility = {};

// Initialize column visibility from localStorage
function initColumnVisibility() {
    const savedVisibility = localStorage.getItem('columnVisibility_' + moduleConfig.name);
    if (savedVisibility) {
        columnVisibility = JSON.parse(savedVisibility);
        applyColumnVisibility();
    } else {
        // Initialize all columns as visible
        document.querySelectorAll('.column-toggle').forEach(cb => {
            columnVisibility[cb.dataset.column] = true;
        });
    }
}

function toggleColumnMenu() {
    const menu = document.getElementById('columnMenu');
    if (menu) {
        menu.classList.toggle('hidden');
        // Close dropdown when clicking outside
        if (!menu.classList.contains('hidden')) {
            setTimeout(() => {
                document.addEventListener('click', closeColumnMenu);
            }, 100);
        }
    }
}

function closeColumnMenu(e) {
    const menu = document.getElementById('columnMenu');
    const button = e.target.closest('button');
    if (menu && !menu.contains(e.target) && (!button || !button.onclick || !button.onclick.toString().includes('toggleColumnMenu'))) {
        menu.classList.add('hidden');
        document.removeEventListener('click', closeColumnMenu);
    }
}

function toggleColumn(columnName) {
    columnVisibility[columnName] = !columnVisibility[columnName];
    applyColumnVisibility();
    saveColumnVisibility();
}

function applyColumnVisibility() {
    Object.keys(columnVisibility).forEach(columnName => {
        const isVisible = columnVisibility[columnName];
        
        // Toggle header visibility
        const headers = document.querySelectorAll(`th[data-column="${columnName}"]`);
        headers.forEach(header => {
            header.style.display = isVisible ? '' : 'none';
        });
        
        // Toggle cell visibility
        const cells = document.querySelectorAll(`td[data-column="${columnName}"]`);
        cells.forEach(cell => {
            cell.style.display = isVisible ? '' : 'none';
        });
        
        // Update checkbox state
        const checkbox = document.querySelector(`.column-toggle[data-column="${columnName}"]`);
        if (checkbox) {
            checkbox.checked = isVisible;
        }
    });
}

function saveColumnVisibility() {
    localStorage.setItem('columnVisibility_' + moduleConfig.name, JSON.stringify(columnVisibility));
}

function showAllColumns() {
    document.querySelectorAll('.column-toggle').forEach(cb => {
        columnVisibility[cb.dataset.column] = true;
        cb.checked = true;
    });
    applyColumnVisibility();
    saveColumnVisibility();
}

function hideAllColumns() {
    // Keep at least one column visible (first one)
    let first = true;
    document.querySelectorAll('.column-toggle').forEach(cb => {
        columnVisibility[cb.dataset.column] = first;
        cb.checked = first;
        first = false;
    });
    applyColumnVisibility();
    saveColumnVisibility();
}

function resetColumns() {
    // Reset to default visibility (all visible)
    document.querySelectorAll('.column-toggle').forEach(cb => {
        columnVisibility[cb.dataset.column] = true;
        cb.checked = true;
    });
    applyColumnVisibility();
    localStorage.removeItem('columnVisibility_' + moduleConfig.name);
}

// Initialize column visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    initColumnVisibility();
    initSavedFilters();
});

// Saved Filter Sets Functions
let savedFilterSets = [];
let currentFilterState = {};

function initSavedFilters() {
    // Load saved filter sets from localStorage
    const saved = localStorage.getItem('savedFilterSets_' + moduleConfig.name);
    if (saved) {
        savedFilterSets = JSON.parse(saved);
    }
    updateSavedFiltersList();
}

function toggleSavedFiltersMenu() {
    const menu = document.getElementById('savedFiltersMenu');
    if (menu) {
        menu.classList.toggle('hidden');
        if (!menu.classList.contains('hidden')) {
            setTimeout(() => {
                document.addEventListener('click', closeSavedFiltersMenu);
            }, 100);
        }
    }
}

function closeSavedFiltersMenu(e) {
    const menu = document.getElementById('savedFiltersMenu');
    const button = e.target.closest('button');
    if (menu && !menu.contains(e.target) && (!button || !button.onclick || !button.onclick.toString().includes('toggleSavedFiltersMenu'))) {
        menu.classList.add('hidden');
        document.removeEventListener('click', closeSavedFiltersMenu);
    }
}

function getCurrentFilterState() {
    const state = {
        search: document.getElementById('searchInput')?.value || '',
        filters: {}
    };
    
    // Collect all filter values
    if (moduleConfig.filters) {
        moduleConfig.filters.forEach(filter => {
            if (filter.type === 'date_range') {
                const fromValue = document.getElementById(filter.field + 'FilterFrom')?.value;
                const toValue = document.getElementById(filter.field + 'FilterTo')?.value;
                if (fromValue || toValue) {
                    state.filters[filter.field] = { from: fromValue, to: toValue };
                }
            } else if (filter.type === 'multi_select') {
                const select = document.getElementById(filter.field.toLowerCase() + 'Filter');
                if (select) {
                    const selected = Array.from(select.selectedOptions).map(o => o.value);
                    if (selected.length > 0) {
                        state.filters[filter.field] = selected;
                    }
                }
            } else {
                const value = document.getElementById(filter.field.toLowerCase() + 'Filter')?.value;
                if (value && value !== '') {
                    state.filters[filter.field] = value;
                }
            }
        });
    }
    
    // Add any legacy filter values (for users module fallback)
    const statusFilter = document.getElementById('statusFilter');
    const groupFilter = document.getElementById('groupFilter');
    if (statusFilter && statusFilter.value) {
        state.filters.status = statusFilter.value;
    }
    if (groupFilter && groupFilter.value) {
        state.filters.group = groupFilter.value;
    }
    
    return state;
}

function saveCurrentFilters() {
    const form = document.getElementById('saveFilterForm');
    const nameInput = document.getElementById('filterSetName');
    if (form && nameInput) {
        form.classList.remove('hidden');
        nameInput.value = '';
        nameInput.focus();
    }
}

function confirmSaveFilters() {
    const nameInput = document.getElementById('filterSetName');
    const name = nameInput?.value.trim();
    
    if (!name) {
        alert('{{ t("admin.common.filters.name_required") }}');
        return;
    }
    
    // Check if name already exists
    if (savedFilterSets.some(set => set.name === name)) {
        if (!confirm(`Filter set "${name}" already exists. Replace it?`)) {
            return;
        }
        // Remove existing
        savedFilterSets = savedFilterSets.filter(set => set.name !== name);
    }
    
    // Save current filter state
    const filterSet = {
        name: name,
        state: getCurrentFilterState(),
        created: new Date().toISOString()
    };
    
    savedFilterSets.push(filterSet);
    saveFilterSetsToStorage();
    updateSavedFiltersList();
    
    // Hide form
    const form = document.getElementById('saveFilterForm');
    if (form) {
        form.classList.add('hidden');
    }
    
    showToast('Filter set saved successfully', 'success');
}

function cancelSaveFilters() {
    const form = document.getElementById('saveFilterForm');
    if (form) {
        form.classList.add('hidden');
    }
}

function applyFilterSet(name) {
    const filterSet = savedFilterSets.find(set => set.name === name);
    if (!filterSet) return;
    
    const state = filterSet.state;
    
    // Apply search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = state.search || '';
    }
    
    // Apply filters
    Object.keys(state.filters).forEach(field => {
        const value = state.filters[field];
        
        if (typeof value === 'object' && value.from !== undefined) {
            // Date range
            const fromInput = document.getElementById(field + 'FilterFrom');
            const toInput = document.getElementById(field + 'FilterTo');
            if (fromInput) fromInput.value = value.from || '';
            if (toInput) toInput.value = value.to || '';
        } else if (Array.isArray(value)) {
            // Multi-select
            const select = document.getElementById(field.toLowerCase() + 'Filter');
            if (select) {
                Array.from(select.options).forEach(option => {
                    option.selected = value.includes(option.value);
                });
            }
        } else {
            // Regular select
            const element = document.getElementById(field.toLowerCase() + 'Filter') || 
                          document.getElementById(field + 'Filter');
            if (element) {
                element.value = value;
            }
        }
    });
    
    // Apply legacy filters
    if (state.filters.status) {
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) statusFilter.value = state.filters.status;
    }
    if (state.filters.group) {
        const groupFilter = document.getElementById('groupFilter');
        if (groupFilter) groupFilter.value = state.filters.group;
    }
    
    // Trigger filter update
    filterTable();
    
    // Close menu
    const menu = document.getElementById('savedFiltersMenu');
    if (menu) {
        menu.classList.add('hidden');
    }
}

function deleteFilterSet(name) {
    if (confirm(`Delete filter set "${name}"?`)) {
        savedFilterSets = savedFilterSets.filter(set => set.name !== name);
        saveFilterSetsToStorage();
        updateSavedFiltersList();
        showToast('Filter set deleted', 'info');
    }
}

function clearAllFilterSets() {
    if (confirm('Delete all saved filter sets?')) {
        savedFilterSets = [];
        saveFilterSetsToStorage();
        updateSavedFiltersList();
        showToast('All filter sets cleared', 'info');
    }
}

function saveFilterSetsToStorage() {
    localStorage.setItem('savedFilterSets_' + moduleConfig.name, JSON.stringify(savedFilterSets));
}

function updateSavedFiltersList() {
    const listContainer = document.getElementById('savedFiltersList');
    const countSpan = document.getElementById('filterSetCount');
    
    if (!listContainer) return;
    
    if (savedFilterSets.length === 0) {
        listContainer.innerHTML = '<div class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No saved filter sets</div>';
    } else {
        listContainer.innerHTML = savedFilterSets.map(set => `
            <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 group">
                <button onclick="applyFilterSet('${set.name.replace(/'/g, "\\'")}')" 
                        class="flex-1 text-left text-sm text-gray-700 dark:text-gray-300">
                    <div class="font-medium">${set.name}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        ${new Date(set.created).toLocaleDateString()}
                    </div>
                </button>
                <button onclick="deleteFilterSet('${set.name.replace(/'/g, "\\'")}')" 
                        class="ml-2 text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `).join('');
    }
    
    if (countSpan) {
        countSpan.textContent = `${savedFilterSets.length} saved filter set${savedFilterSets.length !== 1 ? 's' : ''}`;
    }
}

function showToast(message, type = 'info') {
    // Simple toast notification - you can enhance this
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Typeahead helpers for select fields that need search UX
const typeaheadRegistry = {};

function initTypeaheadFields() {
    document.querySelectorAll('[data-typeahead="true"]').forEach(container => {
        const fieldName = container.dataset.field;
        if (!fieldName || typeaheadRegistry[fieldName]) {
            return;
        }

        const hiddenInput = document.getElementById(fieldName);
        const textInput = document.getElementById(fieldName + '_typeahead');
        const dataList = document.getElementById(fieldName + '_options');
        if (!hiddenInput || !textInput || !dataList) {
            return;
        }

        const labelByValue = {};
        const valueByLabel = {};
        Array.from(dataList.options).forEach(option => {
            const storedValue = option.dataset.value || option.value;
            const label = option.value;
            labelByValue[storedValue] = label;
            valueByLabel[label] = storedValue;
        });

        const syncHidden = () => {
            const label = textInput.value;
            hiddenInput.value = valueByLabel[label] || '';
        };

        const getBestMatchLabel = () => {
            const entered = textInput.value.trim();
            if (entered && valueByLabel[entered]) {
                return entered;
            }
            if (!entered) {
                return '';
            }
            const lower = entered.toLowerCase();
            const labels = Array.from(dataList.options).map(option => option.value);
            const startsWithMatch = labels.find(label => label.toLowerCase().startsWith(lower));
            if (startsWithMatch) {
                return startsWithMatch;
            }
            return labels.find(label => label.toLowerCase().includes(lower)) || '';
        };

        textInput.addEventListener('change', syncHidden);
        textInput.addEventListener('blur', syncHidden);
        textInput.addEventListener('input', () => {
            if (!valueByLabel[textInput.value]) {
                hiddenInput.value = '';
            }
        });
        textInput.addEventListener('keydown', (event) => {
            if (event.key !== 'Enter') {
                return;
            }
            event.preventDefault();
            let label = getBestMatchLabel();
            if (!label && dataList.options.length > 0) {
                label = dataList.options[0].value;
            }
            if (label) {
                textInput.value = label;
                hiddenInput.value = valueByLabel[label] || '';
            } else {
                hiddenInput.value = '';
            }
            focusNextFormField(textInput);
        });

        if (hiddenInput.value && labelByValue[hiddenInput.value]) {
            textInput.value = labelByValue[hiddenInput.value];
        }

        typeaheadRegistry[fieldName] = {
            sync: syncHidden,
            setValue(value) {
                hiddenInput.value = value || '';
                textInput.value = value && labelByValue[value] ? labelByValue[value] : '';
            },
            clear() {
                hiddenInput.value = '';
                textInput.value = '';
            }
        };
    });
}

function syncAllTypeaheadFields() {
    Object.values(typeaheadRegistry).forEach(entry => {
        if (entry && typeof entry.sync === 'function') {
            entry.sync();
        }
    });
}

function setTypeaheadValue(fieldName, value) {
    const entry = typeaheadRegistry[fieldName];
    if (entry && typeof entry.setValue === 'function') {
        entry.setValue(value);
    } else {
        const hiddenInput = document.getElementById(fieldName);
        if (hiddenInput) {
            hiddenInput.value = value || '';
        }
        const textInput = document.getElementById(fieldName + '_typeahead');
        if (textInput && (!value || value === '')) {
            textInput.value = '';
        }
    }
}

function focusNextFormField(currentElement) {
    if (!currentElement) {
        return;
    }
    const form = currentElement.closest('form');
    if (!form) {
        currentElement.blur();
        return;
    }
    const focusableSelectors = 'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])';
    const focusable = Array.from(form.querySelectorAll(focusableSelectors)).filter(el => el.offsetParent !== null);
    const index = focusable.indexOf(currentElement);
    if (index === -1) {
        currentElement.blur();
        return;
    }
    const nextElement = focusable[index + 1];
    if (nextElement) {
        nextElement.focus();
    } else {
        currentElement.blur();
    }
}

// Inline Editing Functions
let currentEditingElement = null;

function initInlineEdit() {
    // Add tooltips for editable fields
    document.querySelectorAll('.inline-edit-display').forEach(el => {
        el.title = 'Double-click to edit';
    });
}

function startInlineEdit(displayElement) {
    // Don't allow multiple edits at once
    if (currentEditingElement) {
        saveInlineEdit(currentEditingElement.nextElementSibling);
    }
    
    const container = displayElement.parentElement;
    const inputElement = container.querySelector('.inline-edit-input');
    
    // Hide display, show input
    displayElement.classList.add('hidden');
    inputElement.classList.remove('hidden');
    inputElement.focus();
    inputElement.select();
    
    currentEditingElement = displayElement;
}

function saveInlineEdit(inputElement) {
    const container = inputElement.parentElement;
    const displayElement = container.querySelector('.inline-edit-display');
    const field = displayElement.dataset.field;
    const itemId = displayElement.dataset.itemId;
    const oldValue = displayElement.dataset.value;
    const newValue = inputElement.value.trim();
    
    // If value hasn't changed, just cancel
    if (newValue === oldValue) {
        cancelInlineEdit(inputElement);
        return;
    }
    
    // Show saving state
    displayElement.classList.add('inline-edit-saving');
    displayElement.textContent = 'Saving...';
    displayElement.classList.remove('hidden');
    inputElement.classList.add('hidden');
    
    // Make API call to save
    const url = `${window.location.pathname}/${itemId}`;
    const data = {};
    data[field] = newValue;
    
    fetch(url, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to save');
        }
        return response.json();
    })
    .then(result => {
        // Success - update display
        displayElement.textContent = newValue || '-';
        displayElement.dataset.value = newValue;
        inputElement.value = newValue;
        displayElement.classList.remove('inline-edit-saving');
        displayElement.classList.add('inline-edit-success');
        
        // Remove success animation after delay
        setTimeout(() => {
            displayElement.classList.remove('inline-edit-success');
        }, 500);
        
        showToast('Field updated successfully', 'success');
    })
    .catch(error => {
        // Error - revert to old value
        displayElement.textContent = oldValue || '-';
        inputElement.value = oldValue;
        displayElement.classList.remove('inline-edit-saving');
        displayElement.classList.add('inline-edit-error');
        
        // Remove error animation after delay
        setTimeout(() => {
            displayElement.classList.remove('inline-edit-error');
        }, 500);
        
        showToast('Failed to save changes', 'error');
    })
    .finally(() => {
        currentEditingElement = null;
    });
}

function cancelInlineEdit(inputElement) {
    const container = inputElement.parentElement;
    const displayElement = container.querySelector('.inline-edit-display');
    const oldValue = displayElement.dataset.value;
    
    // Revert input value and hide
    inputElement.value = oldValue;
    inputElement.classList.add('hidden');
    displayElement.classList.remove('hidden');
    
    currentEditingElement = null;
}

function handleInlineEditKey(event, inputElement) {
    if (event.key === 'Enter') {
        event.preventDefault();
        saveInlineEdit(inputElement);
    } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelInlineEdit(inputElement);
    }
}

function handleMailAccountRowSelect(id, row, event) {
    if (event) {
        const target = event.target;
        if (target && (target.closest('input') || target.closest('button') || target.closest('a') || target.closest('svg'))) {
            return;
        }
    }
    selectedMailAccountId = id;
    document.querySelectorAll('tbody tr[data-id]').forEach(r => r.classList.remove('mail-row-selected'));
    if (row) {
        row.classList.add('mail-row-selected');
    }
    loadMailAccountStatus(id, 'pane');
}

let selectedMailAccountId = null;

function getMailStatusElements(scope) {
    const cardId = scope === 'pane' ? 'mailStatusPane' : 'mailStatusCard';
    const badgeId = scope === 'pane' ? 'mailStatusPaneBadge' : 'mailStatusBadge';
    const lastPollId = scope === 'pane' ? 'mailStatusPaneLastPoll' : 'mailStatusLastPoll';
    const messagesId = scope === 'pane' ? 'mailStatusPaneMessages' : 'mailStatusMessages';
    const nextPollId = scope === 'pane' ? 'mailStatusPaneNextPoll' : 'mailStatusNextPoll';
    const errId = scope === 'pane' ? 'mailStatusPaneError' : 'mailStatusError';
    const staleId = scope === 'pane' ? 'mailStatusPaneStale' : 'mailStatusStale';
    return {
        card: document.getElementById(cardId),
        badge: document.getElementById(badgeId),
        lastPoll: document.getElementById(lastPollId),
        messages: document.getElementById(messagesId),
        nextPoll: document.getElementById(nextPollId),
        errEl: document.getElementById(errId),
        staleEl: document.getElementById(staleId)
    };
}

function resetMailAccountStatus(scope = 'modal') {
    const els = getMailStatusElements(scope);
    if (!els.card) return;
    els.card.classList.add('hidden');
    if (els.badge) els.badge.textContent = '--';
    if (els.lastPoll) els.lastPoll.textContent = '--';
    if (els.messages) els.messages.textContent = '--';
    if (els.nextPoll) els.nextPoll.textContent = '--';
    if (els.errEl) els.errEl.textContent = '';
    if (els.staleEl) els.staleEl.textContent = '';
}

function loadMailAccountStatus(accountId, scope = 'modal') {
    const els = getMailStatusElements(scope);
    if (!els.card || !accountId) return;
    resetMailAccountStatus(scope);
    fetch(`/admin/mail-accounts/${accountId}/poll-status`, {
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(resp => resp.json().catch(() => ({})))
    .then(payload => {
        if (!payload || !payload.success) {
            renderMailAccountStatus(null, true, scope);
            return;
        }
        renderMailAccountStatus(payload.data || null, false, scope);
    })
    .catch(() => {
        renderMailAccountStatus(null, true, scope);
    });
}

function renderMailAccountStatus(status, errored, scope = 'modal') {
    const els = getMailStatusElements(scope);
    if (!els.card) return;
    els.card.classList.remove('hidden');

    if (errored) {
        if (els.badge) {
            els.badge.textContent = translateMailStatusLabel('unavailable');
            els.badge.className = 'text-sm font-semibold text-amber-700 dark:text-amber-400';
        }
        if (els.errEl) {
            els.errEl.textContent = translateMailStatusLabel('error');
        }
        return;
    }

    if (!status) {
        if (els.badge) {
            els.badge.textContent = translateMailStatusLabel('no_data');
            els.badge.className = 'text-sm font-semibold text-gray-600 dark:text-gray-300';
        }
        if (els.lastPoll) els.lastPoll.textContent = '--';
        if (els.messages) els.messages.textContent = '--';
        if (els.nextPoll) els.nextPoll.textContent = '--';
        return;
    }

    const ok = status.last_status === 'ok';
    if (els.badge) {
        els.badge.textContent = translateMailStatusLabel(ok ? 'ok' : 'error');
        els.badge.className = ok ? 'text-sm font-semibold text-green-700 dark:text-green-400' : 'text-sm font-semibold text-red-700 dark:text-red-400';
    }

    if (els.lastPoll && status.last_poll_at) {
        els.lastPoll.textContent = formatMailStatusTime(status.last_poll_at);
    }
    if (els.messages && status.messages_fetched !== undefined && status.messages_fetched !== null) {
        els.messages.textContent = status.messages_fetched;
    }
    if (els.nextPoll && status.next_poll_eta) {
        els.nextPoll.textContent = formatMailStatusTime(status.next_poll_eta);
    }
    if (els.errEl) {
        els.errEl.textContent = status.last_error || '';
    }

    if (els.staleEl && status.last_poll_at) {
        const last = new Date(status.last_poll_at).getTime();
        const now = Date.now();
        const staleCutoff = 45 * 60 * 1000; // 45 minutes
        if (now - last > staleCutoff) {
            els.staleEl.textContent = translateMailStatusLabel('stale');
        }
    }
}

function formatMailStatusTime(value) {
    try {
        const dt = new Date(value);
        if (!isNaN(dt.getTime())) {
            return dt.toLocaleString();
        }
    } catch (e) {}
    return '--';
}

// Click outside to save inline edit
document.addEventListener('click', function(e) {
    if (currentEditingElement) {
        const container = currentEditingElement.parentElement;
        if (!container.contains(e.target)) {
            saveInlineEdit(currentEditingElement.nextElementSibling);
        }
    }
});

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
    initColumnVisibility();
    initSavedFilters();
    initInlineEdit();
    initTypeaheadFields();
    if (moduleName === 'mail_account') {
        initMailAccountRowSelection();
    }
});

function updateMailAccountFieldVisibility() {
    if (moduleName !== 'mail_account') {
        return;
    }
    const accountSelect = document.getElementById('account_type');
    const imapField = document.getElementById('field_imap_folder');
    const imapInput = document.getElementById('imap_folder');
    if (!accountSelect || !imapField || !imapInput) {
        return;
    }
    const value = (accountSelect.value || '').toLowerCase();
    const isImap = value.startsWith('imap');
    if (isImap) {
        imapField.classList.remove('hidden');
        imapInput.disabled = false;
    } else {
        imapField.classList.add('hidden');
        imapInput.disabled = true;
    }
}

if (moduleName === 'mail_account') {
    document.addEventListener('DOMContentLoaded', function() {
        const accountSelect = document.getElementById('account_type');
        if (accountSelect) {
            accountSelect.addEventListener('change', updateMailAccountFieldVisibility);
        }
        updateMailAccountFieldVisibility();
    });
}

function initMailAccountRowSelection() {
    const rows = document.querySelectorAll('tbody tr[data-id]');
    if (!rows || rows.length === 0) {
        return;
    }
    rows.forEach(row => {
        row.addEventListener('click', (e) => handleMailAccountRowSelect(row.getAttribute('data-id'), row, e));
    });
    handleMailAccountRowSelect(rows[0].getAttribute('data-id'), rows[0]);
}

// ESC key to close modals and menus
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        const columnMenu = document.getElementById('columnMenu');
        if (columnMenu && !columnMenu.classList.contains('hidden')) {
            columnMenu.classList.add('hidden');
        }
        const savedFiltersMenu = document.getElementById('savedFiltersMenu');
        if (savedFiltersMenu && !savedFiltersMenu.classList.contains('hidden')) {
            savedFiltersMenu.classList.add('hidden');
        }
        const saveFilterForm = document.getElementById('saveFilterForm');
        if (saveFilterForm && !saveFilterForm.classList.contains('hidden')) {
            saveFilterForm.classList.add('hidden');
        }
    }
});
</script>
{% endblock %}