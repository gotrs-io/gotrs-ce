# Container-first testing environment for GOTRS
FROM golang:1.23-alpine AS builder

# Install test dependencies
RUN apk add --no-cache git ca-certificates curl jq

# Create non-root user
RUN adduser -D -s /bin/sh -u 1000 tester

WORKDIR /app

# Copy go modules
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build test tools
RUN CGO_ENABLED=0 go build -o /usr/local/bin/route-test ./cmd/route-test
RUN CGO_ENABLED=0 go build -o /usr/local/bin/route-docs ./cmd/route-docs

# Production test image
FROM alpine:3.18

RUN apk add --no-cache ca-certificates curl jq bash

# Create tester user
RUN adduser -D -s /bin/sh -u 1000 tester

# Copy built tools
COPY --from=builder /usr/local/bin/route-test /usr/local/bin/route-test
COPY --from=builder /usr/local/bin/route-docs /usr/local/bin/route-docs

# Copy routes for testing
COPY --chown=tester:tester ./routes /app/routes

# Create test runner script
RUN cat > /usr/local/bin/test-runner << 'EOF'
#!/bin/bash

# GOTRS Container-First Test Runner
set -e

GOTRS_HOST=${GOTRS_HOST:-http://gotrs-backend:8080}
ROUTES_DIR=${ROUTES_DIR:-/app/routes}
VERBOSE=${VERBOSE:-false}
OUTPUT_DIR=${OUTPUT_DIR:-/app/results}
RETRY_COUNT=${RETRY_COUNT:-3}
RETRY_DELAY=${RETRY_DELAY:-5}

echo "ğŸ³ GOTRS Container Test Runner"
echo "================================"
echo "Target: $GOTRS_HOST"
echo "Routes: $ROUTES_DIR" 
echo "Output: $OUTPUT_DIR"
echo ""

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Wait for GOTRS to be ready
echo "â³ Waiting for GOTRS to be ready..."
for i in $(seq 1 $RETRY_COUNT); do
    if curl -s "$GOTRS_HOST/health" > /dev/null 2>&1; then
        echo "âœ… GOTRS is ready!"
        break
    fi
    
    echo "   Attempt $i/$RETRY_COUNT failed, retrying in ${RETRY_DELAY}s..."
    sleep $RETRY_DELAY
    
    if [ $i -eq $RETRY_COUNT ]; then
        echo "âŒ GOTRS failed to start after $RETRY_COUNT attempts"
        exit 1
    fi
done

echo ""

# Run route tests
echo "ğŸ§ª Running Route Tests"
echo "======================"

VERBOSE_FLAG=""
if [ "$VERBOSE" = "true" ]; then
    VERBOSE_FLAG="--verbose"
fi

route-test "$ROUTES_DIR" "$GOTRS_HOST" $VERBOSE_FLAG 2>&1 | tee "$OUTPUT_DIR/test-results.log"
TEST_EXIT_CODE=${PIPESTATUS[0]}

echo ""

# Generate documentation
echo "ğŸ“š Generating Documentation"
echo "==========================="
route-docs "$ROUTES_DIR" "$OUTPUT_DIR/docs"
echo "Documentation generated in $OUTPUT_DIR/docs/"

echo ""

# Get system metrics
echo "ğŸ“Š Collecting System Metrics"
echo "============================"
curl -s "$GOTRS_HOST/metrics/stats" > "$OUTPUT_DIR/metrics.json" 2>/dev/null || echo "No metrics available"

# Create test report
echo "ğŸ“‹ Creating Test Report"
echo "======================"
cat > "$OUTPUT_DIR/test-report.html" << 'HTML_EOF'
<!DOCTYPE html>
<html>
<head>
    <title>GOTRS Test Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 2rem; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 8px; }
        .section { margin: 2rem 0; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; }
        .pass { color: #48bb78; font-weight: bold; }
        .fail { color: #f56565; font-weight: bold; }
        pre { background: #f7fafc; padding: 1rem; border-radius: 4px; overflow-x: auto; }
        .metric { display: inline-block; background: #edf2f7; padding: 0.5rem 1rem; margin: 0.25rem; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ³ GOTRS Container Test Report</h1>
        <p>Generated: $(date)</p>
        <p>Target: $GOTRS_HOST</p>
    </div>

    <div class="section">
        <h2>ğŸ“Š Test Summary</h2>
        <div id="test-summary">
            Loading test results...
        </div>
    </div>

    <div class="section">
        <h2>ğŸ“‹ Detailed Results</h2>
        <pre id="test-logs">
$(cat "$OUTPUT_DIR/test-results.log")
        </pre>
    </div>

    <div class="section">
        <h2>ğŸ”— Resources</h2>
        <ul>
            <li><a href="docs/index.html">ğŸ“š API Documentation</a></li>
            <li><a href="docs/api.md">ğŸ“„ Markdown Documentation</a></li>
            <li><a href="docs/openapi.json">ğŸ”§ OpenAPI Specification</a></li>
            <li><a href="metrics.json">ğŸ“Š System Metrics</a></li>
        </ul>
    </div>
</body>
</html>
HTML_EOF

echo "Test report created: $OUTPUT_DIR/test-report.html"
echo ""

# Summary
echo "ğŸ¯ Test Run Complete"
echo "==================="
echo "Results: $OUTPUT_DIR/"
echo "Exit code: $TEST_EXIT_CODE"

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "âœ… All tests passed!"
else
    echo "âŒ Some tests failed"
fi

exit $TEST_EXIT_CODE
EOF

RUN chmod +x /usr/local/bin/test-runner

USER tester
WORKDIR /app

# Default command
CMD ["/usr/local/bin/test-runner"]