{{template "layout" .}}

{{define "title"}}Workflow Analytics{{end}}

{{define "content"}}
<div class="workflow-analytics" x-data="workflowAnalytics()">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">Workflow Analytics</h1>
                <p class="text-gray-600">Monitor and optimize your workflow automation performance</p>
            </div>
            <div class="flex items-center space-x-3">
                <select x-model="selectedPeriod"
                        @change="refreshData()"
                        class="px-4 py-2 border rounded-lg">
                    <option value="day">Last 24 Hours</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="quarter">Last Quarter</option>
                    <option value="year">Last Year</option>
                </select>
                <button @click="exportReport()"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    <i class="fas fa-download mr-2"></i>Export Report
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-500 text-sm">Total Executions</span>
                <i class="fas fa-play-circle text-blue-500"></i>
            </div>
            <div class="text-3xl font-bold" x-text="formatNumber(metrics.total_executions)"></div>
            <div class="flex items-center mt-2 text-sm"
                 :class="metrics.execution_trend > 0 ? 'text-green-500' : 'text-red-500'">
                <i class="fas" :class="metrics.execution_trend > 0 ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
                <span class="ml-1" x-text="`${Math.abs(metrics.execution_trend)}%`"></span>
                <span class="ml-1 text-gray-500">vs previous period</span>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-500 text-sm">Success Rate</span>
                <i class="fas fa-check-circle text-green-500"></i>
            </div>
            <div class="text-3xl font-bold">
                <span x-text="metrics.success_rate?.toFixed(1)"></span>%
            </div>
            <div class="mt-2">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" 
                         :style="`width: ${metrics.success_rate}%`"></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-500 text-sm">Time Saved</span>
                <i class="fas fa-clock text-purple-500"></i>
            </div>
            <div class="text-3xl font-bold">
                <span x-text="formatTime(metrics.time_saved_hours)"></span>
            </div>
            <div class="text-sm text-gray-500 mt-2">
                <span x-text="formatNumber(metrics.total_actions_saved)"></span> actions automated
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-500 text-sm">Cost Savings</span>
                <i class="fas fa-dollar-sign text-yellow-500"></i>
            </div>
            <div class="text-3xl font-bold">
                $<span x-text="formatNumber(metrics.roi_metrics?.cost_savings_usd)"></span>
            </div>
            <div class="text-sm text-green-500 mt-2">
                <i class="fas fa-chart-line"></i>
                <span x-text="`${metrics.roi_metrics?.efficiency_gain_percent?.toFixed(1)}%`"></span> efficiency gain
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Execution Trends Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="font-semibold mb-4">Execution Trends</h3>
            <canvas id="executionTrendsChart"></canvas>
        </div>

        <!-- Trigger Distribution Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="font-semibold mb-4">Trigger Distribution</h3>
            <canvas id="triggerDistributionChart"></canvas>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow">
        <div class="border-b">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button @click="activeTab = 'workflows'"
                        class="py-4 px-1 border-b-2 font-medium text-sm"
                        :class="activeTab === 'workflows' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                    Top Workflows
                </button>
                <button @click="activeTab = 'performance'"
                        class="py-4 px-1 border-b-2 font-medium text-sm"
                        :class="activeTab === 'performance' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                    Performance Analysis
                </button>
                <button @click="activeTab = 'errors'"
                        class="py-4 px-1 border-b-2 font-medium text-sm"
                        :class="activeTab === 'errors' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                    Error Analysis
                </button>
                <button @click="activeTab = 'actions'"
                        class="py-4 px-1 border-b-2 font-medium text-sm"
                        :class="activeTab === 'actions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                    Action Insights
                </button>
                <button @click="activeTab = 'predictions'"
                        class="py-4 px-1 border-b-2 font-medium text-sm"
                        :class="activeTab === 'predictions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                    Predictions
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Top Workflows Tab -->
            <div x-show="activeTab === 'workflows'">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Workflow
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Executions
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Success Rate
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Avg Time
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Impact Score
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="workflow in metrics.top_workflows" :key="workflow.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900" x-text="workflow.name"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                              :class="workflow.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                                              x-text="workflow.status"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="formatNumber(workflow.execution_count)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="text-sm text-gray-900" x-text="`${workflow.success_rate.toFixed(1)}%`"></span>
                                            <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                                <div class="h-2 rounded-full"
                                                     :class="workflow.success_rate > 90 ? 'bg-green-500' : workflow.success_rate > 70 ? 'bg-yellow-500' : 'bg-red-500'"
                                                     :style="`width: ${workflow.success_rate}%`"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="`${workflow.average_execution_time_ms}ms`"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <span class="text-sm font-medium" x-text="workflow.impact_score.toFixed(1)"></span>
                                            <div class="ml-2">
                                                <template x-for="i in 5" :key="i">
                                                    <i class="fas fa-star text-xs"
                                                       :class="i <= Math.ceil(workflow.impact_score/20) ? 'text-yellow-400' : 'text-gray-300'"></i>
                                                </template>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewWorkflowDetails(workflow.id)"
                                                class="text-blue-600 hover:text-blue-900">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Performance Analysis Tab -->
            <div x-show="activeTab === 'performance'">
                <div class="space-y-6">
                    <!-- Performance Trend -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium mb-2">Performance Trend</h4>
                            <div class="flex items-center justify-between">
                                <span class="text-2xl font-bold"
                                      :class="{
                                          'text-green-500': performanceAnalysis.performance_trend === 'improving',
                                          'text-yellow-500': performanceAnalysis.performance_trend === 'stable',
                                          'text-red-500': performanceAnalysis.performance_trend === 'degrading'
                                      }"
                                      x-text="performanceAnalysis.performance_trend"></span>
                                <i class="fas text-3xl"
                                   :class="{
                                       'fa-arrow-trend-up text-green-500': performanceAnalysis.performance_trend === 'improving',
                                       'fa-minus text-yellow-500': performanceAnalysis.performance_trend === 'stable',
                                       'fa-arrow-trend-down text-red-500': performanceAnalysis.performance_trend === 'degrading'
                                   }"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium mb-2">SLA Compliance</h4>
                            <div class="flex items-center justify-between">
                                <span class="text-2xl font-bold">
                                    <span x-text="performanceAnalysis.sla_compliance_percent?.toFixed(1)"></span>%
                                </span>
                                <div class="w-20 h-20">
                                    <canvas id="slaGauge"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium mb-2">Resource Usage</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>CPU</span>
                                    <span x-text="`${performanceAnalysis.resource_usage?.cpu_usage_percent?.toFixed(1)}%`"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Memory</span>
                                    <span x-text="`${performanceAnalysis.resource_usage?.memory_usage_mb}MB`"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>DB Queries</span>
                                    <span x-text="performanceAnalysis.resource_usage?.database_queries"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottlenecks -->
                    <div>
                        <h4 class="font-medium mb-3">Performance Bottlenecks</h4>
                        <div class="space-y-3">
                            <template x-for="bottleneck in performanceAnalysis.bottlenecks" :key="bottleneck.component_id">
                                <div class="border rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <span class="font-medium" x-text="bottleneck.component_id"></span>
                                            <span class="ml-2 px-2 py-1 text-xs rounded"
                                                  :class="{
                                                      'bg-red-100 text-red-700': bottleneck.impact === 'high',
                                                      'bg-yellow-100 text-yellow-700': bottleneck.impact === 'medium',
                                                      'bg-blue-100 text-blue-700': bottleneck.impact === 'low'
                                                  }"
                                                  x-text="bottleneck.impact"></span>
                                        </div>
                                        <span class="text-sm text-gray-500" x-text="bottleneck.component_type"></span>
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-500">Avg Time:</span>
                                            <span class="ml-1 font-medium" x-text="`${bottleneck.average_time_ms}ms`"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Max Time:</span>
                                            <span class="ml-1 font-medium" x-text="`${bottleneck.max_time_ms}ms`"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Frequency:</span>
                                            <span class="ml-1 font-medium" x-text="bottleneck.frequency"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Optimization Suggestions -->
                    <div>
                        <h4 class="font-medium mb-3">Optimization Suggestions</h4>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <ul class="space-y-2">
                                <template x-for="suggestion in performanceAnalysis.optimization_suggestions" :key="suggestion">
                                    <li class="flex items-start">
                                        <i class="fas fa-lightbulb text-blue-500 mt-1 mr-2"></i>
                                        <span x-text="suggestion"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Analysis Tab -->
            <div x-show="activeTab === 'errors'">
                <div class="space-y-6">
                    <!-- Error Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-red-50 rounded-lg p-4">
                            <h4 class="font-medium text-red-900 mb-2">Total Errors</h4>
                            <div class="text-3xl font-bold text-red-600" x-text="formatNumber(errorAnalysis.total_errors)"></div>
                            <div class="text-sm text-red-700 mt-1">
                                <span x-text="`${errorAnalysis.error_rate?.toFixed(2)}%`"></span> error rate
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h4 class="font-medium text-yellow-900 mb-2">Recovery Rate</h4>
                            <div class="text-3xl font-bold text-yellow-600">
                                <span x-text="`${errorAnalysis.recovery_rate?.toFixed(1)}%`"></span>
                            </div>
                            <div class="text-sm text-yellow-700 mt-1">Self-recovered errors</div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium mb-2">Error Trend</h4>
                            <canvas id="errorTrendChart" height="80"></canvas>
                        </div>
                    </div>

                    <!-- Common Errors -->
                    <div>
                        <h4 class="font-medium mb-3">Common Error Patterns</h4>
                        <div class="space-y-3">
                            <template x-for="error in errorAnalysis.common_errors" :key="error.pattern">
                                <div class="border border-red-200 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-1">
                                            <div class="font-medium text-red-900" x-text="error.pattern"></div>
                                            <div class="text-sm text-gray-600 mt-1">
                                                Affected workflows: 
                                                <template x-for="flow in error.affected_flows.slice(0,3)" :key="flow">
                                                    <span class="inline-block px-2 py-1 bg-gray-100 rounded text-xs mr-1" x-text="flow"></span>
                                                </template>
                                                <span x-show="error.affected_flows.length > 3" class="text-xs text-gray-500">
                                                    +<span x-text="error.affected_flows.length - 3"></span> more
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold text-red-600" x-text="error.count"></div>
                                            <div class="text-sm text-gray-500">
                                                <span x-text="`${error.percentage.toFixed(1)}%`"></span> of errors
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        Last occurred: <span x-text="formatDate(error.last_occurred)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Errors by Component -->
                    <div>
                        <h4 class="font-medium mb-3">Errors by Component</h4>
                        <canvas id="errorsByComponentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Action Insights Tab -->
            <div x-show="activeTab === 'actions'">
                <div class="space-y-6">
                    <!-- Action Overview -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">Most Effective Actions</h4>
                            <div class="space-y-2">
                                <template x-for="action in actionAnalysis.most_effective_actions" :key="action.action_type">
                                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <div>
                                            <span class="font-medium" x-text="formatActionType(action.action_type)"></span>
                                            <div class="text-sm text-gray-600">
                                                <span x-text="`${action.usage_count} uses`"></span> • 
                                                <span x-text="`${action.average_time_ms}ms avg`"></span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">
                                                <span x-text="`${action.success_rate.toFixed(1)}%`"></span>
                                            </div>
                                            <div class="text-xs text-gray-500">Success Rate</div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-3">Actions Needing Attention</h4>
                            <div class="space-y-2">
                                <template x-for="action in actionAnalysis.least_effective_actions" :key="action.action_type">
                                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                        <div>
                                            <span class="font-medium" x-text="formatActionType(action.action_type)"></span>
                                            <div class="text-sm text-gray-600">
                                                <span x-text="`${action.usage_count} uses`"></span> • 
                                                <span x-text="`${action.average_time_ms}ms avg`"></span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-red-600">
                                                <span x-text="`${action.success_rate.toFixed(1)}%`"></span>
                                            </div>
                                            <div class="text-xs text-gray-500">Success Rate</div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Action Distribution -->
                    <div>
                        <h4 class="font-medium mb-3">Action Distribution</h4>
                        <canvas id="actionDistributionChart"></canvas>
                    </div>

                    <!-- Common Action Chains -->
                    <div>
                        <h4 class="font-medium mb-3">Common Action Sequences</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sequence</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Frequency</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Success Rate</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Avg Time</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <template x-for="chain in actionAnalysis.common_action_chains" :key="chain.actions.join('-')">
                                        <tr>
                                            <td class="px-4 py-2">
                                                <div class="flex items-center space-x-2">
                                                    <template x-for="(action, index) in chain.actions" :key="index">
                                                        <div class="flex items-center">
                                                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs"
                                                                  x-text="formatActionType(action)"></span>
                                                            <i x-show="index < chain.actions.length - 1"
                                                               class="fas fa-arrow-right text-gray-400 mx-1"></i>
                                                        </div>
                                                    </template>
                                                </div>
                                            </td>
                                            <td class="px-4 py-2 text-sm" x-text="chain.frequency"></td>
                                            <td class="px-4 py-2 text-sm">
                                                <span x-text="`${chain.success_rate.toFixed(1)}%`"></span>
                                            </td>
                                            <td class="px-4 py-2 text-sm" x-text="`${chain.average_time_ms}ms`"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Predictions Tab -->
            <div x-show="activeTab === 'predictions'">
                <div class="space-y-6">
                    <!-- Trigger Predictions -->
                    <div>
                        <h4 class="font-medium mb-3">Predicted Triggers</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="prediction in triggerAnalysis.predicted_triggers" :key="prediction.trigger_type">
                                <div class="border rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <div class="font-medium" x-text="prediction.trigger_type"></div>
                                            <div class="text-sm text-gray-600" x-text="prediction.based_on"></div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold"
                                                 :class="prediction.probability > 0.7 ? 'text-green-600' : 'text-yellow-600'">
                                                <span x-text="`${(prediction.probability * 100).toFixed(0)}%`"></span>
                                            </div>
                                            <div class="text-xs text-gray-500">Probability</div>
                                        </div>
                                    </div>
                                    <div class="text-sm">
                                        <i class="fas fa-clock text-gray-400 mr-1"></i>
                                        Expected: <span x-text="formatDate(prediction.predicted_at)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Peak Activity Times -->
                    <div>
                        <h4 class="font-medium mb-3">Peak Activity Times</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <canvas id="peakTimesChart"></canvas>
                        </div>
                    </div>

                    <!-- Trigger Patterns -->
                    <div>
                        <h4 class="font-medium mb-3">Recurring Patterns</h4>
                        <div class="space-y-3">
                            <template x-for="pattern in triggerAnalysis.trigger_patterns" :key="pattern.pattern">
                                <div class="flex items-center justify-between p-3 border rounded-lg">
                                    <div>
                                        <span class="font-medium" x-text="pattern.pattern"></span>
                                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs"
                                              x-text="pattern.periodicity"></span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-medium">
                                            <span x-text="pattern.frequency"></span> occurrences
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            Next: <span x-text="formatDate(pattern.next_expected)"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function workflowAnalytics() {
    return {
        activeTab: 'workflows',
        selectedPeriod: 'month',
        metrics: {},
        performanceAnalysis: {},
        errorAnalysis: {},
        actionAnalysis: {},
        triggerAnalysis: {},
        charts: {},
        
        init() {
            this.loadAnalytics();
            this.initCharts();
        },
        
        loadAnalytics() {
            // Load overall metrics
            fetch(`/api/v1/analytics/workflows?period=${this.selectedPeriod}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.metrics = data.data;
                        this.updateCharts();
                    }
                });
            
            // Load performance analysis
            fetch(`/api/v1/analytics/performance?period=${this.selectedPeriod}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.performanceAnalysis = data.data;
                    }
                });
            
            // Load error analysis
            fetch(`/api/v1/analytics/errors?period=${this.selectedPeriod}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.errorAnalysis = data.data;
                        this.updateErrorCharts();
                    }
                });
            
            // Load action analysis
            fetch(`/api/v1/analytics/actions?period=${this.selectedPeriod}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.actionAnalysis = data.data;
                        this.updateActionCharts();
                    }
                });
            
            // Load trigger analysis
            fetch(`/api/v1/analytics/triggers?period=${this.selectedPeriod}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.triggerAnalysis = data.data;
                        this.updateTriggerCharts();
                    }
                });
        },
        
        initCharts() {
            // Execution Trends Chart
            const trendsCtx = document.getElementById('executionTrendsChart').getContext('2d');
            this.charts.trends = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Successful',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Failed',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Trigger Distribution Chart
            const triggerCtx = document.getElementById('triggerDistributionChart').getContext('2d');
            this.charts.triggers = new Chart(triggerCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(168, 85, 247, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        },
        
        updateCharts() {
            // Update execution trends
            if (this.metrics.execution_trends && this.charts.trends) {
                const labels = this.metrics.execution_trends.map(t => 
                    new Date(t.date).toLocaleDateString()
                );
                const successData = this.metrics.execution_trends.map(t => t.success_count);
                const failureData = this.metrics.execution_trends.map(t => t.failure_count);
                
                this.charts.trends.data.labels = labels;
                this.charts.trends.data.datasets[0].data = successData;
                this.charts.trends.data.datasets[1].data = failureData;
                this.charts.trends.update();
            }
            
            // Update trigger distribution
            if (this.triggerAnalysis.trigger_distribution && this.charts.triggers) {
                const labels = Object.keys(this.triggerAnalysis.trigger_distribution);
                const data = Object.values(this.triggerAnalysis.trigger_distribution);
                
                this.charts.triggers.data.labels = labels;
                this.charts.triggers.data.datasets[0].data = data;
                this.charts.triggers.update();
            }
        },
        
        updateErrorCharts() {
            // Error trend chart would be updated here
        },
        
        updateActionCharts() {
            // Action distribution chart would be updated here
        },
        
        updateTriggerCharts() {
            // Peak times chart would be updated here
        },
        
        refreshData() {
            this.loadAnalytics();
        },
        
        viewWorkflowDetails(workflowId) {
            window.location.href = `/workflows/${workflowId}/analytics`;
        },
        
        exportReport() {
            window.open(`/api/v1/analytics/export?period=${this.selectedPeriod}`, '_blank');
        },
        
        formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toLocaleString();
        },
        
        formatTime(hours) {
            if (!hours) return '0h';
            if (hours >= 24) {
                const days = Math.floor(hours / 24);
                const remainingHours = hours % 24;
                return `${days}d ${remainingHours}h`;
            }
            return `${hours}h`;
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleString();
        },
        
        formatActionType(type) {
            if (!type) return '';
            return type.replace(/_/g, ' ')
                      .replace(/\b\w/g, l => l.toUpperCase());
        }
    }
}
</script>
{{end}}