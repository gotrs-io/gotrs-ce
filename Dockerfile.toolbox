# syntax=docker/dockerfile:1
# GOTRS Toolbox - All-in-one container for development tasks

# Global build arg - must be before any FROM that uses it
# Default provided for docker build without --build-arg; compose/make override from .env
ARG GO_IMAGE=golang:1.24-alpine

# Reuse compiled binaries from dedicated artifacts image
FROM gotrs-artifacts:latest AS artifacts

# Build additional toolbox utilities
FROM docker.io/${GO_IMAGE} AS toolbox-builder

ARG TOOLCHAIN_PKGS="git gcc musl-dev ca-certificates binutils-gold vips-dev vips-heif"
RUN apk add --no-cache $TOOLCHAIN_PKGS

# Set working directory
WORKDIR /workspace

COPY go.mod go.sum ./

RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go mod download && go mod verify

# Copy only necessary source first (exclude heavy directories by .dockerignore)
COPY . .

# Install frontend dependencies in builder if package.json exists (using bun for speed)
# Securely install Bun with GPG and checksum verification
ARG BUN_VERSION=1.1.42
RUN if [ -f package.json ]; then \
        apk add --no-cache curl dirmngr gpg gpg-agent unzip && \
        arch="$(apk --print-arch)" && \
        case "${arch##*-}" in \
          x86_64) build="x64-musl-baseline";; \
          aarch64) build="aarch64-musl";; \
          *) echo "error: unsupported architecture: $arch"; exit 1 ;; \
        esac && \
        curl "https://github.com/oven-sh/bun/releases/download/bun-v${BUN_VERSION}/bun-linux-$build.zip" \
          -fsSLO \
          --compressed \
          --retry 5 \
          || (echo "error: failed to download bun v${BUN_VERSION}" && exit 1) && \
        gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys "F3DCC08A8572C0749B3E18888EAB4D40A7B22B59" \
          || gpg --batch --keyserver keyserver.ubuntu.com --recv-keys "F3DCC08A8572C0749B3E18888EAB4D40A7B22B59" \
          || (echo "error: failed to retrieve GPG key for bun v${BUN_VERSION}" && exit 1) && \
        curl "https://github.com/oven-sh/bun/releases/download/bun-v${BUN_VERSION}/SHASUMS256.txt.asc" \
          -fsSLO \
          --compressed \
          --retry 5 && \
        gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \
          || (echo "error: failed to verify bun v${BUN_VERSION}" && exit 1) && \
        grep " bun-linux-$build.zip\$" SHASUMS256.txt | sha256sum -c - \
          || (echo "error: failed to verify checksum for bun v${BUN_VERSION}" && exit 1) && \
        unzip "bun-linux-$build.zip" && \
        mkdir -p /tmp/bin && \
        mv "bun-linux-$build/bun" /tmp/bin/bun && \
        rm -rf "bun-linux-$build" "bun-linux-$build.zip" SHASUMS256.txt.asc SHASUMS256.txt && \
        chmod +x /tmp/bin/bun && \
        /tmp/bin/bun install --frozen-lockfile --ignore-scripts || /tmp/bin/bun install --ignore-scripts || true; \
    fi && \
    mkdir -p /workspace/node_modules

# Build additional toolbox utilities with optimization
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/gotrs cmd/gotrs/main.go 2>/dev/null || true && \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/gotrs-babelfish cmd/gotrs-babelfish/main.go 2>/dev/null || true && \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/gotrs-migrate ./cmd/gotrs-migrate/*.go 2>/dev/null || true && \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/gotrs-db cmd/gotrs-db/main.go 2>/dev/null || true && \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/schema-discovery cmd/schema-discovery/main.go 2>/dev/null || true

# Install Go development tools (pinned for reproducibility)
ARG GOIMPORTS_VERSION=v0.24.0
ARG GOSEC_VERSION=v2.21.4
ARG STATICCHECK_VERSION=2024.1.1
ARG GOLANGCI_LINT_VERSION=v1.64.8
ARG GOVULNCHECK_VERSION=latest
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go install golang.org/x/tools/cmd/goimports@${GOIMPORTS_VERSION} && \
    go install github.com/securego/gosec/v2/cmd/gosec@${GOSEC_VERSION} && \
    go install honnef.co/go/tools/cmd/staticcheck@${STATICCHECK_VERSION} && \
    go install github.com/golangci/golangci-lint/cmd/golangci-lint@${GOLANGCI_LINT_VERSION} && \
    go install golang.org/x/vuln/cmd/govulncheck@${GOVULNCHECK_VERSION}

# ============================================
# Final toolbox image
# ============================================
FROM alpine:3.19 AS toolbox

ARG UID=1000
ARG GID=1000

# Install runtime and dev tools (nodejs for runtime, bun replaces npm)
ARG TOOLBOX_APKS='ca-certificates postgresql15-client mysql-client sqlite git bash make curl jq graphviz openssl python3 py3-pip yamllint ripgrep fd tree nss freetype harfbuzz libx11 libxcomposite libxdamage libxext libxfixes libxi libxrandr libxrender libxshmfence libxtst alsa-lib dumb-init ttf-freefont woff2 libc6-compat gcompat libstdc++ icu-libs nodejs vips vips-heif vips-dev gcc musl-dev'
RUN apk add --no-cache $TOOLBOX_APKS

# Install bun (fast JavaScript runtime and package manager) with GPG and checksum verification
ARG BUN_VERSION=1.1.42
RUN apk add --no-cache curl dirmngr gpg gpg-agent unzip && \
    arch="$(apk --print-arch)" && \
    case "${arch##*-}" in \
      x86_64) build="x64-musl-baseline";; \
      aarch64) build="aarch64-musl";; \
      *) echo "error: unsupported architecture: $arch"; exit 1 ;; \
    esac && \
    curl "https://github.com/oven-sh/bun/releases/download/bun-v${BUN_VERSION}/bun-linux-$build.zip" \
      -fsSLO \
      --compressed \
      --retry 5 \
      || (echo "error: failed to download bun v${BUN_VERSION}" && exit 1) && \
    # Official Bun release signing key fingerprint from https://github.com/oven-sh/bun/releases
    gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys "F3DCC08A8572C0749B3E18888EAB4D40A7B22B59" \
      || gpg --batch --keyserver keyserver.ubuntu.com --recv-keys "F3DCC08A8572C0749B3E18888EAB4D40A7B22B59" \
      || (echo "error: failed to retrieve GPG key for bun v${BUN_VERSION}" && exit 1) && \
    curl "https://github.com/oven-sh/bun/releases/download/bun-v${BUN_VERSION}/SHASUMS256.txt.asc" \
      -fsSLO \
      --compressed \
      --retry 5 && \
    gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \
      || (echo "error: failed to verify bun v${BUN_VERSION}" && exit 1) && \
    grep " bun-linux-$build.zip\$" SHASUMS256.txt | sha256sum -c - \
      || (echo "error: failed to verify checksum for bun v${BUN_VERSION}" && exit 1) && \
    unzip "bun-linux-$build.zip" && \
    mv "bun-linux-$build/bun" /usr/local/bin/bun && \
    rm -rf "bun-linux-$build" "bun-linux-$build.zip" SHASUMS256.txt.asc SHASUMS256.txt && \
    chmod +x /usr/local/bin/bun && \
    ln -sf /usr/local/bin/bun /usr/local/bin/bunx

# Install Helm
ARG HELM_VERSION=v3.16.3
RUN curl -fsSL https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz | tar xz -C /tmp && \
    mv /tmp/linux-amd64/helm /usr/local/bin/helm && \
    rm -rf /tmp/linux-amd64 && \
    helm version --short

# Create python symlink for compatibility
RUN ln -sf /usr/bin/python3 /usr/bin/python

# Create non-root user (matching backend, overridable)
RUN addgroup -g ${GID} -S appgroup && \
    adduser -u ${UID} -S appuser -G appgroup

# Set up workspace
WORKDIR /workspace
# Pre-create cache directories for Go, Playwright, Bun, and Helm
# Cache is at /cache (separate from workspace) to avoid host mount point creation issues
RUN mkdir -p /cache /cache/go-build /cache/go-mod \
    /cache/xdg/helm/repository /cache/xdg/helm/cache /cache/xdg/helm/config \
    /cache/bun /cache/golangci-lint /cache/tmp \
    /home/appuser/.cache/ms-playwright-go /home/appuser/.cache && \
    chown -R appuser:appgroup /cache /home/appuser/.cache

# Copy binaries from artifacts image
COPY --from=artifacts --chown=appuser:appgroup /artifacts/goats /usr/local/bin/goats
COPY --from=artifacts --chown=appuser:appgroup /artifacts/migrate /usr/local/bin/migrate

# Copy additional tools from builder
COPY --from=toolbox-builder /usr/local/bin/gotrs* /usr/local/bin/
COPY --from=toolbox-builder /go/bin/* /usr/local/bin/

# Copy Go toolchain from builder (match go.mod toolchain)
COPY --from=toolbox-builder /usr/local/go /usr/local/go

# Verify go toolchain present; fallback install via apk + curl if copy failed (defensive)
RUN if [ ! -x /usr/local/go/bin/go ]; then \
            echo 'Go toolchain copy missing, installing fallback'; \
            apk add --no-cache curl tar bash ca-certificates jq; \
            curl -fsSL https://go.dev/dl/go1.24.6.linux-amd64.tar.gz -o /tmp/go.tgz; \
            GO_SHA=$(curl -fsSL https://go.dev/dl/?mode=json | jq -r '.[] | select(.version=="go1.24.6") | .files[] | select(.filename=="go1.24.6.linux-amd64.tar.gz") | .sha256') && \
            echo "$GO_SHA  /tmp/go.tgz" | sha256sum -c - && \
            tar -C /usr/local -xzf /tmp/go.tgz; \
            rm /tmp/go.tgz; \
        fi && /usr/local/go/bin/go version || (echo 'Go toolchain unavailable after fallback' && exit 1)

# Ensure Go toolchain binaries are reachable even if PATH filtering occurs
RUN for bin in /usr/local/go/bin/*; do ln -sf "$bin" /usr/local/bin/$(basename "$bin"); done

# Copy workspace files for development
COPY --chown=appuser:appgroup . /workspace/

# Copy entrypoint script and ensure it's executable
COPY --chown=appuser:appgroup scripts/toolbox-entrypoint.sh /usr/local/bin/toolbox-entrypoint.sh
RUN chmod +x /usr/local/bin/toolbox-entrypoint.sh

# Copy frontend node_modules from builder if available (preinstalled in builder stage)
COPY --from=toolbox-builder --chown=appuser:appgroup /workspace/node_modules /workspace/node_modules

# Set environment for Go caching and prevent auto toolchain downloads
# Cache is at /cache (separate from workspace bind mount)
ENV GOCACHE=/cache/go-build \
    GOMODCACHE=/cache/go-mod \
    GOTOOLCHAIN=local \
    BUN_INSTALL_CACHE_DIR=/cache/bun \
    XDG_CACHE_HOME=/cache/xdg \
    GOLANGCI_LINT_CACHE=/cache/golangci-lint \
    PATH=/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Run as non-root user
USER appuser

# Entrypoint validates cache permissions before running commands
ENTRYPOINT ["/usr/local/bin/toolbox-entrypoint.sh"]

# Default to bash shell for interactive use
CMD ["/bin/bash"]
 