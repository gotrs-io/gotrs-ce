# GoatKit - Container for GOTRS Configuration Management
# syntax=docker/dockerfile:1

# Global build arg - must be before any FROM that uses it
# Default provided for docker build without --build-arg; compose/make override from .env
ARG GO_IMAGE=golang:1.24-alpine

# ============================================
# Reuse backend binaries from artifacts image
# ============================================
FROM gotrs-artifacts:latest AS artifacts

# ============================================
# Build GoatKit tools
# ============================================
FROM ${GO_IMAGE} AS goatkit-builder

# Install build dependencies
RUN apk add --no-cache git ca-certificates

WORKDIR /app

# Copy and cache dependencies
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go mod download && go mod verify

# Copy source code
COPY . .

# Build GoatKit CLI with optimization
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/gk ./cmd/gk 2>/dev/null || true

# ============================================
# Minimal runtime
# ============================================
FROM alpine:3.19

RUN apk add --no-cache ca-certificates bash git

# Create non-root user (uid 1000 for podman compatibility)
RUN adduser -D -s /bin/sh -u 1000 goat

# Copy GoatKit binary from builder
COPY --from=goatkit-builder /usr/local/bin/gk /usr/local/bin/

# Copy main goats binary from artifacts for consistency
COPY --from=artifacts /artifacts/goats /usr/local/bin/goats

# Create config directories with proper ownership
RUN mkdir -p /app/config /app/routes /app/dashboards /app/.versions && \
    chown -R goat:goat /app

# Create the GoatKit wrapper with ASCII art
RUN cat <<'EOF' >/usr/local/bin/goatkit
#!/bin/bash

# GoatKit - YAML Configuration Management for GOTRS
set -e

# Show banner on first run or help
if [ $# -eq 0 ] || [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat << 'BANNER'

   ___________  ___  _________ __ __ ______ 
  / ____/ __ \/   |/_  __/ __ \/ //_//  _/ /_
 / / __/ / / / /| | / / / /_/ / ,<   / // __/
/ /_/ / /_/ / ___ |/ / / _, _/ /| |_/ // /_  
\____/\____/_/  |_/_/ /_/ |_/_/ |_/___/\__/  
                                              
    ðŸ YAML-First Configuration Management
    
BANNER
fi

CONFIG_DIR=${CONFIG_DIR:-/app/config}
ROUTES_DIR=${ROUTES_DIR:-/app/routes}
DASHBOARDS_DIR=${DASHBOARDS_DIR:-/app/dashboards}
VERSIONS_DIR=${VERSIONS_DIR:-/app/.versions}

show_help() {
    echo "Commands:"
    echo "  init          Initialize GoatKit configuration"
    echo "  generate      Generate YAML from existing code"
    echo "  validate      Validate all YAML configurations"
    echo "  watch         Watch for changes and auto-reload"
    echo "  version       Manage configuration versions"
    echo "  diff          Show configuration changes"
    echo "  migrate       Migrate from OTRS configuration"
    echo "  server        Start embedded configuration server"
    echo ""
    echo "Examples:"
    echo "  goatkit init                  # Set up new project"
    echo "  goatkit generate routes        # Generate route YAML from code"
    echo "  goatkit validate              # Check all configurations"
    echo "  goatkit watch                 # Auto-reload on changes"
    echo "  goatkit version list          # Show version history"
    echo "  goatkit diff v1.0 v1.1       # Compare versions"
    echo "  goatkit migrate otrs.xml      # Import OTRS config"
    echo "  goatkit server                # Start config UI on :3000"
    echo ""
    echo "Environment Variables:"
    echo "  CONFIG_DIR      Main configuration directory (default: /app/config)"
    echo "  ROUTES_DIR      Routes configuration (default: /app/routes)"
    echo "  DASHBOARDS_DIR  Dashboard definitions (default: /app/dashboards)"
    echo "  VERSIONS_DIR    Version history (default: /app/.versions)"
}

# Main command dispatcher
case "$1" in
    init)
        echo "ðŸŽ¯ Initializing GoatKit configuration..."
        gk init "$CONFIG_DIR"
        ;;
        
    generate)
        TYPE=${2:-all}
        echo "ðŸ”§ Generating YAML configuration for: $TYPE"
        gk generate "$TYPE" --output "$CONFIG_DIR"
        ;;
        
    validate)
        echo "âœ… Validating configurations..."
        gk validate "$CONFIG_DIR" "$ROUTES_DIR" "$DASHBOARDS_DIR"
        ;;
        
    watch)
        echo "ðŸ‘ï¸ Watching for configuration changes..."
        gk watch "$CONFIG_DIR" "$ROUTES_DIR" "$DASHBOARDS_DIR"
        ;;
        
    version)
        shift
        gk version "$@" --dir "$VERSIONS_DIR"
        ;;
        
    diff)
        FROM=${2:-HEAD~1}
        TO=${3:-HEAD}
        echo "ðŸ“Š Showing differences between $FROM and $TO..."
        gk diff "$FROM" "$TO" --dir "$VERSIONS_DIR"
        ;;
        
    migrate)
        SOURCE=${2}
        if [ -z "$SOURCE" ]; then
            echo "âŒ Please provide source file for migration"
            echo "Usage: goatkit migrate <otrs-config.xml>"
            exit 1
        fi
        echo "ðŸ“¦ Migrating configuration from $SOURCE..."
        gk migrate "$SOURCE" --output "$CONFIG_DIR"
        ;;
        
    server)
        PORT=${2:-3000}
        echo "ðŸš€ Starting GoatKit configuration server on port $PORT..."
        echo "   Access the UI at http://localhost:$PORT"
        gk server --port "$PORT" --config "$CONFIG_DIR"
        ;;
        
    help|--help|-h)
        show_help
        ;;
        
    *)
        if [ -n "$1" ]; then
            echo "Unknown command: $1"
            echo ""
        fi
        show_help
        exit 1
        ;;
esac
EOF

RUN chmod +x /usr/local/bin/goatkit

# Set up working directory
WORKDIR /app

# Switch to non-root user
USER goat

# Default command shows help
CMD ["/usr/local/bin/goatkit", "help"]