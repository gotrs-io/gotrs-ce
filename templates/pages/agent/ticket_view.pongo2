{% extends "layouts/base.pongo2" %}

{% block title %}Ticket #{{ ticket.tn }} - {{ ticket.title }} - GOTRS{% endblock %}

{% block styles %}
<style>
/* Synthwave table styles for article content */
.article-content table {
    border-collapse: collapse !important;
    width: 100% !important;
    border: 1px solid var(--gk-border-strong) !important;
}

.article-content table th,
.article-content table td {
    border: 1px solid var(--gk-border-default) !important;
    padding: 0.5rem 0.75rem !important;
    text-align: left !important;
}

.article-content table th {
    background: var(--gk-bg-elevated) !important;
    font-weight: 600 !important;
    color: var(--gk-text-primary) !important;
}

.article-content table tbody tr:nth-child(even) {
    background: var(--gk-bg-surface) !important;
}

.article-content table tbody tr:hover {
    background: var(--gk-primary-subtle) !important;
}
</style>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="/static/js/tiptap.min.js"></script>
<script src="/static/js/tiptap-editor.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 min-h-screen">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <nav class="flex mb-2" aria-label="Breadcrumb">
                    <ol class="flex items-center space-x-2">
                        <li><a href="/agent/dashboard" class="gk-link-neon">Dashboard</a></li>
                        <li style="color: var(--gk-text-muted);">/</li>
                        <li><a href="/tickets" class="gk-link-neon">Tickets</a></li>
                        <li style="color: var(--gk-text-muted);">/</li>
                        <li style="color: var(--gk-text-secondary);">#{{ ticket.tn }}</li>
                    </ol>
                </nav>
                <h1 class="text-3xl font-bold gk-heading ticket-title">
                    <span class="gk-text-gradient">{{ ticket.title }}</span>
                </h1>
                <div class="mt-2 flex items-center space-x-4">
                    <span class="gk-badge
                        {% if ticket.state_type == 'new' %}gk-badge-success
                        {% elif ticket.state_type == 'open' %}gk-badge-primary
                        {% elif ticket.state_type == 'pending' %}gk-badge-warning
                        {% elif ticket.state_type == 'closed' %}gk-badge-muted
                        {% else %}gk-badge-muted{% endif %}">
                        {{ ticket.state }}
                    </span>
                    <span class="text-sm" style="color: var(--gk-text-secondary);">Priority: {{ ticket.priority }}</span>
                    <span class="text-sm" style="color: var(--gk-text-secondary);">Queue: {{ ticket.queue }}</span>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="replyToTicket()" class="gk-btn-neon">
                    Reply
                </button>
                <button onclick="addNote({{ ticket.id }})" class="gk-btn-secondary">
                    Add Note
                </button>
                <!-- Actions Dropdown -->
                <div class="relative">
                    <button onclick="toggleDropdown('actionsDropdown')" class="gk-btn-secondary inline-flex items-center">
                        Actions
                        <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div id="actionsDropdown" class="hidden absolute right-0 mt-2 w-56 rounded-lg shadow-lg z-10" style="background: var(--gk-bg-elevated); border: 1px solid var(--gk-border-strong);">
                        <div class="py-1">
                            <a href="#" onclick="changeStatus(); toggleDropdown('actionsDropdown')" class="block px-4 py-2 text-sm transition-colors" style="color: var(--gk-text-primary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-primary)'">
                                {{ t("tickets.change_status")|default:"Change Status" }}
                            </a>
                            <a href="#" onclick="assignAgent(); toggleDropdown('actionsDropdown')" class="block px-4 py-2 text-sm transition-colors" style="color: var(--gk-text-primary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-primary)'">
                                {{ t("tickets.assign_agent")|default:"Assign Agent" }}
                            </a>
                            <a href="#" onclick="changePriority(); toggleDropdown('actionsDropdown')" class="block px-4 py-2 text-sm transition-colors" style="color: var(--gk-text-primary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-primary)'">
                                {{ t("tickets.change_priority")|default:"Change Priority" }}
                            </a>
                            <a href="#" onclick="moveQueue(); toggleDropdown('actionsDropdown')" class="block px-4 py-2 text-sm transition-colors" style="color: var(--gk-text-primary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-primary)'">
                                {{ t("tickets.move_to_queue")|default:"Move to Queue" }}
                            </a>
                            <a href="#" onclick="mergeTicket(); toggleDropdown('actionsDropdown')" class="block px-4 py-2 text-sm transition-colors" style="color: var(--gk-text-primary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-primary)'">
                                {{ t("tickets.merge_ticket")|default:"Merge Ticket" }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add hidden ticket attributes for JavaScript (used by ticket attribute relations filtering) -->
    <div data-queue-id="{{ ticket.queue_id }}"
         data-queue-name="{{ ticket.queue_name }}"
         data-status-id="{{ ticket.ticket_state_id }}"
         data-status-name="{{ ticket.state_name }}"
         data-priority-id="{{ ticket.ticket_priority_id }}"
         style="display: none;"></div>

    <!-- Tabs: Conversation | History | Links -->
    <div class="mt-6 gk-card-glow">
        <div class="px-6 py-3" style="border-bottom: 1px solid var(--gk-border-default);">
            <nav class="flex space-x-4" aria-label="Ticket tabs">
                <button id="tab-conversation" onclick="showTab('conversation')" class="px-3 py-2 text-sm font-medium rounded transition-colors" style="background: var(--gk-primary-subtle); color: var(--gk-primary);">{{ t("customer.ticket_view.conversation")|default:"Conversation" }}</button>
                <button id="tab-history" hx-get="/agent/tickets/{{ ticket.id }}/history" hx-target="#tab-panel" hx-swap="innerHTML" class="px-3 py-2 text-sm font-medium rounded transition-colors" style="color: var(--gk-text-secondary);">{{ t("tickets.history")|default:"History" }}</button>
                <button id="tab-links" hx-get="/agent/tickets/{{ ticket.id }}/links" hx-target="#tab-panel" hx-swap="innerHTML" class="px-3 py-2 text-sm font-medium rounded transition-colors" style="color: var(--gk-text-secondary);">{{ t("tickets.links")|default:"Links" }}</button>
            </nav>
        </div>
        <div id="tab-panel">
            <!-- Default: Conversation content remains (articles) -->
            <div style="border-color: var(--gk-border-default);">
                {% for article in notes %}
                <div class="p-6" style="border-bottom: 1px solid var(--gk-border-default);{% if article.sender_color %} border-left: 4px solid {{ article.sender_color }};{% endif %}">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: var(--gk-primary); box-shadow: var(--gk-glow-primary);">
                                <span class="text-sm font-medium" style="color: var(--gk-text-inverse);">{{ article.from_name|first|upper }}</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-medium" style="color: var(--gk-text-primary);">{{ article.from_name }}</h3>
                                <p class="text-sm" style="color: var(--gk-text-muted);">{{ article.create_time }}</p>
                            </div>
                            <div class="mt-2 max-w-none article-content gk-article-content">
                                {% if '<p' in article.body or '<div' in article.body or '<table' in article.body or '<br' in article.body or '<ul' in article.body or '<ol' in article.body or '<h1' in article.body or '<h2' in article.body or '<h3' in article.body %}
                                    <div data-article-body class="article-html">{{ article.body|safe }}</div>
                                {% else %}
                                    <div data-article-body class="article-plain">{{ article.body|escape }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-6 text-center" style="color: var(--gk-text-muted);">No articles yet</div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if ticket.pending_reminder %}
    <div class="mb-6">
    <div class="rounded-lg p-4 text-sm" style="{% if ticket.pending_reminder_overdue %}border: 1px solid var(--gk-error); background: var(--gk-error-subtle); color: var(--gk-error);{% else %}border: 1px solid var(--gk-primary); background: var(--gk-primary-subtle); color: var(--gk-primary);{% endif %}">
            <div class="font-medium">
                {% if ticket.pending_reminder_has_time %}
                    {% if ticket.pending_reminder_overdue %}
                        {{ t("tickets.pending_reminder.overdue")|default:"Reminder overdue" }}
                    {% else %}
                        {{ t("tickets.pending_reminder.scheduled")|default:"Reminder scheduled" }}
                    {% endif %}
                {% else %}
                    {{ t("tickets.pending_reminder.not_scheduled")|default:"Reminder not scheduled" }}
                {% endif %}
            </div>
            <p class="mt-1">
                {% if ticket.pending_reminder_has_time %}
                    {% if ticket.pending_reminder_overdue %}
                        {{ t("tickets.pending_reminder.was_scheduled_for")|default:"Reminder was scheduled for" }} <span class="font-semibold">{{ ticket.pending_reminder_at }}</span>{% if ticket.pending_reminder_relative and ticket.pending_reminder_at_iso %} (<span data-relative-time data-mode="duration" data-direction="past" data-timestamp="{{ ticket.pending_reminder_at_iso }}">{{ ticket.pending_reminder_relative }}</span> {{ t("tickets.pending_reminder.ago")|default:"ago" }}){% elif ticket.pending_reminder_relative %} ({{ ticket.pending_reminder_relative }} {{ t("tickets.pending_reminder.ago")|default:"ago" }}){% endif %}.
                    {% else %}
                        {{ t("tickets.pending_reminder.will_reopen_at")|default:"Ticket will re-open at" }} <span class="font-semibold">{{ ticket.pending_reminder_at }}</span>{% if ticket.pending_reminder_relative and ticket.pending_reminder_at_iso %} ({{ t("tickets.pending_reminder.in")|default:"in" }} <span data-relative-time data-mode="duration" data-direction="future" data-timestamp="{{ ticket.pending_reminder_at_iso }}">{{ ticket.pending_reminder_relative }}</span>){% elif ticket.pending_reminder_relative %} ({{ t("tickets.pending_reminder.in")|default:"in" }} {{ ticket.pending_reminder_relative }}){% endif %}.
                    {% endif %}
                {% else %}
                    {{ ticket.pending_reminder_message|default:t("tickets.pending_reminder.no_time_scheduled")|default:"No reminder time scheduled." }}
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}

    {% if ticket.auto_close_at %}
    <div class="mb-6">
        <div class="rounded-lg p-4 text-sm" style="{% if ticket.auto_close_overdue %}border: 1px solid var(--gk-error); background: var(--gk-error-subtle); color: var(--gk-error);{% else %}border: 1px solid var(--gk-warning); background: var(--gk-warning-subtle); color: var(--gk-warning);{% endif %}">
            <div class="font-medium">
                {% if ticket.auto_close_overdue %}
                    {{ t("tickets.auto_close.overdue")|default:"Auto-close overdue" }}
                {% else %}
                    {{ t("tickets.auto_close.scheduled")|default:"Auto-close scheduled" }}
                {% endif %}
            </div>
            <p class="mt-1">
                {% if ticket.auto_close_overdue %}
                    {{ t("tickets.auto_close.should_have_closed_at")|default:"Ticket should have auto-closed at" }} <span class="font-semibold">{{ ticket.auto_close_at }}</span>{% if ticket.auto_close_relative and ticket.auto_close_at_iso %} (<span data-relative-time data-mode="duration" data-direction="past" data-timestamp="{{ ticket.auto_close_at_iso }}">{{ ticket.auto_close_relative }}</span> {{ t("tickets.pending_reminder.ago")|default:"ago" }}){% elif ticket.auto_close_relative %} ({{ ticket.auto_close_relative }} {{ t("tickets.pending_reminder.ago")|default:"ago" }}){% endif %}.
                {% else %}
                    {{ t("tickets.auto_close.will_close_at")|default:"Ticket will auto-close" }}{% if ticket.auto_close_pending %} {{ t("tickets.auto_close.while_pending")|default:"while in pending auto close state" }}{% endif %} {{ t("tickets.auto_close.at")|default:"at" }} <span class="font-semibold">{{ ticket.auto_close_at }}</span>{% if ticket.auto_close_relative and ticket.auto_close_at_iso %} ({{ t("tickets.pending_reminder.in")|default:"in" }} <span data-relative-time data-mode="duration" data-direction="future" data-timestamp="{{ ticket.auto_close_at_iso }}">{{ ticket.auto_close_relative }}</span>){% elif ticket.auto_close_relative %} ({{ t("tickets.pending_reminder.in")|default:"in" }} {{ ticket.auto_close_relative }}){% endif %}.
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Articles -->
            <div class="gk-card-glow"{% if first_article_sender_color %} style="border-left: 4px solid {{ first_article_sender_color }};"{% endif %}>
                <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                    <h2 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("customer.ticket_view.conversation")|default:"Conversation" }}</h2>
                </div>
                <div>
                    {% for article in notes %}
                    <div class="p-6" style="border-bottom: 1px solid var(--gk-border-default);{% if article.sender_color %} border-left: 4px solid {{ article.sender_color }};{% endif %}">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="{% if article.sender_type == 'customer' %}background: var(--gk-primary); box-shadow: var(--gk-glow-primary);{% elif article.sender_type == 'agent' %}background: var(--gk-secondary); box-shadow: var(--gk-glow-secondary);{% else %}background: var(--gk-tertiary); box-shadow: 0 0 15px rgba(255, 138, 61, 0.4);{% endif %}">
                                    <span class="text-sm font-medium" style="color: var(--gk-text-inverse);">
                                        {{ article.from_name|first|upper }}
                                    </span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-sm font-medium" style="color: var(--gk-text-primary);">
                                        {{ article.from_name }}
                                        {% if article.sender_type == 'agent' %}
                                        <span class="ml-2 gk-badge gk-badge-secondary">Agent</span>
                                        {% elif article.sender_type == 'customer' %}
                                        <span class="ml-2 gk-badge gk-badge-primary">Customer</span>
                                        {% else %}
                                        <span class="ml-2 gk-badge gk-badge-tertiary">System</span>
                                        {% endif %}
                                    </h3>
                                    <p class="text-sm" style="color: var(--gk-text-muted);">{{ article.create_time }}</p>
                                </div>
                                <div class="mt-2 text-sm" style="color: var(--gk-text-secondary);">
                                    <p>{{ article.subject }}</p>
                                </div>
                                <div class="mt-2 max-w-none article-content gk-article-content">
                                    {# Treat as HTML only if we see common block/line break tags. Otherwise preserve whitespace. #}
                                    {% if '<p' in article.body or '<div' in article.body or '<table' in article.body or '<br' in article.body or '<ul' in article.body or '<ol' in article.body or '<h1' in article.body or '<h2' in article.body or '<h3' in article.body %}
                                        <div data-article-body class="text-sm" style="color: var(--gk-text-primary);">{{ article.body|safe }}</div>
                                    {% else %}
                                        <div data-article-body class="whitespace-pre-wrap break-words font-mono text-sm" style="color: var(--gk-text-primary);">{{ article.body }}</div>
                                    {% endif %}
                                </div>
                                {% if article.attachments %}
                                <div class="mt-4">
                                    <h4 class="text-xs font-medium uppercase tracking-wide mb-2" style="color: var(--gk-text-muted);">{{ t("tickets.attachments")|default:"Attachments" }}</h4>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                                        {% for attachment in article.attachments %}
                                        <div class="relative group rounded-lg p-2 transition-colors" style="background: var(--gk-bg-surface);" onmouseover="this.style.background='var(--gk-bg-elevated)'" onmouseout="this.style.background='var(--gk-bg-surface)'">
                                            {% if attachment.content_type and attachment.content_type|slice:":5" == "image" %}
                                            <!-- Image preview -->
                                            <div class="aspect-square mb-1 overflow-hidden rounded" style="background: var(--gk-bg-elevated);">
                                                <img data-attachment-url="/agent/tickets/{{ ticket.id }}/articles/{{ article.id }}/attachments/{{ attachment.id }}"
                                                     alt="{{ attachment.filename }}"
                                                     class="w-full h-full object-cover cursor-pointer attachment-image"
                                                     onclick="showImagePreview(this.src, '{{ attachment.filename }}')"
                                                     loading="lazy">
                                            </div>
                                            {% else %}
                                            <!-- File icon -->
                                            <div class="flex justify-center items-center h-16 mb-1">
                                                {% if attachment.content_type == "application/pdf" %}
                                                <svg class="h-12 w-12" style="color: var(--gk-error);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                                </svg>
                                                {% else %}
                                                <svg class="h-12 w-12" style="color: var(--gk-text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                                </svg>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            <div class="text-xs">
                                                <p class="truncate font-medium" style="color: var(--gk-text-primary);" title="{{ attachment.filename }}">
                                                    {{ attachment.filename }}
                                                </p>
                                                <p style="color: var(--gk-text-muted);">{{ attachment.size }}</p>
                                            </div>
                                            <a href="/agent/tickets/{{ ticket.id }}/articles/{{ article.id }}/attachments/{{ attachment.id }}"
                                               download="{{ attachment.filename }}"
                                               class="absolute inset-0 rounded-lg ring-2 ring-transparent hover:ring-[var(--gk-primary)] transition-all"
                                               title="Download {{ attachment.filename }}">
                                                <span class="sr-only">Download</span>
                                            </a>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if article.dynamic_fields %}
                                <!-- Article Dynamic Fields -->
                                <div class="mt-4 pt-4" style="border-top: 1px solid var(--gk-border-default);">
                                    <h4 class="text-xs font-medium uppercase tracking-wide mb-2" style="color: var(--gk-text-muted);">{{ t("dynamic_fields.article_fields")|default:"Article Fields" }}</h4>
                                    <dl class="grid grid-cols-2 gap-2 text-sm">
                                        {% for df in article.dynamic_fields %}
                                        <div>
                                            <dt style="color: var(--gk-text-muted);">{{ df.Label }}</dt>
                                            <dd style="color: var(--gk-text-primary);">{{ df.DisplayValue|default:"-" }}</dd>
                                        </div>
                                        {% endfor %}
                                    </dl>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-6 text-center" style="color: var(--gk-text-muted);">
                        No articles yet
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Ticket Details -->
            <div class="gk-card-glow">
                <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                    <h2 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.details")|default:"Details" }}</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">Ticket Number</label>
                        <p class="mt-1 text-sm font-mono" style="color: var(--gk-primary);">#{{ ticket.tn }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">Customer</label>
                        <p class="mt-1 text-sm" style="color: var(--gk-text-primary);">
                            {{ ticket.customer_name|default:ticket.customer_user_id|default:"-" }}
                            {% if ticket.customer_company %}
                            <br><span class="text-xs" style="color: var(--gk-text-muted);">{{ ticket.customer_company }}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">Assigned To</label>
                        <p class="mt-1 text-sm" style="color: var(--gk-text-primary);">
                            {{ ticket.assigned_to|default:"Unassigned" }}
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">Created</label>
                        <p class="mt-1 text-sm" style="color: var(--gk-text-primary);">{{ ticket.create_time }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">Last Updated</label>
                        <p class="mt-1 text-sm" style="color: var(--gk-text-primary);">{{ ticket.change_time }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">Type</label>
                        <p class="mt-1 text-sm" style="color: var(--gk-text-primary);">{{ ticket.type|default:"Unclassified" }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">Service</label>
                        <p class="mt-1 text-sm" style="color: var(--gk-text-primary);">{{ ticket.service|default:"-" }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" style="color: var(--gk-text-muted);">SLA</label>
                        <p class="mt-1 text-sm" style="color: var(--gk-text-primary);">{{ ticket.sla|default:"-" }}</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="gk-card-glow">
                <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                    <h2 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("dashboard.quick_actions")|default:"Quick Actions" }}</h2>
                </div>
                <div class="p-6 space-y-3">
                    <button onclick="changeStatus()" class="w-full px-4 py-2 text-left text-sm rounded transition-colors" style="color: var(--gk-text-secondary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-secondary)'">
                        {{ t("tickets.change_status")|default:"Change Status" }}
                    </button>
                    <button onclick="assignAgent()" class="w-full px-4 py-2 text-left text-sm rounded transition-colors" style="color: var(--gk-text-secondary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-secondary)'">
                        {{ t("tickets.assign_agent")|default:"Assign Agent" }}
                    </button>
                    <button onclick="changePriority()" class="w-full px-4 py-2 text-left text-sm rounded transition-colors" style="color: var(--gk-text-secondary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-secondary)'">
                        {{ t("tickets.change_priority")|default:"Change Priority" }}
                    </button>
                    <button onclick="moveQueue()" class="w-full px-4 py-2 text-left text-sm rounded transition-colors" style="color: var(--gk-text-secondary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-secondary)'">
                        {{ t("tickets.move_to_queue")|default:"Move to Queue" }}
                    </button>
                    <button onclick="mergeTicket()" class="w-full px-4 py-2 text-left text-sm rounded transition-colors" style="color: var(--gk-text-secondary);" onmouseover="this.style.background='var(--gk-primary-subtle)';this.style.color='var(--gk-primary)'" onmouseout="this.style.background='';this.style.color='var(--gk-text-secondary)'">
                        {{ t("tickets.merge_ticket")|default:"Merge Ticket" }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal - Enhanced with OTRS feature parity -->
<div id="replyModal" class="hidden fixed inset-0 overflow-y-auto z-50" style="background: rgba(0, 0, 0, 0.8);">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto" style="background: var(--gk-bg-surface); border: 1px solid var(--gk-border-strong);">
            <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                <h3 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.compose_reply")|default:"Compose Reply" }}</h3>
            </div>
            <form id="replyForm" onsubmit="submitReply(event)">
                <div class="p-6 space-y-4">
                    <!-- Communication Type and Visibility -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="gk-form-label">Type</label>
                            <select name="communication_channel_id" id="replyCommunicationType" onchange="updateReplyVisibility()"
                                    class="gk-select-neon mt-1">
                                <option value="1" selected>Email-External</option>
                                <option value="3">Email-Internal</option>
                                <option value="2">Phone</option>
                                <option value="4">Chat</option>
                            </select>
                        </div>
                        <div>
                            <label class="gk-form-label">Next State</label>
                            <select name="next_state_id" class="gk-select-neon mt-1">
                                <option value="">Keep current state</option>
                                <option value="2">open</option>
                                <option value="4">pending reminder</option>
                                <option value="7">closed successful</option>
                                <option value="8">closed unsuccessful</option>
                            </select>
                        </div>
                    </div>

                    <!-- Recipients -->
                    <div>
                        <label class="gk-form-label">To</label>
                        <select id="customerUserSelect" name="to" required class="gk-select-neon mt-1">
                            <option value="{{ ticket.customer_user_id }}">{{ ticket.customer_user_id }}</option>
                        </select>
                        <div class="mt-1 text-xs" style="color: var(--gk-text-muted);">
                            {{ t("messages.loading_customer_users")|default:"Loading customer users..." }}
                        </div>
                    </div>

                    <!-- Expandable Cc/Bcc -->
                    <div>
                        <button type="button" onclick="toggleCcBcc()" class="text-sm gk-link-neon">
                            + Add Cc/Bcc
                        </button>
                        <div id="ccBccFields" class="hidden mt-2 space-y-2">
                            <div>
                                <label class="gk-form-label">Cc</label>
                                <input type="email" name="cc" multiple placeholder="{{ t("placeholders.separate_emails")|default:"Separate multiple emails with commas" }}"
                                       class="gk-input-neon mt-1">
                            </div>
                            <div>
                                <label class="gk-form-label">Bcc</label>
                                <input type="email" name="bcc" multiple placeholder="{{ t("placeholders.separate_emails")|default:"Separate multiple emails with commas" }}"
                                       class="gk-input-neon mt-1">
                            </div>
                        </div>
                    </div>

                    <!-- Subject -->
                    <div>
                        <label class="gk-form-label">Subject</label>
                        <input type="text" name="subject" value="Re: {{ ticket.title }}" required
                               class="gk-input-neon mt-1">
                    </div>

                    <!-- Template Selection -->
                    <!-- Template Selection -->
                    {% include "partials/template_selector.pongo2" with QueueID=ticket.queue_id TicketID=ticket.id TemplateType="Answer" TargetEditorID="replyEditorInner" SelectID="replyTemplateSelect" %}

                    <!-- Message with Quote Option -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label id="replyEditorLabel" class="gk-form-label">Message</label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" name="quote_original" class="mr-2 rounded" style="border-color: var(--gk-border-strong);">
                                <span style="color: var(--gk-text-secondary);">Quote original message</span>
                            </label>
                        </div>
                        <div id="replyEditor" class="mt-1">
                            {% include "partials/rich_text_editor.pongo2" with EditorID="replyEditorInner" FieldName="body" Placeholder="Write your reply here..." MinHeight="120px" LabelID="replyEditorLabel" %}
                        </div>
                    </div>

                    <!-- Attachments -->
                    <div>
                        <label class="gk-form-label">Attachments</label>
                        <input type="file" name="attachments" multiple
                               class="mt-1 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold" style="color: var(--gk-text-secondary); --tw-file-bg: var(--gk-primary-subtle); --tw-file-text: var(--gk-primary);">
                        <div id="reply-template-attachments" class="mt-2"></div>
                    </div>

                    <!-- Time Accounting -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="gk-form-label">Time Units (minutes)</label>
                            <input type="number" name="time_units" min="0" step="1" value="5" placeholder="5"
                                   class="gk-input-neon mt-1">
                        </div>
                        <div>
                            <label class="flex items-center text-sm mt-7">
                                <input type="checkbox" name="is_visible_for_customer" id="replyVisibility" value="1" checked
                                       class="mr-2 rounded" style="border-color: var(--gk-border-strong);">
                                <span style="color: var(--gk-text-secondary);">Visible to Customer</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 flex justify-between" style="border-top: 1px solid var(--gk-border-default);">
                    <button type="button" onclick="saveDraft()" class="gk-btn-secondary">
                        Save as Draft
                    </button>
                    <div class="space-x-3">
                        <button type="button" onclick="closeModal('replyModal')" class="gk-btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="gk-btn-neon">
                            Send Reply
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div id="noteModal" class="hidden fixed inset-0 overflow-y-auto z-50" style="background: rgba(0, 0, 0, 0.8);">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative rounded-lg shadow-xl w-full max-w-2xl" style="background: var(--gk-bg-surface); border: 1px solid var(--gk-border-strong);">
            <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                <h3 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.add_internal_note")|default:"Add Internal Note" }}</h3>
            </div>
            <form id="noteForm" onsubmit="submitNote(event)">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="gk-form-label">Note Type</label>
                        <select id="noteTypeSelect" name="communication_channel_id" required onchange="updateNoteSubject()"
                                class="gk-select-neon mt-1">
                            <option value="1">Email</option>
                            <option value="2">Phone</option>
                            <option value="3" selected>Internal</option>
                            <option value="4">Chat</option>
                        </select>
                    </div>
                    <div>
                        <label class="gk-form-label">Subject</label>
                        <input type="text" id="noteSubject" name="subject" placeholder="{{ t("placeholders.note_subject")|default:"Note subject" }}" value="Internal Note" required
                               class="gk-input-neon mt-1">
                    </div>
                    <!-- Note Template Selection -->
                    {% include "partials/template_selector.pongo2" with QueueID=ticket.queue_id TicketID=ticket.id TemplateType="Note" TargetEditorID="noteEditorInner" SelectID="noteTemplateSelect" %}
                    <div>
                        <label id="noteEditorInnerLabel" class="gk-form-label">Note</label>
                        <div id="noteEditor" class="mt-1">
                            {% include "partials/rich_text_editor.pongo2" with EditorID="noteEditorInner" FieldName="body" Placeholder="Write your note here..." MinHeight="120px" LabelID="noteEditorInnerLabel" %}
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_visible_for_customer" id="noteVisibility" value="1"
                               class="mr-2 rounded" style="border-color: var(--gk-border-strong);" checked>
                        <label for="noteVisibility" class="text-sm" style="color: var(--gk-text-secondary);">
                            Visible to Customer
                        </label>
                    </div>
                    <!-- Attachments -->
                    <div>
                        <label class="gk-form-label">Attachments</label>
                        <input type="file" name="attachments" multiple
                               class="mt-1 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold" style="color: var(--gk-text-secondary);">
                        <div id="note-template-attachments" class="mt-2"></div>
                    </div>
                </div>
                <div class="px-6 py-4 flex justify-end space-x-3" style="border-top: 1px solid var(--gk-border-default);">
                    <button type="button" onclick="closeModal('noteModal')" class="gk-btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="gk-btn-neon">
                        Add Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ENHANCED Status Modal with Pending Time Support -->
<div id="statusModal" class="hidden fixed inset-0 overflow-y-auto z-50" style="background: rgba(0, 0, 0, 0.8);">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative rounded-lg shadow-xl w-full max-w-md" style="background: var(--gk-bg-surface); border: 1px solid var(--gk-border-strong);">
            <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                <h3 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.change_status")|default:"Change Status" }}</h3>
            </div>
            <form id="statusForm" onsubmit="submitStatus(event)" data-pending-states="{% if PendingStateIDs %}{% for sid in PendingStateIDs %}{{ sid }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}">
                <div class="p-6 space-y-4">
                    <!-- Status Selection -->
                    <div>
                        <label class="gk-form-label mb-2">New Status</label>
                        <select name="status_id" id="statusSelect" required onchange="togglePendingFields()"
                                class="gk-select-neon">
                            <option value="">Select status...</option>
                            <option value="1">new</option>
                            <option value="2">open</option>
                            <option value="4">pending reminder</option>
                            <option value="5">pending auto close+</option>
                            <option value="6">pending auto close-</option>
                            <option value="7">closed successful</option>
                            <option value="8">closed unsuccessful</option>
                        </select>
                    </div>

                    <!-- Pending Time Fields (Hidden by default) -->
                    <div id="pending-time-fields" style="display: none; background: var(--gk-warning-subtle); border: 1px solid var(--gk-warning);" class="p-4 rounded-lg">
                        <div class="mb-3">
                            <label class="gk-form-label mb-2">
                                Pending Until
                                <span style="color: var(--gk-error);">*</span>
                            </label>
                            <input type="datetime-local" name="pending_until" id="pendingUntilInput"
                                   class="gk-input-neon">
                        </div>
                        <div id="pending-help-text" class="text-sm" style="color: var(--gk-text-secondary);">
                            <div id="pending-reminder-help" style="display: none;">
                                <strong>{{ t("tickets.pending_reminder.title")|default:"Pending Reminder" }}:</strong> {{ t("tickets.pending_reminder.help")|default:"Ticket will return to \"open\" state at specified time." }}
                            </div>
                            <div id="pending-auto-close-plus-help" style="display: none;">
                                <strong>{{ t("tickets.auto_close.plus_title")|default:"Pending Auto Close+" }}:</strong> {{ t("tickets.auto_close.plus_help")|default:"Ticket will close automatically if no customer response by specified time." }}
                            </div>
                            <div id="pending-auto-close-minus-help" style="display: none;">
                                <strong>{{ t("tickets.auto_close.minus_title")|default:"Pending Auto Close-" }}:</strong> {{ t("tickets.auto_close.minus_help")|default:"Ticket will close automatically at specified time regardless of activity." }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 flex justify-end space-x-3" style="border-top: 1px solid var(--gk-border-default);">
                    <button type="button" onclick="closeModal('statusModal')" class="gk-btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="gk-btn-neon">
                        {{ t("tickets.change_status")|default:"Change Status" }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Modal -->
<div id="assignModal" class="hidden fixed inset-0 overflow-y-auto z-50" style="background: rgba(0, 0, 0, 0.8);">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative rounded-lg shadow-xl w-full max-w-md" style="background: var(--gk-bg-surface); border: 1px solid var(--gk-border-strong);">
            <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                <h3 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.assign_agent")|default:"Assign Agent" }}</h3>
            </div>
            <form id="assignForm" onsubmit="submitAssign(event)">
                <div class="p-6">
                    <label class="gk-form-label mb-2">Assign To</label>
                    <select name="user_id" required class="gk-select-neon">
                        <option value="">Select agent...</option>
                    </select>
                </div>
                <div class="px-6 py-4 flex justify-end space-x-3" style="border-top: 1px solid var(--gk-border-default);">
                    <button type="button" onclick="closeModal('assignModal')" class="gk-btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="gk-btn-neon">
                        Assign
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Priority Modal -->
<div id="priorityModal" class="hidden fixed inset-0 overflow-y-auto z-50" style="background: rgba(0, 0, 0, 0.8);">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative rounded-lg shadow-xl w-full max-w-md" style="background: var(--gk-bg-surface); border: 1px solid var(--gk-border-strong);">
            <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                <h3 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.change_priority")|default:"Change Priority" }}</h3>
            </div>
            <form id="priorityForm" onsubmit="submitPriority(event)">
                <div class="p-6">
                    <label class="gk-form-label mb-2">New Priority</label>
                    <select name="priority_id" required class="gk-select-neon">
                        <option value="">Select priority...</option>
                        <option value="1" {% if ticket.priority_id == 1 %}selected{% endif %}>1 very low</option>
                        <option value="2" {% if ticket.priority_id == 2 %}selected{% endif %}>2 low</option>
                        <option value="3" {% if ticket.priority_id == 3 %}selected{% endif %}>3 normal</option>
                        <option value="4" {% if ticket.priority_id == 4 %}selected{% endif %}>4 high</option>
                        <option value="5" {% if ticket.priority_id == 5 %}selected{% endif %}>5 very high</option>
                    </select>
                </div>
                <div class="px-6 py-4 flex justify-end space-x-3" style="border-top: 1px solid var(--gk-border-default);">
                    <button type="button" onclick="closeModal('priorityModal')" class="gk-btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="gk-btn-neon">
                        Update Priority
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Queue Modal -->
<div id="queueModal" class="hidden fixed inset-0 overflow-y-auto z-50" style="background: rgba(0, 0, 0, 0.8);">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative rounded-lg shadow-xl w-full max-w-md" style="background: var(--gk-bg-surface); border: 1px solid var(--gk-border-strong);">
            <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                <h3 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.move_to_queue")|default:"Move to Queue" }}</h3>
            </div>
            <form id="queueForm" onsubmit="submitQueue(event)">
                <div class="p-6">
                    <label class="gk-form-label mb-2">Select Queue</label>
                    <select name="queue_id" required class="gk-select-neon">
                        <option value="">Select queue...</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="px-6 py-4 flex justify-end space-x-3" style="border-top: 1px solid var(--gk-border-default);">
                    <button type="button" onclick="closeModal('queueModal')" class="gk-btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="gk-btn-neon">
                        Move Ticket
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Merge Modal -->
<div id="mergeModal" class="hidden fixed inset-0 overflow-y-auto z-50" style="background: rgba(0, 0, 0, 0.8);">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative rounded-lg shadow-xl w-full max-w-md" style="background: var(--gk-bg-surface); border: 1px solid var(--gk-border-strong);">
            <div class="px-6 py-4" style="border-bottom: 1px solid var(--gk-border-default);">
                <h3 class="text-lg font-semibold" style="color: var(--gk-text-primary);">{{ t("tickets.merge_ticket")|default:"Merge Ticket" }}</h3>
            </div>
            <form id="mergeForm" onsubmit="submitMerge(event)">
                <div class="p-6">
                    <label class="gk-form-label mb-2">
                        Merge into Ticket Number
                    </label>
                    <input type="text" name="target_tn" placeholder="e.g., 2025010000001" required
                           class="gk-input-neon">
                    <p class="mt-2 text-sm" style="color: var(--gk-text-muted);">
                        This ticket will be closed and merged into the target ticket.
                    </p>
                </div>
                <div class="px-6 py-4 flex justify-end space-x-3" style="border-top: 1px solid var(--gk-border-default);">
                    <button type="button" onclick="closeModal('mergeModal')" class="gk-btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="gk-btn-neon" style="background: var(--gk-error); box-shadow: 0 0 15px rgba(255, 60, 110, 0.4);">
                        Merge Tickets
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/static/js/ticket-zoom.js"></script>
<script>
const ticketId = {{ ticket.id }};

// Initialize ticket zoom functionality
initTicketZoom(ticketId);

// Editors are initialized by partial includes

/**
 * Toggle pending time fields based on status selection - ENHANCED VERSION
 */
function togglePendingFields() {
    const statusSelect = document.getElementById('statusSelect');
    const pendingFields = document.getElementById('pending-time-fields');
    const pendingInput = document.getElementById('pendingUntilInput');
    const helpTexts = document.querySelectorAll('[id$="-help"]');
    const statusForm = document.getElementById('statusForm');
    if (!statusSelect || !pendingFields || !pendingInput) {
        return;
    }
    const rawStates = (statusForm && statusForm.dataset && statusForm.dataset.pendingStates) || '';
    const pendingStates = rawStates.split(',').map(v => v.trim()).filter(Boolean);
    const pendingSet = pendingStates.length > 0 ? new Set(pendingStates) : new Set(['4', '5', '6']);

    // Hide all help texts first
    helpTexts.forEach(help => help.style.display = 'none');

    // Pending states: 4=pending reminder, 5=pending auto close+, 6=pending auto close-
    if (pendingSet.has(statusSelect.value)) {
        pendingFields.style.display = 'block';
        pendingInput.required = true;

        // Set minimum datetime to current time
        const now = new Date();
        // Format as YYYY-MM-DDTHH:MM for datetime-local input
        const minDateTime = now.getFullYear() + '-' +
                          String(now.getMonth() + 1).padStart(2, '0') + '-' +
                          String(now.getDate()).padStart(2, '0') + 'T' +
                          String(now.getHours()).padStart(2, '0') + ':' +
                          String(now.getMinutes()).padStart(2, '0');
        pendingInput.min = minDateTime;

        // Show appropriate help text
        switch(statusSelect.value) {
            case '4':
                document.getElementById('pending-reminder-help').style.display = 'block';
                break;
            case '5':
                document.getElementById('pending-auto-close-plus-help').style.display = 'block';
                break;
            case '6':
                document.getElementById('pending-auto-close-minus-help').style.display = 'block';
                break;
        }

        // Set default time to 1 hour from now
        const defaultTime = new Date(now.getTime() + 60 * 60 * 1000);
        const defaultDateTime = defaultTime.getFullYear() + '-' +
                              String(defaultTime.getMonth() + 1).padStart(2, '0') + '-' +
                              String(defaultTime.getDate()).padStart(2, '0') + 'T' +
                              String(defaultTime.getHours()).padStart(2, '0') + ':' +
                              String(defaultTime.getMinutes()).padStart(2, '0');
        if (!pendingInput.value) {
            pendingInput.value = defaultDateTime;
        }

    } else {
        pendingFields.style.display = 'none';
        pendingInput.required = false;
        pendingInput.value = '';
    }
}

// NOTE: Most functions now come from ticket-zoom.js, avoiding duplication
// Only keeping essential template-specific functions here

// Initialize pending fields on page load
document.addEventListener('DOMContentLoaded', function() {
    togglePendingFields();
    // Load attachment images with authentication
    if (typeof loadAttachmentImages === 'function') {
        loadAttachmentImages();
    }

    // Function to style tables based on current theme
    function styleArticleTables() {
        document.querySelectorAll('.article-content table').forEach(table => {
            // Check if in dark mode
            const isDark = document.documentElement.classList.contains('dark');
            const borderColor = isDark ? '#4b5563' : '#d1d5db';
            const headerBg = isDark ? '#374151' : '#f3f4f6';  // Lighter gray in light mode, more contrast in dark
            const evenRowBg = isDark ? 'rgba(31, 41, 55, 0.3)' : '#fafafa';  // Very light gray in light mode

            // Style the table
            table.style.borderCollapse = 'collapse';
            table.style.width = '100%';
            table.style.border = `1px solid ${borderColor}`;

            // Style all cells
            table.querySelectorAll('th, td').forEach(cell => {
                cell.style.border = `1px solid ${borderColor}`;
                cell.style.padding = '0.5rem 0.75rem';
                cell.style.textAlign = 'left';
            });

            // Style header cells
            table.querySelectorAll('th').forEach(th => {
                th.style.backgroundColor = headerBg;
                th.style.fontWeight = '600';
            });

            // Store row index for hover handling
            table.querySelectorAll('tbody tr').forEach((row, index) => {
                row.dataset.rowIndex = index;

                if (index % 2 === 1) {
                    row.style.backgroundColor = evenRowBg;
                } else {
                    row.style.backgroundColor = 'transparent';
                }

                // Remove old listeners by cloning the node
                const newRow = row.cloneNode(true);
                row.parentNode.replaceChild(newRow, row);

                // Add hover effect with fresh listeners
                newRow.addEventListener('mouseenter', function() {
                    const currentDark = document.documentElement.classList.contains('dark');
                    this.style.backgroundColor = currentDark ? 'rgba(75, 85, 99, 0.4)' : '#e5e7eb';
                });

                newRow.addEventListener('mouseleave', function() {
                    const currentDark = document.documentElement.classList.contains('dark');
                    const currentEvenBg = currentDark ? 'rgba(31, 41, 55, 0.3)' : '#fafafa';
                    const idx = parseInt(this.dataset.rowIndex);

                    if (idx % 2 === 1) {
                        this.style.backgroundColor = currentEvenBg;
                    } else {
                        this.style.backgroundColor = 'transparent';
                    }
                });
            });
        });
    }

    // Apply table styles initially
    styleArticleTables();

    // Watch for theme changes and reapply styles
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                // Theme changed, restyle tables
                styleArticleTables();
            }
        });
    });

    // Observe changes to the document element's class (where dark mode class is toggled)
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        const dropdowns = document.querySelectorAll('[id$="Dropdown"]');
        const dropdownButtons = document.querySelectorAll('button[onclick*="toggleDropdown"]');

        let clickedInsideDropdown = false;
        dropdownButtons.forEach(button => {
            if (button.contains(event.target)) {
                clickedInsideDropdown = true;
            }
        });

        dropdowns.forEach(dropdown => {
            if (!dropdown.contains(event.target) && !clickedInsideDropdown) {
                dropdown.classList.add('hidden');
            }
        });
    });
});

// Form submission functions
function submitReply(event) {
    event.preventDefault();

    // Get form data
    const formData = new FormData(event.target);

    // Ensure we have the editor content
    if (replyEditorInstance) {
        const content = TiptapEditor.getContent('replyEditor');
        formData.set('body', content);
    }

    // Add the 'to' field (customer email)
    formData.set('to', '{{ ticket.customer_user_id }}');

    // Submit the form
    apiFetch(`/agent/tickets/${ticketId}/reply`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            closeModal('replyModal');
            showToast('Reply sent successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to send reply', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error sending reply', 'error');
    });
}

function submitNote(event) {
    event.preventDefault();

    // Get form data
    const formData = new FormData(event.target);

    // Ensure we have the editor content
    if (noteEditorInstance) {
        const content = TiptapEditor.getContent('noteEditor');
        formData.set('body', content);
    }

    // Submit the form
    apiFetch(`/agent/tickets/${ticketId}/note`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            closeModal('noteModal');
            showToast('Note added successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to add note', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error adding note', 'error');
    });
}

function submitPhone(event) {
    event.preventDefault();

    // Get form data
    const formData = new FormData(event.target);

    // Submit the form
    apiFetch(`/agent/tickets/${ticketId}/phone`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            closeModal('phoneModal');
            showToast('Phone note added successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to add phone note', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error adding phone note', 'error');
    });
}

function submitAssign(event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    apiFetch(`/agent/tickets/${ticketId}/assign`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            closeModal('assignModal');
            showToast('Ticket assigned successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to assign ticket', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error assigning ticket', 'error');
    });
}

function submitPriority(event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    apiFetch(`/agent/tickets/${ticketId}/priority`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            closeModal('priorityModal');
            showToast('Priority updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Failed to update priority', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating priority', 'error');
    });
}

// Modal control functions
function openModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    const isHidden = dropdown.classList.contains('hidden');

    // Hide all dropdowns first
    document.querySelectorAll('[id$="Dropdown"]').forEach(d => {
        d.classList.add('hidden');
    });

    // Show the clicked dropdown if it was hidden
    if (isHidden) {
        dropdown.classList.remove('hidden');
    }
}

function updateNoteSubject() {
    const noteTypeSelect = document.getElementById('noteTypeSelect');
    const noteSubject = document.getElementById('noteSubject');

    // Only update if the subject hasn't been manually edited by the user
    const currentSubject = noteSubject.value;
    const defaultSubjects = ['Email Note', 'Phone Note', 'Internal Note', 'Chat Note', ''];

    // If the current subject is one of the defaults or empty, update it
    if (defaultSubjects.includes(currentSubject) || currentSubject === '') {
        const selectedType = noteTypeSelect.value;
        let newSubject = '';

        switch(selectedType) {
            case '1':
                newSubject = 'Email Note';
                break;
            case '2':
                newSubject = 'Phone Note';
                break;
            case '3':
                newSubject = 'Internal Note';
                break;
            case '4':
                newSubject = 'Chat Note';
                break;
            default:
                newSubject = 'Note';
        }

        noteSubject.value = newSubject;
    }
}

// Toggle Cc/Bcc fields visibility
function toggleCcBcc() {
    const ccBccFields = document.getElementById('ccBccFields');
    if (ccBccFields.classList.contains('hidden')) {
        ccBccFields.classList.remove('hidden');
    } else {
        ccBccFields.classList.add('hidden');
    }
}

// Update reply visibility based on communication type
function updateReplyVisibility() {
    const typeSelect = document.getElementById('replyCommunicationType');
    const visibilityCheckbox = document.getElementById('replyVisibility');

    // If internal email, uncheck visibility
    if (typeSelect.value === '3') { // Email-Internal
        visibilityCheckbox.checked = false;
    } else {
        visibilityCheckbox.checked = true;
    }
}

// Load template content
function loadTemplate(templateId) {
    if (!templateId) return;

    // This would normally fetch from API
    const templates = {
        '1': 'Thank you for contacting us. We have received your request and will respond shortly.\n\nBest regards,\nSupport Team',
        '2': 'Thank you for your inquiry. To assist you better, could you please provide the following information:\n\n1. \n2. \n3. \n\nBest regards,\nSupport Team',
        '3': 'Your issue has been resolved. If you have any further questions, please don\'t hesitate to contact us.\n\nBest regards,\nSupport Team'
    };

    if (templates[templateId] && replyEditorInstance) {
        // Set the template content in the editor
        TiptapEditor.setContent('replyEditor', templates[templateId]);
    }
}

// Save as draft
function saveDraft() {
    const formData = new FormData(document.getElementById('replyForm'));
    formData.append('is_draft', '1');

    if (replyEditorInstance) {
        const content = TiptapEditor.getContent('replyEditor');
        formData.set('body', content);
    }

    // Save draft via API
    apiFetch(`/agent/tickets/${ticketId}/draft`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showToast('Draft saved successfully', 'success');
        } else {
            showToast('Failed to save draft', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving draft:', error);
        showToast('Error saving draft', 'error');
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    // Use existing toast container from base layout
    const event = new CustomEvent('show-toast', {
        detail: { message, type }
    });
    document.dispatchEvent(event);
}

// Show image preview in modal
function showImagePreview(src, filename) {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
    modal.onclick = function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    };

    // Create image container
    const container = document.createElement('div');
    container.className = 'relative max-w-full max-h-full';

    // Create image
    const img = document.createElement('img');
    img.src = src;
    img.alt = filename;
    img.className = 'max-w-full max-h-[90vh] object-contain';

    // Create close button
    const closeBtn = document.createElement('button');
    closeBtn.className = 'absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75';
    closeBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
    closeBtn.onclick = function() {
        modal.remove();
    };

    // Create filename label
    const label = document.createElement('div');
    label.className = 'absolute bottom-2 left-2 right-2 text-white bg-black bg-opacity-50 rounded px-3 py-1 text-sm truncate';
    label.textContent = filename;

    // Assemble modal
    container.appendChild(img);
    container.appendChild(closeBtn);
    container.appendChild(label);
    modal.appendChild(container);
    document.body.appendChild(modal);

    // Close on escape key
    const escHandler = function(e) {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}
</script>
{% endblock %}
