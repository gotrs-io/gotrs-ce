<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}GOTRS - Ticketing System{{end}}</title>
    
    <!-- Tailwind CSS -->
    <link href="/static/css/tailwind.css" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- HTMX Extensions -->
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Custom styles -->
    <style>
        /* HTMX loading states */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }
        /* HTMX targeting */
        .htmx-settling {
            opacity: 0.5;
        }
        .htmx-added {
            opacity: 0;
            animation: fadeIn 0.2s ease-out forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
    
    {{block "head" .}}{{end}}
</head>
<body class="h-full" hx-ext="sse">
    <div class="min-h-full">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b border-gray-200" x-data="{ mobileMenuOpen: false }">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 justify-between">
                    <div class="flex">
                        <div class="flex flex-shrink-0 items-center">
                            <a href="/" class="text-xl font-bold text-indigo-600">GOTRS</a>
                        </div>
                        {{if .User}}
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="/dashboard" 
                               class="inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium {{if eq .ActivePage "dashboard"}}border-indigo-500 text-gray-900{{else}}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{{end}}">
                                Dashboard
                            </a>
                            <a href="/tickets" 
                               class="inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium {{if eq .ActivePage "tickets"}}border-indigo-500 text-gray-900{{else}}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{{end}}">
                                Tickets
                            </a>
                            {{if or (eq .User.Role "Admin") (eq .User.Role "Agent")}}
                            <a href="/queues" 
                               class="inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium {{if eq .ActivePage "queues"}}border-indigo-500 text-gray-900{{else}}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{{end}}">
                                Queues
                            </a>
                            {{end}}
                            {{if eq .User.Role "Admin"}}
                            <a href="/admin" 
                               class="inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium {{if eq .ActivePage "admin"}}border-indigo-500 text-gray-900{{else}}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{{end}}">
                                Admin
                            </a>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                    
                    {{if .User}}
                    <div class="hidden sm:ml-6 sm:flex sm:items-center">
                        <!-- Notifications -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="relative rounded-full bg-white p-1 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                <span class="sr-only">View notifications</span>
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                                </svg>
                                <span id="notification-count" class="absolute -top-1 -right-1 hidden h-4 w-4 rounded-full bg-red-500 text-xs text-white flex items-center justify-center">0</span>
                            </button>
                            
                            <!-- Notification dropdown -->
                            <div x-show="open" @click.away="open = false" x-transition
                                 class="absolute right-0 z-10 mt-2 w-80 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5"
                                 hx-get="/api/notifications"
                                 hx-trigger="intersect once"
                                 hx-target="this">
                                <div class="px-4 py-2 text-sm text-gray-500">Loading notifications...</div>
                            </div>
                        </div>
                        
                        <!-- Profile dropdown -->
                        <div class="relative ml-3" x-data="{ open: false }">
                            <button @click="open = !open" class="flex rounded-full bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                <span class="sr-only">Open user menu</span>
                                <div class="h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-semibold">
                                    {{.User.FirstName | firstLetter}}{{.User.LastName | firstLetter}}
                                </div>
                            </button>
                            
                            <div x-show="open" @click.away="open = false" x-transition
                                 class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5">
                                <div class="px-4 py-2 text-sm text-gray-700 border-b">
                                    <div class="font-medium">{{.User.FirstName}} {{.User.LastName}}</div>
                                    <div class="text-gray-500">{{.User.Email}}</div>
                                </div>
                                <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Your Profile</a>
                                <a href="/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                                <hr class="my-1">
                                <button hx-post="/logout" 
                                        hx-redirect="/"
                                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    Sign out
                                </button>
                            </div>
                        </div>
                    </div>
                    {{else}}
                    <div class="hidden sm:ml-6 sm:flex sm:items-center">
                        <a href="/login" class="text-gray-500 hover:text-gray-700 px-3 py-2 text-sm font-medium">Sign in</a>
                        <a href="/register" class="ml-3 inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                            Register
                        </a>
                    </div>
                    {{end}}
                    
                    <!-- Mobile menu button -->
                    <div class="flex items-center sm:hidden">
                        <button @click="mobileMenuOpen = !mobileMenuOpen" class="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500">
                            <span class="sr-only">Open main menu</span>
                            <svg x-show="!mobileMenuOpen" class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg>
                            <svg x-show="mobileMenuOpen" class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile menu -->
            <div x-show="mobileMenuOpen" class="sm:hidden">
                <div class="space-y-1 pb-3 pt-2">
                    {{if .User}}
                    <a href="/dashboard" class="block border-l-4 py-2 pl-3 pr-4 text-base font-medium {{if eq .ActivePage "dashboard"}}border-indigo-500 bg-indigo-50 text-indigo-700{{else}}border-transparent text-gray-500 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-700{{end}}">Dashboard</a>
                    <a href="/tickets" class="block border-l-4 py-2 pl-3 pr-4 text-base font-medium {{if eq .ActivePage "tickets"}}border-indigo-500 bg-indigo-50 text-indigo-700{{else}}border-transparent text-gray-500 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-700{{end}}">Tickets</a>
                    {{end}}
                </div>
            </div>
        </nav>
        
        <!-- Page Content -->
        <main>
            {{block "content" .}}{{end}}
        </main>
        
        <!-- Toast notifications container -->
        <div id="toast-container" class="fixed bottom-0 right-0 p-6 space-y-4 z-50">
            <!-- Toasts will be inserted here via HTMX -->
        </div>
    </div>
    
    <!-- SSE connection for real-time updates -->
    {{if .User}}
    <div hx-ext="sse" sse-connect="/api/events/stream" class="hidden">
        <div sse-swap="notification" hx-swap="afterbegin" hx-target="#toast-container"></div>
        <div sse-swap="ticket-update" hx-swap="none" hx-trigger="ticket-update" 
             hx-on:htmx:sse-message="handleTicketUpdate(event)"></div>
    </div>
    {{end}}
    
    <!-- Global JavaScript -->
    <script>
        // Initialize Alpine.js stores
        document.addEventListener('alpine:init', () => {
            Alpine.store('notifications', {
                count: 0,
                items: []
            });
        });
        
        // Handle SSE ticket updates
        function handleTicketUpdate(event) {
            const data = JSON.parse(event.detail.data);
            // Trigger updates for ticket lists/details if they're on the page
            if (document.querySelector(`[data-ticket-id="${data.ticketId}"]`)) {
                htmx.trigger(`[data-ticket-id="${data.ticketId}"]`, 'ticket-refresh');
            }
        }
        
        // HTMX configuration
        document.body.addEventListener('htmx:configRequest', (event) => {
            // Add CSRF token if available
            const token = document.querySelector('meta[name="csrf-token"]')?.content;
            if (token) {
                event.detail.headers['X-CSRF-Token'] = token;
            }
        });
        
        // Handle HTMX errors globally
        document.body.addEventListener('htmx:responseError', (event) => {
            console.error('HTMX request failed:', event.detail);
            // Show error toast
            const errorHtml = `
                <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg shadow-lg" 
                     x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 5000)">
                    <p class="font-medium">Error: Request failed</p>
                    <p class="text-sm mt-1">${event.detail.xhr.statusText || 'Unknown error'}</p>
                </div>
            `;
            document.getElementById('toast-container').insertAdjacentHTML('afterbegin', errorHtml);
        });
    </script>
    
    {{block "scripts" .}}{{end}}
</body>
</html>