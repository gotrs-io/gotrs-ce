# Container for GOTRS route management tools
# syntax=docker/dockerfile:1

# Global build arg - must be before any FROM that uses it
# Default provided for docker build without --build-arg; compose/make override from .env
ARG GO_IMAGE=golang:1.24-alpine

# ============================================
# Stage 1: Build route tools
# ============================================
FROM ${GO_IMAGE} AS route-builder

# Install build dependencies
RUN apk add --no-cache git ca-certificates

WORKDIR /app

# Copy and cache dependencies
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go mod download && go mod verify

# Copy source code
COPY . .

# Build all route tools with optimization
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/route-test ./cmd/route-test 2>/dev/null || true && \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/route-docs ./cmd/route-docs 2>/dev/null || true && \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/route-version ./cmd/route-version 2>/dev/null || true && \
    CGO_ENABLED=0 go build -ldflags="-w -s" -o /usr/local/bin/route-lint ./cmd/route-lint 2>/dev/null || true

# ============================================
# Stage 2: Minimal runtime
# ============================================
FROM alpine:3.19

RUN apk add --no-cache ca-certificates curl jq bash git

# Create non-root user
RUN adduser -D -s /bin/sh -u 1000 routemanager

# Copy built tools
COPY --from=route-builder /usr/local/bin/route-* /usr/local/bin/

# Create route tools wrapper script
RUN cat > /usr/local/bin/route-manager << 'EOF'
#!/bin/bash

# GOTRS Route Management Suite
set -e

ROUTES_DIR=${ROUTES_DIR:-/app/routes}
GOTRS_HOST=${GOTRS_HOST:-http://gotrs-backend:8080}

show_help() {
    echo "ðŸš€ GOTRS Route Management Suite"
    echo "================================"
    echo ""
    echo "Commands:"
    echo "  test       Run route tests against live system"
    echo "  docs       Generate API documentation"
    echo "  lint       Check routes for issues and best practices"
    echo "  version    Manage route versions"
    echo "  profile    Analyze route performance"
    echo "  validate   Validate all route files"
    echo "  report     Generate comprehensive route report"
    echo ""
    echo "Usage:"
    echo "  route-manager test [--verbose]"
    echo "  route-manager docs [output-dir]"
    echo "  route-manager lint [routes-dir]"
    echo "  route-manager version <list|commit|rollback>"
    echo "  route-manager profile"
    echo "  route-manager validate"
    echo "  route-manager report"
    echo ""
    echo "Environment Variables:"
    echo "  ROUTES_DIR    Directory containing route files (default: /app/routes)"
    echo "  GOTRS_HOST    GOTRS backend URL (default: http://gotrs-backend:8080)"
}

case "$1" in
    test)
        shift
        echo "ðŸ§ª Running Route Tests"
        echo "====================="
        route-test "$ROUTES_DIR" "$GOTRS_HOST" "$@"
        ;;
        
    docs)
        OUTPUT_DIR=${2:-/app/docs}
        echo "ðŸ“š Generating Documentation"
        echo "=========================="
        route-docs "$ROUTES_DIR" "$OUTPUT_DIR"
        echo ""
        echo "Documentation generated in $OUTPUT_DIR"
        ;;
        
    lint)
        DIR=${2:-$ROUTES_DIR}
        echo "ðŸ” Linting Route Files"
        echo "====================="
        route-lint "$DIR"
        ;;
        
    version)
        shift
        route-version "$@"
        ;;
        
    profile)
        echo "ðŸ“Š Route Performance Profile"
        echo "==========================="
        
        # Get performance data from analytics endpoint
        curl -s "$GOTRS_HOST/metrics/stats" | jq '.route_stats' | \
        jq -r 'to_entries | sort_by(-.value.avg_duration) | 
               .[] | "\(.key): \(.value.avg_duration)ms (count: \(.value.count))"' | 
        head -20
        
        echo ""
        echo "Top 20 slowest routes shown (by average duration)"
        ;;
        
    validate)
        echo "âœ… Validating All Routes"
        echo "======================="
        
        # Run linter in validation mode
        route-lint "$ROUTES_DIR"
        
        # Test that routes can be loaded
        echo ""
        echo "Testing route loading..."
        route-version validate
        ;;
        
    report)
        echo "ðŸ“‹ Comprehensive Route Report"
        echo "============================"
        echo ""
        
        # Count routes
        TOTAL_ROUTES=$(find "$ROUTES_DIR" -name "*.yaml" -o -name "*.yml" | wc -l)
        echo "ðŸ“ Total route files: $TOTAL_ROUTES"
        echo ""
        
        # Run linter summary
        echo "ðŸ” Linting Summary:"
        route-lint "$ROUTES_DIR" | tail -5
        echo ""
        
        # Show version info
        echo "ðŸ“š Version Information:"
        route-version list | head -10
        echo ""
        
        # Test summary
        echo "ðŸ§ª Test Summary:"
        route-test "$ROUTES_DIR" "$GOTRS_HOST" | tail -10
        echo ""
        
        # Performance summary if available
        if curl -s "$GOTRS_HOST/health" > /dev/null 2>&1; then
            echo "ðŸ“Š Performance Summary:"
            curl -s "$GOTRS_HOST/metrics/stats" | jq '.summary'
        fi
        
        echo ""
        echo "Report complete!"
        ;;
        
    help|--help|-h|"")
        show_help
        ;;
        
    *)
        echo "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
EOF

RUN chmod +x /usr/local/bin/route-manager

# Set up working directory
WORKDIR /app

# Switch to non-root user
USER routemanager

# Default command
CMD ["/usr/local/bin/route-manager", "help"]